# 支付沙箱测试指南

## 📋 测试前准备

### 1. 申请沙箱账号

#### 支付宝沙箱环境
1. 访问支付宝开放平台: https://open.alipay.com/
2. 登录后进入"开发者中心" → "研发服务" → "沙箱环境"
3. 获取沙箱配置信息:
   - **APPID**: 沙箱应用的APPID
   - **支付宝网关**: https://openapi.alipaydev.com/gateway.do
   - **应用私钥**: 需要使用支付宝提供的密钥生成工具生成
   - **支付宝公钥**: 在沙箱应用中配置应用公钥后,系统会生成支付宝公钥
4. 下载"沙箱钱包"APP用于扫码测试
5. 使用沙箱买家账号登录沙箱钱包

**支付宝沙箱买家账号示例**:
- 账号: 随机生成的测试账号
- 登录密码: 111111
- 支付密码: 111111
- 余额: 充足的测试金额

#### 微信支付沙箱环境
1. 访问微信支付商户平台: https://pay.weixin.qq.com/
2. 登录后进入"产品中心" → "开发配置" → "沙箱环境"
3. 获取沙箱配置信息:
   - **沙箱商户号**: 测试用的商户号
   - **沙箱密钥**: 测试用的API密钥
   - **沙箱APPID**: 测试用的APPID
4. 使用微信扫一扫功能测试支付

**注意**: 微信支付沙箱环境需要真实的微信账号,但不会真实扣款

### 2. 在系统中配置支付方式

#### 步骤1: 访问支付配置管理页面
```
http://localhost:5174/finance/payment-configs
```

#### 步骤2: 创建支付宝沙箱配置

点击"新建支付配置",填写以下信息:

- **配置名称**: 支付宝沙箱
- **配置类型**: 支付宝
- **环境**: 沙箱
- **状态**: 启用
- **支付宝APPID**: (从支付宝沙箱获取)
- **支付宝网关**: https://openapi.alipaydev.com/gateway.do
- **应用私钥**: (使用密钥生成工具生成的私钥)
- **支付宝公钥**: (从支付宝沙箱获取)
- **备注**: 支付宝沙箱测试环境

#### 步骤3: 创建微信支付沙箱配置

点击"新建支付配置",填写以下信息:

- **配置名称**: 微信支付沙箱
- **配置类型**: 微信支付
- **环境**: 沙箱
- **状态**: 启用
- **微信APPID**: (从微信支付沙箱获取)
- **商户号**: (从微信支付沙箱获取)
- **商户私钥**: (商户API证书私钥)
- **证书序列号**: (商户API证书序列号)
- **API v3密钥**: (从微信支付沙箱获取)
- **备注**: 微信支付沙箱测试环境

## 🧪 测试流程

### 1. 创建测试合同

1. 访问合同管理页面: `http://localhost:5174/contract/list`
2. 创建一个新合同
3. 填写合同基本信息
4. 保存合同

### 2. 生成签署链接

1. 在合同列表中找到刚创建的合同
2. 点击"生成签署链接"按钮
3. 复制生成的签署链接

### 3. 测试合同签署和支付

1. **打开签署链接**
   - 在浏览器中打开复制的签署链接
   - 例如: `http://localhost:5174/contract-sign/{token}`

2. **查看合同**
   - 阅读合同内容
   - 点击"下一步"

3. **签署合同**
   - 填写签署人信息(姓名、手机、邮箱)
   - 在签名板上签名
   - 点击"提交签署"

4. **选择支付方式**
   - 系统会自动显示可用的支付方式
   - 如果配置了支付宝沙箱,会显示"支付宝"选项
   - 如果配置了微信支付沙箱,会显示"微信支付"选项
   - 始终会显示"银行转账"选项

5. **测试支付宝支付**
   - 选择"支付宝"
   - 点击"立即支付"
   - 系统会生成支付二维码
   - 使用支付宝沙箱钱包APP扫码
   - 使用沙箱买家账号登录
   - 输入支付密码(111111)
   - 完成支付

6. **测试微信支付**
   - 选择"微信支付"
   - 点击"立即支付"
   - 系统会生成支付二维码
   - 使用微信扫一扫功能扫码
   - 确认支付
   - 完成支付

7. **测试银行转账**
   - 选择"银行转账"
   - 点击"确认使用银行转账"
   - 系统会显示银行账户信息
   - 提示业务员会联系您

## ✅ 验证支付结果

### 1. 检查支付订单

访问支付订单管理页面(如果有):
```
http://localhost:5174/payment/orders
```

查看支付订单状态是否更新为"已支付"

### 2. 检查合同状态

返回合同管理页面:
```
http://localhost:5174/contract/list
```

查看合同的支付状态是否更新为"已支付"

### 3. 查看后端日志

```bash
tail -f /tmp/backend_8000.log
```

查看支付相关的日志信息

## 🔍 常见问题

### 1. 支付方式不显示

**问题**: 合同签署页面没有显示微信支付或支付宝选项

**解决方案**:
- 检查支付配置是否创建成功
- 检查支付配置状态是否为"启用"
- 检查浏览器控制台是否有错误信息
- 刷新页面重新加载支付方式

### 2. 支付二维码生成失败

**问题**: 点击"立即支付"后没有生成二维码

**解决方案**:
- 检查支付配置信息是否正确
- 检查APPID、商户号、密钥等是否填写正确
- 查看后端日志中的错误信息
- 确认沙箱环境的网关地址是否正确

### 3. 扫码后无法支付

**问题**: 扫码后提示错误或无法完成支付

**解决方案**:
- **支付宝**: 确认使用的是沙箱钱包APP,不是正式的支付宝APP
- **支付宝**: 确认登录的是沙箱买家账号
- **微信**: 确认商户号和密钥配置正确
- 检查沙箱账号余额是否充足

### 4. 支付成功但状态未更新

**问题**: 支付成功但合同状态仍然是"待支付"

**解决方案**:
- 检查支付回调接口是否正常
- 查看后端日志中的回调信息
- 手动刷新页面查看状态
- 检查数据库中的支付订单状态

## 📝 注意事项

1. **沙箱环境仅用于测试**: 不会产生真实的资金流动
2. **配置信息保密**: 即使是沙箱配置,也要妥善保管密钥信息
3. **测试完成后**: 可以停用沙箱配置,启用生产环境配置
4. **生产环境部署**: 必须使用真实的生产环境配置,不能使用沙箱配置

## 🚀 下一步

测试成功后,可以:
1. 申请正式的支付宝和微信支付商户账号
2. 创建生产环境的支付配置
3. 停用沙箱配置,启用生产配置
4. 在生产环境中进行真实交易测试
