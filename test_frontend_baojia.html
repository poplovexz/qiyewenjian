<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¥ä»·æ•°æ®åŠ è½½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .lead-item {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            background: #fafafa;
        }
        .lead-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .button-group {
            margin-top: 10px;
        }
        .btn {
            padding: 5px 10px;
            margin-right: 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-primary { background: #409eff; color: white; }
        .btn-success { background: #67c23a; color: white; }
        .btn-warning { background: #e6a23c; color: white; }
        .btn-disabled { background: #ccc; color: #666; cursor: not-allowed; }
        .status-tag {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status-new { background: #e4e7ed; color: #606266; }
        .status-quoted { background: #f56c6c; color: white; }
        .status-accepted { background: #67c23a; color: white; }
        .log-section {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-item {
            margin: 5px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æŠ¥ä»·æ•°æ®åŠ è½½æµ‹è¯•</h1>
        <div id="status">æ­£åœ¨åŠ è½½...</div>
        <div id="leads-container"></div>
        <div class="log-section">
            <h3>è°ƒè¯•æ—¥å¿—</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let authToken = '';
        
        // æ—¥å¿—è®°å½•
        function log(message) {
            const logsDiv = document.getElementById('logs');
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logItem);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        // ç™»å½•
        async function login() {
            try {
                log('ğŸ” å¼€å§‹ç™»å½•...');
                const response = await fetch(`${API_BASE}/api/v1/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        yonghu_ming: 'admin',
                        mima: 'admin123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token?.access_token || data.token;
                    log('âœ… ç™»å½•æˆåŠŸ');
                    return true;
                } else {
                    log(`âŒ ç™»å½•å¤±è´¥: ${response.status}`);
                    return false;
                }
            } catch (error) {
                log(`âŒ ç™»å½•é”™è¯¯: ${error.message}`);
                return false;
            }
        }

        // è·å–çº¿ç´¢åˆ—è¡¨
        async function getLeads() {
            try {
                log('ğŸ“‹ è·å–çº¿ç´¢åˆ—è¡¨...');
                const response = await fetch(`${API_BASE}/api/v1/leads/`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const leads = data.items || [];
                    log(`âœ… è·å–åˆ° ${leads.length} ä¸ªçº¿ç´¢`);
                    return leads;
                } else {
                    log(`âŒ è·å–çº¿ç´¢å¤±è´¥: ${response.status}`);
                    return [];
                }
            } catch (error) {
                log(`âŒ è·å–çº¿ç´¢é”™è¯¯: ${error.message}`);
                return [];
            }
        }

        // è·å–æŠ¥ä»·åˆ—è¡¨
        async function getBaojiaList(leadId) {
            try {
                log(`ğŸ’° è·å–çº¿ç´¢ ${leadId} çš„æŠ¥ä»·åˆ—è¡¨...`);
                const response = await fetch(`${API_BASE}/api/v1/lead-quotes/xiansuo/${leadId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const baojiaList = await response.json();
                    log(`âœ… çº¿ç´¢ ${leadId} è·å–åˆ° ${baojiaList.length} ä¸ªæŠ¥ä»·`);
                    return baojiaList;
                } else {
                    log(`âŒ è·å–æŠ¥ä»·å¤±è´¥: ${response.status}`);
                    return [];
                }
            } catch (error) {
                log(`âŒ è·å–æŠ¥ä»·é”™è¯¯: ${error.message}`);
                return [];
            }
        }

        // æ£€æŸ¥æŒ‰é’®æ˜¾ç¤ºé€»è¾‘
        function checkButtonLogic(lead, baojiaList) {
            const leadStatus = lead.dangqian_zhuangtai || lead.xiansuo_zhuangtai;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆæŠ¥ä»·
            const hasValidBaojia = baojiaList.some(
                b => !b.is_expired && b.baojia_zhuangtai !== 'rejected'
            ) || ['quoted', 'won'].includes(leadStatus);

            // è·å–æœ€æ–°æœ‰æ•ˆæŠ¥ä»·çŠ¶æ€
            const validBaojia = baojiaList
                .filter(b => !b.is_expired && b.baojia_zhuangtai !== 'rejected')
                .sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
            
            const latestBaojiaStatus = validBaojia.length > 0 ? validBaojia[0].baojia_zhuangtai : null;
            
            // åˆ¤æ–­æ˜¯å¦å¯ä»¥ç”ŸæˆåˆåŒ
            const canGenerateContract = hasValidBaojia && latestBaojiaStatus === 'accepted';

            log(`ğŸ” çº¿ç´¢ ${lead.gongsi_mingcheng} æŒ‰é’®é€»è¾‘:`);
            log(`   - çº¿ç´¢çŠ¶æ€: ${leadStatus}`);
            log(`   - æŠ¥ä»·æ•°é‡: ${baojiaList.length}`);
            log(`   - æœ‰æœ‰æ•ˆæŠ¥ä»·: ${hasValidBaojia}`);
            log(`   - æœ€æ–°æŠ¥ä»·çŠ¶æ€: ${latestBaojiaStatus || 'æ— '}`);
            log(`   - å¯ç”ŸæˆåˆåŒ: ${canGenerateContract}`);

            return {
                hasValidBaojia,
                latestBaojiaStatus,
                canGenerateContract,
                leadStatus
            };
        }

        // æ¸²æŸ“çº¿ç´¢åˆ—è¡¨
        function renderLeads(leads, baojiaData) {
            const container = document.getElementById('leads-container');
            container.innerHTML = '';

            leads.forEach(lead => {
                const baojiaList = baojiaData[lead.id] || [];
                const buttonLogic = checkButtonLogic(lead, baojiaList);

                const leadDiv = document.createElement('div');
                leadDiv.className = 'lead-item';
                
                leadDiv.innerHTML = `
                    <div class="lead-header">
                        ${lead.gongsi_mingcheng}
                        <span class="status-tag status-${buttonLogic.leadStatus}">${buttonLogic.leadStatus}</span>
                        ${buttonLogic.latestBaojiaStatus ? `<span class="status-tag status-${buttonLogic.latestBaojiaStatus}">${buttonLogic.latestBaojiaStatus}</span>` : ''}
                    </div>
                    <div>ID: ${lead.id}</div>
                    <div>æŠ¥ä»·æ•°é‡: ${baojiaList.length}</div>
                    <div class="button-group">
                        ${!buttonLogic.hasValidBaojia ? 
                            '<button class="btn btn-primary">æŠ¥ä»·</button>' : 
                            '<button class="btn btn-disabled" disabled>æŠ¥ä»·</button>'
                        }
                        ${buttonLogic.hasValidBaojia ? 
                            '<button class="btn btn-warning">æŸ¥çœ‹æŠ¥ä»·</button>' : 
                            '<button class="btn btn-disabled" disabled>æŸ¥çœ‹æŠ¥ä»·</button>'
                        }
                        ${buttonLogic.canGenerateContract ? 
                            '<button class="btn btn-success">ç”ŸæˆåˆåŒ</button>' : 
                            '<button class="btn btn-disabled" disabled>ç”ŸæˆåˆåŒ</button>'
                        }
                    </div>
                `;
                
                container.appendChild(leadDiv);
            });
        }

        // ä¸»å‡½æ•°
        async function main() {
            document.getElementById('status').textContent = 'æ­£åœ¨åˆå§‹åŒ–...';
            
            // ç™»å½•
            if (!await login()) {
                document.getElementById('status').textContent = 'ç™»å½•å¤±è´¥';
                return;
            }

            // è·å–çº¿ç´¢åˆ—è¡¨
            const leads = await getLeads();
            if (leads.length === 0) {
                document.getElementById('status').textContent = 'æ²¡æœ‰çº¿ç´¢æ•°æ®';
                return;
            }

            // è·å–æ¯ä¸ªçº¿ç´¢çš„æŠ¥ä»·æ•°æ®
            const baojiaData = {};
            for (const lead of leads) {
                baojiaData[lead.id] = await getBaojiaList(lead.id);
            }

            // æ¸²æŸ“é¡µé¢
            renderLeads(leads, baojiaData);
            document.getElementById('status').textContent = `åŠ è½½å®Œæˆï¼Œå…± ${leads.length} ä¸ªçº¿ç´¢`;
            
            log('ğŸ‰ æµ‹è¯•å®Œæˆï¼');
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>