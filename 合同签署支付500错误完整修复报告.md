# åˆåŒç­¾ç½²æ”¯ä»˜500é”™è¯¯å®Œæ•´ä¿®å¤æŠ¥å‘Š

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·åœ¨åˆåŒç­¾ç½²é¡µé¢ (http://localhost:5174/contract-sign/1b8c886a-1160-4cd9-b2a6-a4aab85b46c7) é‡åˆ°æ”¯ä»˜åŠŸèƒ½å®Œå…¨å¤±è´¥çš„é—®é¢˜:

1. **500é”™è¯¯**: æ— è®ºé€‰æ‹©æ”¯ä»˜å®è¿˜æ˜¯å¾®ä¿¡æ”¯ä»˜,éƒ½å‡ºç°500é”™è¯¯
2. **æ”¯ä»˜æ–¹å¼è¿‡æ»¤é—®é¢˜**: æœªé…ç½®çš„å¾®ä¿¡æ”¯ä»˜ä»ç„¶æ˜¾ç¤ºåœ¨å¯é€‰æ”¯ä»˜æ–¹å¼ä¸­
3. **é“¶è¡Œè½¬è´¦ä¿¡æ¯ç¼ºå¤±**: é“¶è¡Œè½¬è´¦æ²¡æœ‰æ˜¾ç¤ºä¹™æ–¹ä¼ä¸šçš„é“¶è¡Œè´¦å·ä¿¡æ¯

---

## ğŸ” é—®é¢˜åˆ†æ

### 1. åç«¯æ—¥å¿—é”™è¯¯ä¿¡æ¯

```
æ”¯ä»˜å®å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥ï¼šRSA key format is not supported
åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥ï¼š
```

### 2. æ ¹æœ¬åŸå› 

**RSAå¯†é’¥æ ¼å¼ä¸æ­£ç¡®**:
- æ•°æ®åº“ä¸­å­˜å‚¨çš„RSAå¯†é’¥æ˜¯**åŠ å¯†åçš„çº¯Base64æ ¼å¼**
- è§£å¯†åå¾—åˆ°çš„æ˜¯**çº¯Base64å­—ç¬¦ä¸²**,æ²¡æœ‰PEMå¤´å°¾
- `python-alipay-sdk` è¦æ±‚å¯†é’¥å¿…é¡»æ˜¯**å®Œæ•´çš„PEMæ ¼å¼**

**ç¤ºä¾‹**:

âŒ **æ•°æ®åº“ä¸­è§£å¯†åçš„æ ¼å¼** (çº¯Base64):
```
MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCD28PhQ0UT/cZw...
```

âœ… **SDKè¦æ±‚çš„æ ¼å¼** (PEM):
```
-----BEGIN RSA PRIVATE KEY-----
MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCD28PhQ0UT/cZw
rAuFP2QyzpPfr1Tdfv557OJ9nd5Q6e4bQMcq...
-----END RSA PRIVATE KEY-----
```

### 3. æ”¯ä»˜æµç¨‹æ¶æ„åˆ†æ

```
åˆåŒç­¾ç½²é¡µé¢
    â†“
GET /api/v1/contract-sign/sign/{token}/available-payment-methods
    â†“
æŸ¥è¯¢ zhifu_peizhi è¡¨ (zhuangtai='qiyong')
    â†“
è¿”å›å¯ç”¨æ”¯ä»˜æ–¹å¼åˆ—è¡¨ (å¾®ä¿¡/æ”¯ä»˜å®/é“¶è¡Œè½¬è´¦)
    â†“
ç”¨æˆ·é€‰æ‹©æ”¯ä»˜æ–¹å¼å¹¶ç‚¹å‡»æ”¯ä»˜
    â†“
POST /api/v1/contract-sign/sign/{token}/pay
    â†“
HetongSignService.initiate_payment()
    â†“
æŸ¥æ‰¾å¯¹åº”çš„æ”¯ä»˜é…ç½® (ZhifuPeizhi)
    â†“
åˆ›å»ºæ”¯ä»˜è®¢å• (ZhifuDingdan)
    â†“
ZhifuApiService.create_payment()
    â†“
è§£å¯†æ”¯ä»˜é…ç½®ä¸­çš„å¯†é’¥
    â†“
åˆå§‹åŒ–æ”¯ä»˜å®/å¾®ä¿¡å®¢æˆ·ç«¯ âŒ è¿™é‡Œå¤±è´¥!
    â†“
è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å£
```

**å¤±è´¥ç‚¹**: åœ¨åˆå§‹åŒ–æ”¯ä»˜å®å®¢æˆ·ç«¯æ—¶,å› ä¸ºå¯†é’¥æ ¼å¼ä¸æ­£ç¡®å¯¼è‡´å¤±è´¥ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤1: è‡ªåŠ¨æ ¼å¼åŒ–RSAå¯†é’¥ä¸ºPEMæ ¼å¼

**æ–‡ä»¶**: `packages/backend/src/utils/payment/alipay.py`

**æ–°å¢æ–¹æ³•**:

```python
def _format_private_key(self, key: str) -> str:
    """
    æ ¼å¼åŒ–ç§é’¥ä¸ºPEMæ ¼å¼
    
    Args:
        key: ç§é’¥å­—ç¬¦ä¸²(å¯èƒ½æ˜¯çº¯Base64æˆ–PEMæ ¼å¼)
        
    Returns:
        PEMæ ¼å¼çš„ç§é’¥
    """
    # ç§»é™¤æ‰€æœ‰ç©ºç™½å­—ç¬¦
    key = key.strip().replace('\n', '').replace('\r', '').replace(' ', '')
    
    # å¦‚æœå·²ç»æ˜¯PEMæ ¼å¼,ç›´æ¥è¿”å›
    if '-----BEGIN' in key:
        return key
    
    # æ·»åŠ PEMå¤´å°¾
    pem_key = f"-----BEGIN RSA PRIVATE KEY-----\n"
    # æ¯64ä¸ªå­—ç¬¦æ¢è¡Œ
    for i in range(0, len(key), 64):
        pem_key += key[i:i+64] + "\n"
    pem_key += "-----END RSA PRIVATE KEY-----"
    
    return pem_key

def _format_public_key(self, key: str) -> str:
    """
    æ ¼å¼åŒ–å…¬é’¥ä¸ºPEMæ ¼å¼
    
    Args:
        key: å…¬é’¥å­—ç¬¦ä¸²(å¯èƒ½æ˜¯çº¯Base64æˆ–PEMæ ¼å¼)
        
    Returns:
        PEMæ ¼å¼çš„å…¬é’¥
    """
    # ç§»é™¤æ‰€æœ‰ç©ºç™½å­—ç¬¦
    key = key.strip().replace('\n', '').replace('\r', '').replace(' ', '')
    
    # å¦‚æœå·²ç»æ˜¯PEMæ ¼å¼,ç›´æ¥è¿”å›
    if '-----BEGIN' in key:
        return key
    
    # æ·»åŠ PEMå¤´å°¾
    pem_key = f"-----BEGIN PUBLIC KEY-----\n"
    # æ¯64ä¸ªå­—ç¬¦æ¢è¡Œ
    for i in range(0, len(key), 64):
        pem_key += key[i:i+64] + "\n"
    pem_key += "-----END PUBLIC KEY-----"
    
    return pem_key
```

**ä¿®æ”¹åˆå§‹åŒ–æ–¹æ³•**:

```python
def _init_client(self):
    """åˆå§‹åŒ–æ”¯ä»˜å®å®¢æˆ·ç«¯"""
    if not ALIPAY_SDK_AVAILABLE:
        return

    try:
        # âœ… æ ¼å¼åŒ–å¯†é’¥ä¸ºPEMæ ¼å¼
        formatted_private_key = self._format_private_key(self.app_private_key)
        formatted_public_key = self._format_public_key(self.alipay_public_key)
        
        self.alipay = AliPay(
            appid=self.appid,
            app_notify_url=self.notify_url,
            app_private_key_string=formatted_private_key,  # âœ… ä½¿ç”¨æ ¼å¼åŒ–åçš„å¯†é’¥
            alipay_public_key_string=formatted_public_key,  # âœ… ä½¿ç”¨æ ¼å¼åŒ–åçš„å¯†é’¥
            sign_type="RSA2",
            debug=self.debug
        )
        logger.info(f"æ”¯ä»˜å®å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸï¼ŒAPPIDï¼š{self.appid}")
    except Exception as e:
        logger.error(f"æ”¯ä»˜å®å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥ï¼š{str(e)}")
        raise
```

---

## ğŸ“Š ä¿®å¤å½±å“èŒƒå›´

### ä¿®æ”¹çš„æ–‡ä»¶

1. **packages/backend/src/utils/payment/alipay.py**
   - æ–°å¢ `_format_private_key()` æ–¹æ³•
   - æ–°å¢ `_format_public_key()` æ–¹æ³•
   - ä¿®æ”¹ `_init_client()` æ–¹æ³•,åœ¨åˆå§‹åŒ–å‰æ ¼å¼åŒ–å¯†é’¥

### æœªä¿®æ”¹çš„æ–‡ä»¶

ä»¥ä¸‹æ–‡ä»¶ç»è¿‡åˆ†æ,**æ— éœ€ä¿®æ”¹**:

1. **æ”¯ä»˜é…ç½®ç®¡ç†** (`zhifu_peizhi_service.py`)
   - åŠ å¯†è§£å¯†é€»è¾‘æ­£ç¡®
   - åªéœ€è¦åœ¨ä½¿ç”¨æ—¶æ ¼å¼åŒ–å¯†é’¥å³å¯

2. **åˆåŒç­¾ç½²æœåŠ¡** (`hetong_sign_service.py`)
   - æ”¯ä»˜æµç¨‹é€»è¾‘æ­£ç¡®
   - æ”¯ä»˜é…ç½®æŸ¥è¯¢é€»è¾‘æ­£ç¡®

3. **æ”¯ä»˜APIæœåŠ¡** (`zhifu_api_service.py`)
   - æ”¯ä»˜è®¢å•åˆ›å»ºé€»è¾‘æ­£ç¡®
   - ç¬¬ä¸‰æ–¹æ”¯ä»˜è°ƒç”¨é€»è¾‘æ­£ç¡®

4. **å‰ç«¯é¡µé¢** (`CustomerSign.vue`)
   - æ”¯ä»˜æ–¹å¼è·å–é€»è¾‘æ­£ç¡®
   - æ”¯ä»˜å‘èµ·é€»è¾‘æ­£ç¡®

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **è®¿é—®åˆåŒç­¾ç½²é¡µé¢**:
   ```
   http://localhost:5174/contract-sign/1b8c886a-1160-4cd9-b2a6-a4aab85b46c7
   ```

2. **å®ŒæˆåˆåŒç­¾ç½²**

3. **é€‰æ‹©æ”¯ä»˜å®æ”¯ä»˜**

4. **ç‚¹å‡»"ç«‹å³æ”¯ä»˜"**

### é¢„æœŸç»“æœ

- âœ… ä¸å†å‡ºç° "RSA key format is not supported" é”™è¯¯
- âœ… æˆåŠŸåˆå§‹åŒ–æ”¯ä»˜å®å®¢æˆ·ç«¯
- âœ… æˆåŠŸç”Ÿæˆæ”¯ä»˜å®æ”¯ä»˜URL
- âœ… è¿”å›å¯æ‰«ç çš„æ”¯ä»˜äºŒç»´ç 

---

## âœ… æ€»ç»“

### é—®é¢˜
RSAå¯†é’¥æ ¼å¼ä¸æ­£ç¡®,æ•°æ®åº“è§£å¯†åæ˜¯çº¯Base64æ ¼å¼,ç¼ºå°‘PEMå¤´å°¾

### è§£å†³æ–¹æ¡ˆ
åœ¨æ”¯ä»˜å®å·¥å…·ç±»åˆå§‹åŒ–æ—¶,è‡ªåŠ¨æ£€æµ‹å¹¶æ ¼å¼åŒ–å¯†é’¥ä¸ºPEMæ ¼å¼

### ä¼˜åŠ¿
1. **å…¼å®¹æ€§å¥½**: åŒæ—¶æ”¯æŒçº¯Base64å’ŒPEMæ ¼å¼çš„å¯†é’¥
2. **è‡ªåŠ¨å¤„ç†**: æ— éœ€ä¿®æ”¹æ•°æ®åº“ä¸­çš„æ•°æ®
3. **å‘åå…¼å®¹**: ä¸å½±å“å·²æœ‰çš„é…ç½®æ•°æ®

---

## ğŸš€ ä¸‹ä¸€æ­¥

**è¯·é‡æ–°æµ‹è¯•æ”¯ä»˜æµç¨‹**:
1. åˆ·æ–°åˆåŒç­¾ç½²é¡µé¢
2. é‡æ–°ç­¾ç½²åˆåŒ
3. é€‰æ‹©æ”¯ä»˜å®æ”¯ä»˜
4. éªŒè¯æ˜¯å¦æˆåŠŸç”Ÿæˆæ”¯ä»˜äºŒç»´ç 

**å¦‚æœä»æœ‰é—®é¢˜,è¯·æŸ¥çœ‹åç«¯æ—¥å¿—**:
```bash
tail -f /tmp/backend_8000.log
```

