# 银行汇款审核流程配置指南

## 📋 目录

1. [系统架构说明](#系统架构说明)
2. [完整业务流程](#完整业务流程)
3. [配置步骤](#配置步骤)
4. [测试流程](#测试流程)
5. [常见问题](#常见问题)

---

## 系统架构说明

### 银行汇款审核系统组成

系统由**两个互补的部分**组成：

#### 1. 银行汇款管理系统（业务操作层）
- **页面**：`/payment/bank-transfer-manage`
- **功能**：
  - 业务员上传汇款凭证
  - 查看汇款单据列表
  - 查看单据详情
- **自动触发**：上传凭证时自动调用审核工作流引擎

#### 2. 审核工作流系统（审核配置层）
- **页面**：`/audit/workflow-config`（审核流程配置）
- **功能**：
  - 定义审核步骤
  - 指定审核人
  - 配置审核流程
- **作用**：为银行汇款审核提供可配置的审核流程

### 工作原理

```
客户确认使用银行转账
    ↓
客户线下汇款，将凭证发给业务员
    ↓
业务员上传凭证并填写汇款信息（银行汇款管理页面）
    ↓
自动触发审核（调用审核工作流引擎）
    ↓
查找匹配的工作流模板（audit_type="yinhang_huikuan"）
    ↓
创建审核流程实例
    ↓
财务在"我的审核"中审核
    ↓
审核通过/拒绝
```

---

## 完整业务流程

### 阶段1：客户确认使用银行转账

**操作人**：客户

**页面**：合同签署页面（`/contract-sign/{sign_token}`）

**操作步骤**：
1. 客户签署合同
2. 选择支付方式：银行转账
3. 查看公司银行账户信息（收款单位、开户银行、银行账号、应付金额）
4. 点击"确认使用银行转账"按钮

**系统行为**：
- 创建银行汇款单据记录
- 单据状态：`waiting_voucher`（待上传凭证）
- 汇款信息字段设置为"待确认"（等待业务员填写）
- 生成单据编号
- 通知业务员跟进

**客户线下操作**：
- 客户通过银行转账汇款到公司账户
- 客户将汇款凭证（截图或照片）发送给业务员（微信、邮件等）

> 💡 **重要**：客户在系统中**不需要填写汇款信息**，只需要确认使用银行转账。汇款信息由业务员根据实际凭证填写，确保准确性。

---

### 阶段2：业务员上传凭证并填写汇款信息

**操作人**：业务员

**页面**：银行汇款管理页面（`http://localhost:5174/payment/bank-transfer-manage`）

**操作步骤**：
1. 访问银行汇款管理页面
2. 筛选状态：待上传凭证
3. 找到对应的汇款单据
4. 点击"上传凭证"按钮
5. 上传客户发来的汇款凭证图片（截图或扫描件）
6. 填写汇款信息（根据凭证填写）：
   - 汇款人姓名
   - 汇款银行
   - 汇款账户
   - 汇款金额
   - 汇款日期
7. 填写备注信息（可选）
8. 提交

**系统行为**：
- 保存凭证文件
- 更新单据状态：`pending_audit`（待审核）
- **自动触发审核流程**：
  ```python
  workflow_engine.trigger_audit(
      audit_type="yinhang_huikuan",
      related_id=danju_id,
      trigger_data={...},
      applicant_id=uploader_id
  )
  ```
- 查找 `audit_type="yinhang_huikuan"` 的工作流模板
- 创建审核流程实例
- 创建审核步骤记录
- 通知审核人

---

### 阶段3：财务审核汇款凭证

**操作人**：财务人员

**页面**：我的审核页面（`http://localhost:5174/audit/my-tasks`）

**操作步骤**：
1. 访问"我的审核"页面
2. 查看待审核的银行汇款单据
3. 点击查看详情
4. 查看汇款凭证图片
5. 核对汇款信息：
   - 汇款金额是否正确
   - 汇款人是否匹配
   - 款项是否到账
6. 做出审核决定：
   - 通过：确认款项到账
   - 拒绝：填写拒绝原因
7. 提交审核结果

**系统行为**：
- 更新审核记录状态
- 更新单据状态：
  - 审核通过：`approved`
  - 审核拒绝：`rejected`
- 更新合同支付状态（如果审核通过）
- 通知相关人员

---

## 配置步骤

### 前提条件

✅ 前端代码已修改，添加了"银行汇款审核"流程类型选项

### 步骤1：创建银行汇款审核工作流模板

1. **访问审核流程配置页面**
   ```
   http://localhost:5174/audit/workflow-config
   ```

2. **点击"新建流程"按钮**

3. **填写工作流配置**：

   | 字段 | 值 | 说明 |
   |------|-----|------|
   | 流程名称 | 银行汇款审核 | 必填 |
   | 流程类型 | 银行汇款审核 | 选择"银行汇款审核"（`yinhang_huikuan`） |
   | 流程描述 | 审核业务员上传的银行汇款凭证，确认款项到账 | 可选 |
   | 流程状态 | 启用 | 必须选择"启用" |

4. **配置审核步骤**：

   **步骤1：财务确认到账**
   - **步骤名称**：财务确认到账
   - **审核人角色**：财务（或选择具体的财务人员）
   - **步骤描述**：核对汇款凭证，确认款项到账

   > 💡 **提示**：你可以添加多个审核步骤，例如：
   > - 步骤1：财务初审
   > - 步骤2：财务主管复审

5. **保存工作流模板**

6. **验证创建成功**：
   - 在工作流列表中看到"银行汇款审核"
   - 流程类型显示为"银行汇款审核"
   - 状态显示为"启用"

---

### 步骤2：验证工作流模板配置

1. **检查数据库**（可选）：
   ```sql
   SELECT 
       id,
       guize_mingcheng,
       guize_leixing,
       chufa_tiaojian,
       shenhe_liucheng_peizhi,
       shi_qiyong
   FROM shenhe_guize
   WHERE guize_leixing = 'workflow_template'
   AND chufa_tiaojian LIKE '%yinhang_huikuan%'
   AND is_deleted = 'N';
   ```

2. **验证触发条件**：
   - `chufa_tiaojian` 字段应包含：
     ```json
     {
       "type": "workflow_template",
       "audit_type": "yinhang_huikuan"
     }
     ```

3. **验证审核步骤**：
   - `shenhe_liucheng_peizhi` 字段应包含步骤配置

---

## 测试流程

### 完整端到端测试

#### 1. 准备测试数据

- 确保有一个已签署的合同
- 确保有业务员账号和财务账号

#### 2. 客户确认使用银行转账

1. 访问合同签署页面
2. 选择"银行转账"支付方式
3. 查看公司银行账户信息
4. 点击"确认使用银行转账"

**预期结果**：
- ✅ 创建银行汇款单据
- ✅ 单据状态为 `waiting_voucher`
- ✅ 汇款信息字段为"待确认"

**客户线下操作**：
- 客户通过银行转账汇款
- 客户将汇款凭证发送给业务员

#### 3. 业务员上传凭证并填写汇款信息

1. 使用业务员账号登录
2. 访问：`http://localhost:5174/payment/bank-transfer-manage`
3. 找到待上传凭证的单据
4. 上传客户发来的汇款凭证图片
5. 填写汇款信息（汇款人、银行、账户、金额、日期）

**预期结果**：
- ✅ 凭证上传成功
- ✅ 单据状态更新为 `pending_audit`
- ✅ 自动创建审核流程实例
- ✅ 后端日志显示：`成功触发审核流程，流程ID：xxx`

**如果失败**：
- ⚠️ 后端日志显示：`未找到匹配的审核规则`
- 🔧 解决方案：检查工作流模板是否正确创建，`audit_type` 是否为 `yinhang_huikuan`

#### 4. 财务审核凭证

1. 使用财务账号登录
2. 访问：`http://localhost:5174/audit/my-tasks`
3. 查看待审核的银行汇款单据
4. 审核通过或拒绝

**预期结果**：
- ✅ 审核记录状态更新
- ✅ 单据状态更新为 `approved` 或 `rejected`
- ✅ 合同支付状态更新（如果审核通过）

---

## 常见问题

### Q1: 上传凭证后没有触发审核流程

**症状**：
- 凭证上传成功
- 单据状态更新为 `pending_audit`
- 但后端日志显示：`未找到匹配的审核规则`

**原因**：
- 没有创建 `audit_type="yinhang_huikuan"` 的工作流模板
- 工作流模板状态为"草稿"而不是"启用"

**解决方案**：
1. 检查工作流模板是否存在
2. 检查工作流模板状态是否为"启用"
3. 检查 `chufa_tiaojian` 字段中的 `audit_type` 是否为 `yinhang_huikuan`

---

### Q2: 财务在"我的审核"中看不到待审核任务

**症状**：
- 审核流程已创建
- 但财务账号在"我的审核"页面看不到任务

**原因**：
- 审核人角色配置不正确
- 财务账号没有对应的角色

**解决方案**：
1. 检查工作流模板中的"审核人角色"配置
2. 检查财务账号是否有对应的角色
3. 或者修改工作流模板，直接指定审核人用户ID

---

### Q3: 如何添加多级审核？

**场景**：
- 需要财务初审 + 财务主管复审

**解决方案**：
1. 编辑工作流模板
2. 添加多个审核步骤：
   - 步骤1：财务初审（审核人角色：财务）
   - 步骤2：财务主管复审（审核人角色：财务主管）
3. 保存

---

### Q4: 如何修改审核流程？

**操作步骤**：
1. 访问审核流程配置页面
2. 找到"银行汇款审核"工作流
3. 点击"编辑"按钮
4. 修改步骤配置
5. 保存

**注意**：
- 修改只影响新创建的审核流程
- 已创建的审核流程不受影响

---

## 总结

### ✅ 优点

1. **无需配置触发条件**：上传凭证时自动触发
2. **灵活可配置**：可以随时修改审核步骤
3. **专业界面**：专门为银行汇款设计的管理页面
4. **完整闭环**：从客户提交到财务审核的完整流程

### 📝 关键点

1. **工作流模板必须启用**：状态必须为"启用"
2. **audit_type 必须匹配**：必须为 `yinhang_huikuan`
3. **审核人必须正确配置**：角色或用户ID必须正确

### 🎯 下一步

1. 创建银行汇款审核工作流模板
2. 测试完整流程
3. 根据实际需求调整审核步骤

