# 代理记账服务限制功能 - 快速使用指南

## 🎯 功能概述

在线索报价时，系统会自动限制代理记账服务只能选择一个，防止业务错误。

## 📍 功能位置

**访问路径**: 
```
线索管理页面 (http://localhost:5174/leads)
  ↓
点击某个线索的"报价"按钮
  ↓
点击"添加服务"按钮
  ↓
服务选择对话框
```

## ✅ 使用步骤

### 步骤1: 打开服务选择对话框

1. 访问线索管理页面
2. 找到需要报价的线索
3. 点击"报价"按钮
4. 在报价表单中，点击"添加服务"按钮

### 步骤2: 识别代理记账服务

在服务选择对话框中，代理记账服务有以下特征：

- ✅ 显示**橙色"代理记账"标签**
- ✅ 卡片**左侧有橙色边框**
- ✅ 在"代理记账"分类标签下

**示例服务**:
- 小规模纳税人代理记账
- 一般纳税人代理记账
- 高新技术企业代理记账

### 步骤3: 选择服务

**正常选择**:
- 点击服务卡片或复选框即可选择
- 可以选择多个增值服务
- 只能选择一个代理记账服务

**限制提示**:
- 如果尝试选择第二个代理记账服务
- 系统会显示警告提示：
  ```
  ⚠️ 代理记账服务只能选择一个，请先取消已选择的代理记账服务
  ```

### 步骤4: 查看已选服务

已经在报价单中的服务会显示：
- 灰色"已在报价单中"标签
- 复选框被禁用
- 卡片透明度降低
- 无法再次选择

## 🎨 视觉指南

### 代理记账服务标识

```
┌─────────────────────────────────────┐
│ 小规模纳税人代理记账 [代理记账]     │ ← 橙色标签
│ 编码：DLJZ_XGMNSRZ                  │
│ 推荐价格：¥2000 / 年                │
│ 办事天数：3天                       │
└─────────────────────────────────────┘
↑ 左侧橙色边框
```

### 已选服务标识

```
┌─────────────────────────────────────┐
│ 小规模纳税人代理记账 [已在报价单中] │ ← 灰色标签
│ 编码：DLJZ_XGMNSRZ                  │ ← 透明度60%
│ 推荐价格：¥2000 / 年                │ ← 禁用状态
│ 办事天数：3天                       │
└─────────────────────────────────────┘
```

## 📋 常见场景

### 场景1: 首次添加代理记账服务

**操作**:
1. 打开服务选择对话框
2. 选择"小规模纳税人代理记账"
3. 点击"确定选择"

**结果**:
- ✅ 服务成功添加到报价单
- ✅ 可以继续添加增值服务

### 场景2: 尝试添加第二个代理记账服务

**操作**:
1. 报价单中已有"小规模纳税人代理记账"
2. 再次打开服务选择对话框
3. 尝试选择"一般纳税人代理记账"

**结果**:
- ❌ 显示警告提示
- ❌ 服务不会被添加
- ✅ "小规模纳税人代理记账"显示"已在报价单中"标签

### 场景3: 替换代理记账服务

**操作**:
1. 在报价单中删除"小规模纳税人代理记账"
2. 打开服务选择对话框
3. 选择"一般纳税人代理记账"

**结果**:
- ✅ 新服务成功添加
- ✅ 可以正常保存报价

### 场景4: 添加多个增值服务

**操作**:
1. 选择"税务筹划咨询"
2. 选择"有限公司注册"
3. 选择"财务管理咨询"

**结果**:
- ✅ 所有增值服务都可以添加
- ✅ 没有数量限制

## ⚠️ 注意事项

### 1. 代理记账服务识别

系统通过以下方式识别代理记账服务：
- 服务所属分类的类型为"代理记账"
- 不是通过服务名称判断

### 2. 已选服务状态

- 已在报价单中的服务无法再次选择
- 需要先在报价单中删除，才能选择其他服务

### 3. 后端验证

即使前端验证被绕过，后端也会进行二次验证：
- 如果提交包含多个代理记账服务的报价
- 会返回错误："代理记账服务只能选择一个，请检查报价项目"

## 🔧 故障排查

### 问题1: 看不到"代理记账"标签

**可能原因**:
- 浏览器缓存未清除
- 前端代码未更新

**解决方法**:
1. 按 F12 打开开发者工具
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"

### 问题2: 可以选择多个代理记账服务

**可能原因**:
- 前端验证逻辑未生效
- 服务分类配置错误

**解决方法**:
1. 检查浏览器控制台是否有错误
2. 检查服务的分类类型是否正确
3. 联系技术支持

### 问题3: 保存报价时提示错误

**错误信息**:
```
代理记账服务只能选择一个，请检查报价项目
```

**解决方法**:
1. 检查报价单中的服务列表
2. 删除多余的代理记账服务
3. 只保留一个代理记账服务
4. 重新保存

## 📊 技术细节

### 前端验证

**文件**: `packages/frontend/src/components/xiansuo/ProductSelector.vue`

**验证时机**: 用户点击服务卡片时

**验证逻辑**:
1. 检查点击的服务是否是代理记账服务
2. 检查当前选择列表中是否已有代理记账服务
3. 检查报价单中是否已有代理记账服务
4. 如果已有，显示警告并阻止选择

### 后端验证

**文件**: `packages/backend/src/services/xiansuo_guanli/xiansuo_baojia_service.py`

**验证时机**: 创建或更新报价时

**验证逻辑**:
1. 获取所有报价项目的ID
2. 查询项目的分类信息
3. 统计代理记账服务数量
4. 如果数量 > 1，抛出异常

## 📚 相关文档

- **详细实现文档**: `DAILI_JIZHANG_SERVICE_LIMIT_IMPLEMENTATION.md`
- **测试脚本**: `test_daili_jizhang_limit.py`

## 💡 最佳实践

### 1. 选择合适的代理记账服务

根据客户类型选择：
- 小规模纳税人 → 小规模纳税人代理记账
- 一般纳税人 → 一般纳税人代理记账
- 高新技术企业 → 高新技术企业代理记账

### 2. 组合增值服务

可以搭配以下增值服务：
- 税务筹划咨询
- 财务管理咨询
- 年度财务审计
- 工商注册服务

### 3. 报价单管理

- 定期检查报价单中的服务
- 及时删除不需要的服务
- 确保服务组合合理

## ✅ 功能验证清单

使用前请确认：

- [ ] 可以看到代理记账服务的橙色标签
- [ ] 可以看到代理记账服务的左侧橙色边框
- [ ] 选择第一个代理记账服务时正常
- [ ] 尝试选择第二个代理记账服务时显示警告
- [ ] 已在报价单中的服务显示灰色标签
- [ ] 已在报价单中的服务复选框被禁用
- [ ] 可以正常添加多个增值服务
- [ ] 保存报价时后端验证正常

---

**文档版本**: 1.0  
**更新时间**: 2025-10-14  
**适用版本**: 当前系统版本

