# ç§»åŠ¨ç«¯ä¸åç«¯åŠŸèƒ½åŒ¹é…åˆ†ææŠ¥å‘Š

**åˆ†ææ—¶é—´**: 2025-11-24  
**åˆ†æèŒƒå›´**: ç§»åŠ¨ç«¯H5åº”ç”¨ä¸åç«¯APIåŠŸèƒ½å¯¹æ¯”

---

## ğŸ“Š åç«¯å·²æœ‰åŠŸèƒ½

### 1. æƒé™ç³»ç»Ÿï¼ˆå®Œæ•´å®ç°ï¼‰âœ…

#### 1.1 RBACæƒé™æ¨¡å‹
- **è§’è‰²ç®¡ç†** (`/api/v1/user-management/roles`)
  - åˆ›å»º/ç¼–è¾‘/åˆ é™¤è§’è‰²
  - è§’è‰²åˆ—è¡¨æŸ¥è¯¢
  - è§’è‰²æƒé™åˆ†é…
  
- **æƒé™ç®¡ç†** (`/api/v1/user-management/permissions`)
  - æƒé™åˆ—è¡¨æŸ¥è¯¢
  - æƒé™æ ‘å½¢ç»“æ„
  - æŒ‰èµ„æºç±»å‹æŸ¥è¯¢æƒé™
  
- **ç”¨æˆ·è§’è‰²å…³è”**
  - ç”¨æˆ·å¯ä»¥æ‹¥æœ‰å¤šä¸ªè§’è‰²
  - è§’è‰²å¯ä»¥æ‹¥æœ‰å¤šä¸ªæƒé™
  - æƒé™ç»§æ‰¿æœºåˆ¶

#### 1.2 æƒé™æ£€æŸ¥æœºåˆ¶
- `require_permission(permission_code)` - FastAPIä¾èµ–æ³¨å…¥å½¢å¼
- `check_permission(permission_code)` - è£…é¥°å™¨å½¢å¼
- `check_multiple_permissions()` - å¤šæƒé™æ£€æŸ¥
- `has_role()` - è§’è‰²æ£€æŸ¥
- `get_user_permissions()` - è·å–ç”¨æˆ·æ‰€æœ‰æƒé™

#### 1.3 ç”¨æˆ·ä¿¡æ¯API
- **`GET /api/v1/auth/me`** - è¿”å›å®Œæ•´ç”¨æˆ·ä¿¡æ¯
  ```json
  {
    "id": "...",
    "yonghu_ming": "...",
    "xingming": "...",
    "youxiang": "...",
    "shouji": "...",
    "zhuangtai": "active",
    "zuihou_denglu": "...",
    "denglu_cishu": "...",
    "roles": ["admin", "manager"],  // âœ… å·²è¿”å›
    "permissions": ["office:baoxiao:read", "office:qingjia:read"]  // âœ… å·²è¿”å›
  }
  ```

### 2. åŠå…¬ç®¡ç†æ¨¡å— âœ…

#### 2.1 è¯·å‡ç”³è¯·
- âœ… åˆ—è¡¨æŸ¥è¯¢
- âœ… è¯¦æƒ…æŸ¥çœ‹
- âœ… åˆ›å»ºç”³è¯·
- âœ… æ›´æ–°ç”³è¯·
- âœ… åˆ é™¤ç”³è¯·
- âœ… æäº¤å®¡æ‰¹
- âœ… å®¡æ‰¹é€šè¿‡
- âœ… å®¡æ‰¹æ‹’ç»

#### 2.2 æŠ¥é”€ç”³è¯·
- âœ… åˆ—è¡¨æŸ¥è¯¢
- âœ… è¯¦æƒ…æŸ¥çœ‹
- âœ… åˆ›å»ºç”³è¯·
- âœ… æ›´æ–°ç”³è¯·
- âœ… åˆ é™¤ç”³è¯·
- âœ… æäº¤å®¡æ‰¹
- âœ… å®¡æ‰¹é€šè¿‡
- âœ… å®¡æ‰¹æ‹’ç»

#### 2.3 å…¶ä»–åŠå…¬ç®¡ç†åŠŸèƒ½ï¼ˆåç«¯å·²æœ‰ï¼‰
- âœ… å¯¹å¤–ä»˜æ¬¾ç”³è¯· (`/api/v1/office/payment`)
- âœ… é‡‡è´­ç”³è¯· (`/api/v1/office/procurement`)
- âœ… å·¥ä½œäº¤æ¥å• (`/api/v1/office/handover`)

### 3. æœåŠ¡ç®¡ç†æ¨¡å— âœ…

#### 3.1 ä»»åŠ¡é¡¹ç®¡ç†
- âœ… æˆ‘çš„ä»»åŠ¡åˆ—è¡¨ (`/api/v1/task-items/my-tasks`)
- âœ… ä»»åŠ¡ç»Ÿè®¡ (`/api/v1/task-items/statistics`)
- âœ… å¼€å§‹ä»»åŠ¡ (`/api/v1/task-items/{id}/start`)
- âœ… å®Œæˆä»»åŠ¡ (`/api/v1/task-items/{id}/complete`)
- âœ… æš‚åœä»»åŠ¡ (`/api/v1/task-items/{id}/pause`)

#### 3.2 æœåŠ¡å·¥å•ç®¡ç†
- âœ… å·¥å•åˆ—è¡¨ (`/api/v1/service-orders`)
- âœ… å·¥å•è¯¦æƒ… (`/api/v1/service-orders/{id}`)
- âœ… åˆ›å»ºå·¥å• (`/api/v1/service-orders`)
- âœ… æ›´æ–°å·¥å• (`/api/v1/service-orders/{id}`)
- âœ… å·¥å•ç»Ÿè®¡ (`/api/v1/service-orders/statistics`)

---

## ğŸ“± ç§»åŠ¨ç«¯å½“å‰åŠŸèƒ½

### 1. å·²å®ç°åŠŸèƒ½ âœ…

#### 1.1 è®¤è¯æ¨¡å—
- âœ… ç™»å½•é¡µé¢
- âœ… Tokenç®¡ç†ï¼ˆPinia + localStorageï¼‰
- âœ… è·¯ç”±å®ˆå«

#### 1.2 ä»»åŠ¡ç®¡ç†
- âœ… ä»»åŠ¡åˆ—è¡¨ (`/tasks`)
- âœ… ä»»åŠ¡è¯¦æƒ… (`/tasks/:id`)
- âœ… ä»»åŠ¡ç»Ÿè®¡

#### 1.3 å·¥å•ç®¡ç†
- âœ… å·¥å•åˆ—è¡¨ (`/orders`)
- âœ… å·¥å•è¯¦æƒ… (`/orders/:id`)

#### 1.4 åŠå…¬ç®¡ç†
- âœ… è¯·å‡ç”³è¯·åˆ—è¡¨ (`/office/leave`)
- âœ… è¯·å‡ç”³è¯·åˆ›å»º (`/office/leave/create`)
- âœ… è¯·å‡ç”³è¯·ç¼–è¾‘ (`/office/leave/edit/:id`)
- âœ… è¯·å‡ç”³è¯·è¯¦æƒ… (`/office/leave/:id`)
- âœ… æŠ¥é”€ç”³è¯·åˆ—è¡¨ (`/office/reimbursement`)
- âœ… æŠ¥é”€ç”³è¯·åˆ›å»º (`/office/reimbursement/create`)
- âœ… æŠ¥é”€ç”³è¯·ç¼–è¾‘ (`/office/reimbursement/edit/:id`)
- âœ… æŠ¥é”€ç”³è¯·è¯¦æƒ… (`/office/reimbursement/:id`)

#### 1.5 ä¸ªäººä¸­å¿ƒ
- âœ… ç”¨æˆ·ä¿¡æ¯å±•ç¤ºï¼ˆåŸºç¡€ï¼‰
- âœ… ä»»åŠ¡ç»Ÿè®¡å±•ç¤º
- âœ… é€€å‡ºç™»å½•

### 2. ç¼ºå¤±åŠŸèƒ½ âŒ

#### 2.1 æƒé™ç›¸å…³ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
- âŒ **ç”¨æˆ·è§’è‰²å±•ç¤º** - åç«¯å·²è¿”å› `roles` å­—æ®µï¼Œä½†ç§»åŠ¨ç«¯æœªä½¿ç”¨
- âŒ **ç”¨æˆ·æƒé™å±•ç¤º** - åç«¯å·²è¿”å› `permissions` å­—æ®µï¼Œä½†ç§»åŠ¨ç«¯æœªä½¿ç”¨
- âŒ **åŸºäºæƒé™çš„åŠŸèƒ½æ˜¾ç¤º/éšè—** - ä¾‹å¦‚å®¡æ‰¹æŒ‰é’®åº”è¯¥æ ¹æ®æƒé™æ˜¾ç¤º
- âŒ **æƒé™ä¸è¶³æç¤º** - å½“ç”¨æˆ·æ²¡æœ‰æƒé™æ—¶åº”è¯¥æœ‰å‹å¥½æç¤º

#### 2.2 åŠå…¬ç®¡ç†æ‰©å±•ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
- âŒ **å¯¹å¤–ä»˜æ¬¾ç”³è¯·** - åç«¯å·²æœ‰APIï¼Œç§»åŠ¨ç«¯æœªå®ç°
- âŒ **é‡‡è´­ç”³è¯·** - åç«¯å·²æœ‰APIï¼Œç§»åŠ¨ç«¯æœªå®ç°
- âŒ **å·¥ä½œäº¤æ¥å•** - åç«¯å·²æœ‰APIï¼Œç§»åŠ¨ç«¯æœªå®ç°

#### 2.3 ä¸ªäººä¸­å¿ƒå¢å¼ºï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
- âŒ **ä¿®æ”¹å¯†ç ** - åç«¯å·²æœ‰API (`/api/v1/auth/change-password`)
- âŒ **ä¸ªäººèµ„æ–™ç¼–è¾‘** - åç«¯å·²æœ‰API (`/api/v1/users/me/profile`)
- âŒ **è§’è‰²å’Œæƒé™æŸ¥çœ‹** - æ˜¾ç¤ºå½“å‰ç”¨æˆ·çš„è§’è‰²å’Œæƒé™åˆ—è¡¨

#### 2.4 å®¡æ‰¹åŠŸèƒ½ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
- âŒ **å¾…å®¡æ‰¹åˆ—è¡¨** - éœ€è¦æ˜¾ç¤ºéœ€è¦æˆ‘å®¡æ‰¹çš„ç”³è¯·
- âŒ **å®¡æ‰¹æ“ä½œ** - é€šè¿‡/æ‹’ç»æŒ‰é’®ï¼ˆéœ€è¦æƒé™æ£€æŸ¥ï¼‰
- âŒ **å®¡æ‰¹å†å²** - æŸ¥çœ‹å®¡æ‰¹è®°å½•

---

## ğŸ¯ å»ºè®®ä¼˜å…ˆå®ç°çš„åŠŸèƒ½

### ä¼˜å…ˆçº§1ï¼šæƒé™ç³»ç»Ÿé›†æˆï¼ˆå¿…é¡»ï¼‰

1. **æ›´æ–°UserStore**
   - æ·»åŠ  `roles: string[]` å­—æ®µ
   - æ·»åŠ  `permissions: string[]` å­—æ®µ
   - æ·»åŠ  `hasPermission(permission: string)` æ–¹æ³•
   - æ·»åŠ  `hasRole(role: string)` æ–¹æ³•

2. **æ›´æ–°Login.vue**
   - ç™»å½•æˆåŠŸåä¿å­˜ `roles` å’Œ `permissions`

3. **æ›´æ–°Profile.vue**
   - æ˜¾ç¤ºç”¨æˆ·è§’è‰²åˆ—è¡¨
   - æ˜¾ç¤ºç”¨æˆ·æƒé™åˆ—è¡¨ï¼ˆå¯æŠ˜å ï¼‰

4. **åˆ›å»ºæƒé™æŒ‡ä»¤**
   - `v-permission="'office:baoxiao:approve'"` - æ§åˆ¶å…ƒç´ æ˜¾ç¤º
   - ç”¨äºæ§åˆ¶å®¡æ‰¹æŒ‰é’®ç­‰éœ€è¦æƒé™çš„åŠŸèƒ½

### ä¼˜å…ˆçº§2ï¼šå®¡æ‰¹åŠŸèƒ½ï¼ˆé‡è¦ï¼‰

1. **å¾…å®¡æ‰¹åˆ—è¡¨é¡µé¢**
   - è·¯ç”±ï¼š`/approvals`
   - æ˜¾ç¤ºéœ€è¦æˆ‘å®¡æ‰¹çš„æ‰€æœ‰ç”³è¯·ï¼ˆè¯·å‡ã€æŠ¥é”€ç­‰ï¼‰
   - æŒ‰ç±»å‹åˆ†ç»„æ˜¾ç¤º

2. **å®¡æ‰¹æ“ä½œ**
   - åœ¨è¯¦æƒ…é¡µæ·»åŠ å®¡æ‰¹æŒ‰é’®ï¼ˆé€šè¿‡/æ‹’ç»ï¼‰
   - æ ¹æ®æƒé™æ˜¾ç¤º/éšè—å®¡æ‰¹æŒ‰é’®
   - å®¡æ‰¹æ„è§è¾“å…¥

### ä¼˜å…ˆçº§3ï¼šä¸ªäººä¸­å¿ƒå¢å¼ºï¼ˆé‡è¦ï¼‰

1. **ä¿®æ”¹å¯†ç **
   - è·¯ç”±ï¼š`/profile/change-password`
   - æ—§å¯†ç éªŒè¯
   - æ–°å¯†ç ç¡®è®¤

2. **ä¸ªäººèµ„æ–™ç¼–è¾‘**
   - è·¯ç”±ï¼š`/profile/edit`
   - ç¼–è¾‘å§“åã€é‚®ç®±ã€æ‰‹æœºå·

### ä¼˜å…ˆçº§4ï¼šåŠå…¬ç®¡ç†æ‰©å±•ï¼ˆå¯é€‰ï¼‰

1. **å¯¹å¤–ä»˜æ¬¾ç”³è¯·**
   - åˆ—è¡¨ã€åˆ›å»ºã€ç¼–è¾‘ã€è¯¦æƒ…é¡µé¢
   - å¤ç”¨æŠ¥é”€ç”³è¯·çš„UIè®¾è®¡

2. **é‡‡è´­ç”³è¯·**
   - åˆ—è¡¨ã€åˆ›å»ºã€ç¼–è¾‘ã€è¯¦æƒ…é¡µé¢

3. **å·¥ä½œäº¤æ¥å•**
   - åˆ—è¡¨ã€åˆ›å»ºã€ç¼–è¾‘ã€è¯¦æƒ…é¡µé¢

---

## ğŸ“ å®ç°å»ºè®®

### 1. UserStoreæ‰©å±•ç¤ºä¾‹

```typescript
export interface UserInfo {
  id: string
  yonghu_ming: string
  xingming: string
  youxiang?: string
  shouji?: string
  roles: string[]        // âœ… æ–°å¢
  permissions: string[]  // âœ… æ–°å¢
}

export const useUserStore = defineStore('user', () => {
  // ... ç°æœ‰ä»£ç  ...
  
  // âœ… æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šæƒé™
  function hasPermission(permission: string): boolean {
    return userInfo.value?.permissions?.includes(permission) || false
  }
  
  // âœ… æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šè§’è‰²
  function hasRole(role: string): boolean {
    return userInfo.value?.roles?.includes(role) || false
  }
  
  return {
    // ... ç°æœ‰è¿”å› ...
    hasPermission,
    hasRole
  }
})
```

### 2. æƒé™æŒ‡ä»¤ç¤ºä¾‹

```typescript
// src/directives/permission.ts
import { useUserStore } from '@/stores/user'

export const permission = {
  mounted(el: HTMLElement, binding: any) {
    const userStore = useUserStore()
    const requiredPermission = binding.value
    
    if (!userStore.hasPermission(requiredPermission)) {
      el.style.display = 'none'
    }
  }
}
```

### 3. ä½¿ç”¨ç¤ºä¾‹

```vue
<template>
  <!-- åªæœ‰æœ‰å®¡æ‰¹æƒé™çš„ç”¨æˆ·æ‰èƒ½çœ‹åˆ°å®¡æ‰¹æŒ‰é’® -->
  <van-button 
    v-permission="'office:baoxiao:approve'"
    type="success"
    @click="handleApprove"
  >
    å®¡æ‰¹é€šè¿‡
  </van-button>
</template>
```

---

**æ€»ç»“**: ç§»åŠ¨ç«¯åŸºç¡€åŠŸèƒ½å·²å®Œæˆï¼Œä½†ç¼ºå°‘æƒé™ç³»ç»Ÿé›†æˆå’Œå®¡æ‰¹åŠŸèƒ½ã€‚å»ºè®®ä¼˜å…ˆå®ç°æƒé™ç³»ç»Ÿé›†æˆï¼Œç„¶åæ·»åŠ å®¡æ‰¹åŠŸèƒ½ã€‚

