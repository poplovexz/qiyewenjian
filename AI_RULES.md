# AI 开发规则 (MCP v2.0)

> ⚠️ **本文件由 MCP (Model Context Protocol) v2.0 管理**
>
> **设计状态**: 🔒 已冻结 (FROZEN)
> **冻结时间**: {FREEZE_TIMESTAMP}
> **允许操作**: ✅ READ ONLY
> **禁止操作**: ❌ WRITE, APPEND, DELETE, RENAME
>
> **任何修改此文件的尝试都将被拒绝！**

---

## 🔄 MCP 状态机

```
┌──────────────────────────────────────────────────────────────────┐
│                    OneShot-MidSystem-Build                       │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│   INIT ─→ ARCH_GEN ─→ ARCH_REVIEW ─→ DESIGN_FREEZE              │
│              │            │              │                       │
│              ↓            ↓              ↓                       │
│         生成骨架      架构审计       🔒 冻结设计                  │
│                                          │                       │
│   ┌──────────────────────────────────────┘                       │
│   │                                                              │
│   ↓                                                              │
│   DOMAIN_CODE ─→ SERVICE_CODE ─→ API_CODE ─→ RUN_FIX            │
│        │              │             │           │                │
│        ↓              ↓             ↓           ↓                │
│   Domain层代码   Service层代码   API层代码   运行修复            │
│                                                 │                │
│                                                 ↓                │
│                                            循环直到成功           │
└──────────────────────────────────────────────────────────────────┘
```

**配置文件**: `.mcp/config.yaml` | `.mcp/states.yaml`

---

## 📋 目录

1. [核心原则](#核心原则)
2. [禁止操作](#禁止操作)
3. [允许操作](#允许操作)
4. [修复规则](#修复规则)
5. [代码规范](#代码规范)
6. [错误处理](#错误处理)

---

## 🎯 核心原则

### 1. 设计冻结原则 ⭐⭐⭐⭐⭐

**规则**: 设计文档一旦冻结，在编码和修复阶段**绝对不允许修改**。

**受保护的文件**:

- ❌ `AI_RULES.md` - 本文件
- ❌ `ARCHITECTURE.md` - 架构设计
- ❌ `DOMAIN.md` - 领域模型
- ❌ `FLOW.md` - 业务流程
- ❌ `API_SPEC.md` - API 规范

**执行**:

- 任何修改上述文件的尝试 → **立即停止并报告**
- 如果发现设计问题 → **停止编码，报告给用户**
- 不允许"小修改"、"微调"、"优化" → **一律拒绝**

---

### 2. 最小化修改原则 ⭐⭐⭐⭐⭐

**规则**: 修复错误时，只修改最小必要的代码。

**约束**:

- ✅ 最多修改 **3 个文件**
- ✅ 每个文件最多修改 **50 行**
- ✅ 总共最多修改 **100 行**

**禁止**:

- ❌ "顺手重构"
- ❌ "优化代码"
- ❌ "改进命名"
- ❌ "添加注释"（除非是修复的一部分）
- ❌ "统一代码风格"

---

### 3. 遇冲突必停原则 ⭐⭐⭐⭐⭐

**规则**: 遇到任何设计冲突，立即停止并报告。

**冲突示例**:

- 需要添加新的领域概念，但 `DOMAIN.md` 中没有定义
- 需要修改 API 接口，但 `API_SPEC.md` 中已定义
- 需要改变分层结构，但 `ARCHITECTURE.md` 中已固定

**执行**:

```
❌ 停止操作
📋 报告冲突详情
🤔 等待用户决策（修改设计 or 调整需求）
```

---

### 4. 禁止假设原则 ⭐⭐⭐⭐

**规则**: 不允许假设未在设计文档中明确定义的行为。

**示例**:

- ❌ "我假设用户登录后会跳转到首页" → 必须在 `FLOW.md` 中定义
- ❌ "我假设使用 JWT 认证" → 必须在 `ARCHITECTURE.md` 中定义
- ❌ "我假设错误返回 500" → 必须在 `API_SPEC.md` 中定义

**执行**:

```
🤔 发现未定义的行为
❓ 询问用户
📝 等待用户补充设计文档
```

---

### 5. 分层架构原则 ⭐⭐⭐⭐

**规则**: 严格遵循三层架构，禁止跨层调用。

**分层定义**:

```
┌─────────────────┐
│   API Layer     │  ← 只能调用 Service
├─────────────────┤
│  Service Layer  │  ← 只能调用 Domain
├─────────────────┤
│  Domain Layer   │  ← 不能调用任何层
└─────────────────┘
```

**禁止**:

- ❌ API 直接调用 Domain
- ❌ Domain 调用 Service
- ❌ Domain 调用 API
- ❌ 任何循环依赖

---

## ⚠️ 禁止操作

### 1. 禁止修改设计文档

**绝对禁止修改**:

- `AI_RULES.md`
- `ARCHITECTURE.md`
- `DOMAIN.md`
- `FLOW.md`
- `API_SPEC.md`

**即使是**:

- ❌ 修正拼写错误
- ❌ 添加注释
- ❌ 格式调整
- ❌ 任何形式的修改

**如果需要修改设计**:

```
1. 停止当前操作
2. 报告给用户："发现设计问题，需要修改 XXX.md"
3. 等待用户确认是否解冻设计
4. 用户确认后，才能修改
```

---

### 2. 禁止架构重构

**禁止**:

- ❌ 修改分层结构
- ❌ 添加新的层
- ❌ 合并现有层
- ❌ 修改依赖方向
- ❌ 引入新的架构模式

---

### 3. 禁止修复时重构

**禁止**:

- ❌ "顺手"重构代码
- ❌ 提取公共方法（除非是修复的一部分）
- ❌ 重命名变量（除非是修复的一部分）
- ❌ 优化性能（除非是修复的一部分）
- ❌ 改进代码风格

---

## ✅ 允许操作

### 1. 生成代码（CODE 阶段）

**允许**:

- ✅ 按照 `DOMAIN.md` 生成 Domain 层代码
- ✅ 按照 `FLOW.md` 生成 Service 层代码
- ✅ 按照 `API_SPEC.md` 生成 API 层代码
- ✅ 生成测试代码

**约束**:

- 必须严格遵循设计文档
- 不能添加设计文档中没有的功能
- 不能修改设计文档中定义的接口

---

### 2. 修复错误（FIX 阶段）

**允许**:

- ✅ 修复语法错误
- ✅ 修复运行时错误
- ✅ 修复逻辑错误
- ✅ 添加缺失的 import
- ✅ 修正拼写错误（变量名、函数名）
- ✅ 调整参数

**约束**:

- 最多修改 3 个文件
- 最多修改 100 行
- 不能修改设计文档

---

## 🔧 修复规则

### 修复流程

```
1. 分析错误
   ├─ 读取错误日志
   ├─ 定位错误源
   └─ 识别根因

2. 检查是否为设计问题
   ├─ 是 → 停止，报告给用户
   └─ 否 → 继续

3. 生成最小修复
   ├─ 识别最小修改
   ├─ 验证无副作用
   └─ 检查约束（≤3 文件，≤100 行）

4. 应用修复
   ├─ 修改代码
   └─ 验证语法

5. 报告修复
   └─ 说明修改了哪些文件，修改了多少行
```

### 修复约束

```yaml
max_files_changed: 3
max_lines_per_file: 50
max_total_lines: 100
max_iterations: 10

forbidden_operations:
  - modify_design_files
  - add_new_features
  - refactor_code
  - optimize_performance
  - change_architecture
```

---

## 📝 代码规范

### 命名规范

- **文件名**: `snake_case.py` (Python) 或 `kebab-case.ts` (TypeScript)
- **类名**: `PascalCase`
- **函数名**: `snake_case` (Python) 或 `camelCase` (TypeScript)
- **常量**: `UPPER_SNAKE_CASE`

### 目录结构

```
project/
├── domain/          # Domain 层
│   ├── entity.py
│   └── value_object.py
├── service/         # Service 层
│   └── use_case.py
├── api/             # API 层
│   ├── controller.py
│   └── route.py
└── tests/           # 测试
    └── test_*.py
```

---

## 🐛 错误处理

### 遇到设计冲突

```
❌ 停止操作
📋 报告：
   "发现设计冲突：
    - 需要添加新实体 'User'
    - 但 DOMAIN.md 中未定义
    - 建议：修改 DOMAIN.md 添加 User 实体定义"
🤔 等待用户决策
```

### 遇到未定义行为

```
❓ 询问用户：
   "在 FLOW.md 中未定义用户登录失败后的行为，
    请问应该：
    1. 返回错误信息
    2. 跳转到错误页面
    3. 其他（请说明）"
```

### 超出修复约束

```
❌ 停止修复
📋 报告：
   "此错误需要修改 5 个文件，超出约束（最多 3 个）
    建议：这可能是设计问题，需要重新审查架构"
```

---

## 🎯 总结

**记住这 5 条铁律**:

1. ❌ **绝对不修改设计文档**
2. ✅ **修复时最小化修改**（≤3 文件，≤100 行）
3. ❌ **遇冲突必停**
4. ❌ **不假设未定义的行为**
5. ✅ **严格遵循分层架构**

**违反任何一条 → 立即停止并报告**

---

**MCP v2.0 - 让 AI 编程可控、可预测、可信赖**
