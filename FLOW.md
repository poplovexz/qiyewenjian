# 业务流程文档 (FLOW.md)

> ⚠️ **本文件由 MCP (Model Context Protocol) v2.0 管理**
>
> **设计状态**: 🔒 已冻结 (FROZEN)
> **冻结时间**: 2025-12-19T16:00:00Z
> **允许操作**: ✅ READ ONLY

---

## 📋 目录

1. [用户认证流程](#用户认证流程)
2. [线索转化流程](#线索转化流程)
3. [合同签署流程](#合同签署流程)
4. [支付收款流程](#支付收款流程)
5. [审批流程](#审批流程)
6. [权限校验流程](#权限校验流程)

---

## 🔐 用户认证流程

### 登录流程

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  前端   │───→│ API层   │───→│ Service │───→│ Domain  │
│ 登录页  │    │ /auth/  │    │ auth_   │    │ Yonghu  │
│         │    │ login   │    │ service │    │ Model   │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
     │              │              │              │
     │  1. 输入凭证 │              │              │
     │─────────────→│              │              │
     │              │ 2. 验证参数  │              │
     │              │─────────────→│              │
     │              │              │ 3. 查询用户  │
     │              │              │─────────────→│
     │              │              │ 4. 验证密码  │
     │              │              │←─────────────│
     │              │ 5. 生成JWT  │              │
     │              │←─────────────│              │
     │ 6. 返回Token│              │              │
     │←─────────────│              │              │
```

### 状态定义

| 状态         | 说明                              |
| ------------ | --------------------------------- |
| `登录成功`   | 返回 access_token + refresh_token |
| `密码错误`   | 返回 401 Unauthorized             |
| `用户禁用`   | 返回 403 Forbidden                |
| `用户不存在` | 返回 404 Not Found                |

---

## 📈 线索转化流程

### 完整流程

```
创建线索 → 分配跟进 → 跟进记录 → 创建报价 → 报价确认 → 转化客户 → 创建合同
   │          │          │          │          │          │          │
   ↓          ↓          ↓          ↓          ↓          ↓          ↓
 新建     待跟进     跟进中    已报价    报价确认   已转化    已签约
```

### 状态流转

```python
# 线索状态流转规则
XIANSUO_STATUS_FLOW = {
    "新建": ["待跟进", "已关闭"],
    "待跟进": ["跟进中", "已关闭"],
    "跟进中": ["已报价", "已关闭"],
    "已报价": ["报价确认", "跟进中", "已关闭"],
    "报价确认": ["已转化", "跟进中"],
    "已转化": ["已签约"],
    "已签约": [],  # 终态
    "已关闭": [],  # 终态
}
```

### 关键操作

| 操作     | 触发条件           | 结果                           |
| -------- | ------------------ | ------------------------------ |
| 创建报价 | 线索状态为"跟进中" | 状态变为"已报价"               |
| 确认报价 | 客户确认报价       | 状态变为"报价确认"             |
| 转化客户 | 报价确认后         | 自动创建客户，状态变为"已转化" |
| 创建合同 | 客户已转化         | 状态变为"已签约"               |

---

## 📄 合同签署流程

### 流程图

```
创建合同 → 生成预览 → 发送签署 → 客户签署 → 支付 → 完成
   │          │          │          │       │      │
   ↓          ↓          ↓          ↓       ↓      ↓
 草稿      待发送     待签署     已签署   已支付  已完成
```

### 状态定义

```python
HETONG_STATUS = {
    "草稿": "合同创建中，可编辑",
    "待发送": "合同已生成，待发送给客户",
    "待签署": "已发送给客户，等待签署",
    "已签署": "客户已签署，待支付",
    "已支付": "已收到全额付款",
    "已完成": "合同履行完成",
    "已作废": "合同已作废",
}
```

### 关键服务

| 服务                      | 职责         |
| ------------------------- | ------------ |
| `hetong_service`          | 合同 CRUD    |
| `hetong_generate_service` | 合同文档生成 |
| `hetong_sign_service`     | 签署链接生成 |
| `hetong_qianshu_service`  | 签署记录管理 |

---

## 💰 支付收款流程

### 在线支付流程

```
创建支付订单 → 调用支付网关 → 等待支付 → 支付回调 → 更新状态
      │              │            │          │          │
      ↓              ↓            ↓          ↓          ↓
   待支付        跳转支付页    用户支付   异步通知    已支付
```

### 银行转账流程

```
上传回款单据 → 财务审核 → 审核通过 → 更新合同金额
      │            │          │            │
      ↓            ↓          ↓            ↓
   待审核       审核中      已通过      已入账
```

### 审批状态流转

```python
SHENPI_STATUS_FLOW = {
    "待提交": ["待审批"],
    "待审批": ["已通过", "已拒绝", "已撤回"],
    "已通过": [],  # 终态
    "已拒绝": ["待审批"],  # 可重新提交
    "已撤回": ["待审批"],  # 可重新提交
}
```

---

## 🔒 权限校验流程

### 校验流程

```
请求到达 → 提取Token → 验证Token → 获取用户 → 获取权限 → 校验权限 → 放行/拒绝
    │          │           │          │          │          │          │
    ↓          ↓           ↓          ↓          ↓          ↓          ↓
 API请求   JWT解析    签名验证   用户查询   权限列表   权限匹配   200/403
```

### 权限类型

| 类型     | 说明     | 示例             |
| -------- | -------- | ---------------- |
| `menu`   | 菜单权限 | `xiansuo:view`   |
| `button` | 按钮权限 | `xiansuo:create` |
| `api`    | 接口权限 | `xiansuo:delete` |

### 权限编码规范

```
{模块}:{操作}

示例:
- xiansuo:view     - 查看线索
- xiansuo:create   - 创建线索
- xiansuo:edit     - 编辑线索
- xiansuo:delete   - 删除线索
- hetong:sign      - 签署合同
- zhifu:refund     - 退款操作
```

### 权限校验实现

```python
# 在 API 层使用依赖注入校验权限
@router.get("/leads/")
async def get_leads(
    current_user: Yonghu = Depends(get_current_user),
    _: bool = Depends(require_permission("xiansuo:view"))
):
    ...
```

---

## 🔄 异步任务流程

### 通知发送流程

```
事件触发 → 创建通知 → 推送通知 → 标记已读
    │          │          │          │
    ↓          ↓          ↓          ↓
 业务事件   通知记录   WebSocket   用户操作
```

### 常见事件

| 事件     | 触发条件   | 通知对象 |
| -------- | ---------- | -------- |
| 审批待办 | 新审批任务 | 审批人   |
| 审批结果 | 审批完成   | 申请人   |
| 合同签署 | 客户签署   | 销售人员 |
| 支付成功 | 支付回调   | 财务人员 |

---

## 🔐 DESIGN_FREEZE

```yaml
design_locked: true
frozen_at: "2025-12-19T16:00:00Z"
```

**冻结后禁止**:

- ❌ 添加新的流程
- ❌ 修改状态流转规则
- ❌ 修改权限校验逻辑
- ❌ 修改审批规则结构

**冻结后允许**:

- ✅ 添加新的审批类型
- ✅ 配置新的审批规则
- ✅ 添加新的通知事件
