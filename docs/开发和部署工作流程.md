# å¼€å‘å’Œéƒ¨ç½²å·¥ä½œæµç¨‹

## ğŸ¯ ç›®æ ‡

ç¡®ä¿æ¯æ¬¡æ›´æ–°éƒ½èƒ½é¡ºåˆ©éƒ¨ç½²ï¼Œä¸ä¼šå‡ºç°ä¾èµ–ç¼ºå¤±ã€æ•°æ®åº“è¿ç§»é—æ¼ç­‰é—®é¢˜ã€‚

## ğŸ“‹ å¼€å‘æ–°åŠŸèƒ½çš„æ ‡å‡†æµç¨‹

### 1. å¼€å‘é˜¶æ®µ

#### 1.1 å®‰è£…æ–°ä¾èµ–
```bash
# åœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…
cd packages/backend
source venv/bin/activate
pip install æ–°çš„åŒ…å

# ç¤ºä¾‹
pip install wechatpayv3 python-alipay-sdk
```

#### 1.2 å¼€å‘åŠŸèƒ½
- ç¼–å†™ä»£ç 
- ç¼–å†™æµ‹è¯•
- æœ¬åœ°æµ‹è¯•

#### 1.3 æ•°æ®åº“å˜æ›´
å¦‚æœéœ€è¦æ–°çš„æ•°æ®åº“è¡¨æˆ–å­—æ®µï¼š

```bash
# åˆ›å»ºè¿ç§»SQLæ–‡ä»¶
# æ–‡ä»¶åæ ¼å¼: packages/backend/migrations/æè¿°.sql
# ç¤ºä¾‹: packages/backend/migrations/create_payment_tables.sql
```

### 2. å‡†å¤‡éƒ¨ç½²

#### 2.1 æ›´æ–°ä¾èµ–æ–‡ä»¶ï¼ˆé‡è¦ï¼ï¼‰
```bash
# è‡ªåŠ¨æ›´æ–° requirements-production.txt
./scripts/update-production-requirements.sh
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- âœ… è‡ªåŠ¨ç”Ÿæˆæœ€æ–°çš„ä¾èµ–åˆ—è¡¨
- âœ… æ˜¾ç¤ºå˜æ›´å¯¹æ¯”
- âœ… ä½¿ç”¨å®é™…å®‰è£…çš„ç‰ˆæœ¬å·ï¼ˆä¸ä¼šå‡ºé”™ï¼‰
- âœ… å¤‡ä»½æ—§æ–‡ä»¶

#### 2.2 æ›´æ–°éƒ¨ç½²è„šæœ¬ï¼ˆå¦‚æœæœ‰æ–°çš„è¿ç§»ï¼‰
å¦‚æœåˆ›å»ºäº†æ–°çš„SQLè¿ç§»æ–‡ä»¶ï¼Œéœ€è¦æ›´æ–° `quick-deploy.sh`ï¼š

```bash
# ç¼–è¾‘ quick-deploy.shï¼Œåœ¨ MIGRATIONS æ•°ç»„ä¸­æ·»åŠ æ–°çš„è¿ç§»æ–‡ä»¶
MIGRATIONS=(
    "migrations/create_bangong_guanli_tables.sql"
    "migrations/create_payment_tables.sql"
    "migrations/ä½ çš„æ–°è¿ç§»æ–‡ä»¶.sql"  # æ·»åŠ è¿™ä¸€è¡Œ
)
```

#### 2.3 è¿è¡Œéƒ¨ç½²å‰æ£€æŸ¥
```bash
# è¿è¡Œè‡ªåŠ¨æ£€æŸ¥è„šæœ¬
./scripts/pre-deploy-check.sh
```

è¿™ä¸ªè„šæœ¬ä¼šæ£€æŸ¥ï¼š
- âœ… ä¾èµ–æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- âœ… å‰ç«¯æ˜¯å¦èƒ½æ­£å¸¸æ„å»º
- âœ… ä¾èµ–æ˜¯å¦èƒ½æ­£å¸¸å®‰è£…
- âœ… åç«¯ä»£ç æ˜¯å¦èƒ½æ­£å¸¸å¯¼å…¥

**åªæœ‰æ£€æŸ¥é€šè¿‡åæ‰èƒ½éƒ¨ç½²ï¼**

### 3. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

#### 3.1 æäº¤ä»£ç 
```bash
git add .
git commit -m "feat: æ·»åŠ XXXåŠŸèƒ½"
git push
```

#### 3.2 ä¸€é”®éƒ¨ç½²
è®¿é—® http://localhost:5174/settings/deploy
- é€‰æ‹©è¦éƒ¨ç½²çš„åˆ†æ”¯
- ç‚¹å‡»"ä¸€é”®éƒ¨ç½²"
- ç­‰å¾…éƒ¨ç½²å®Œæˆ

æˆ–è€…ä½¿ç”¨å‘½ä»¤è¡Œï¼š
```bash
./quick-deploy.sh
```

## ğŸ›¡ï¸ é˜²æ­¢å‡ºé”™çš„æ£€æŸ¥æ¸…å•

æ¯æ¬¡æ–°å¢åŠŸèƒ½æ—¶ï¼Œé—®è‡ªå·±è¿™äº›é—®é¢˜ï¼š

### âœ… ä¾èµ–æ£€æŸ¥
- [ ] æ˜¯å¦å®‰è£…äº†æ–°çš„PythonåŒ…ï¼Ÿ
  - æ˜¯ â†’ è¿è¡Œ `./scripts/update-production-requirements.sh`
  
### âœ… æ•°æ®åº“æ£€æŸ¥
- [ ] æ˜¯å¦éœ€è¦æ–°çš„æ•°æ®åº“è¡¨ï¼Ÿ
  - æ˜¯ â†’ åˆ›å»ºSQLè¿ç§»æ–‡ä»¶
  - æ˜¯ â†’ æ›´æ–° `quick-deploy.sh` ä¸­çš„ MIGRATIONS æ•°ç»„

### âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥
- [ ] æ˜¯å¦éœ€è¦æ–°çš„ç¯å¢ƒå˜é‡ï¼Ÿ
  - æ˜¯ â†’ æ›´æ–° `.env.example`
  - æ˜¯ â†’ åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šæ›´æ–° `.env`

### âœ… å‰ç«¯æ£€æŸ¥
- [ ] å‰ç«¯æ˜¯å¦æœ‰æ–°çš„é¡µé¢æˆ–ç»„ä»¶ï¼Ÿ
  - æ˜¯ â†’ ç¡®ä¿ `npm run build:prod` èƒ½æˆåŠŸ

### âœ… éƒ¨ç½²å‰æ£€æŸ¥
- [ ] è¿è¡Œ `./scripts/pre-deploy-check.sh`
- [ ] æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡

## ğŸš€ å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨å‘½ä»¤

```bash
# 1. æ›´æ–°ä¾èµ–æ–‡ä»¶
./scripts/update-production-requirements.sh

# 2. éƒ¨ç½²å‰æ£€æŸ¥
./scripts/pre-deploy-check.sh

# 3. ä¸€é”®éƒ¨ç½²
./quick-deploy.sh

# 4. æŸ¥çœ‹ç”Ÿäº§ç¯å¢ƒæ—¥å¿—
ssh saas@172.16.2.221
tail -f /home/saas/proxy-system/logs/backend.log
```

### æ•…éšœæ’æŸ¥

#### éƒ¨ç½²å¤±è´¥ï¼šä¾èµ–å®‰è£…é”™è¯¯
```bash
# æ£€æŸ¥ä¾èµ–æ–‡ä»¶
cat packages/backend/requirements-production.txt

# æœ¬åœ°æµ‹è¯•å®‰è£…
cd packages/backend
python3 -m venv test_venv
source test_venv/bin/activate
pip install -r requirements-production.txt
```

#### éƒ¨ç½²å¤±è´¥ï¼šæ•°æ®åº“é”™è¯¯
```bash
# æ£€æŸ¥è¿ç§»æ–‡ä»¶æ˜¯å¦éƒ½åœ¨ quick-deploy.sh ä¸­
grep "MIGRATIONS=" quick-deploy.sh -A 20

# æ‰‹åŠ¨è¿è¡Œè¿ç§»
ssh saas@172.16.2.221
cd /home/saas/proxy-system/packages/backend
PGPASSWORD=proxy_password_123 psql -h localhost -U proxy_user -d proxy_db -f migrations/ä½ çš„è¿ç§»æ–‡ä»¶.sql
```

## ğŸ“Š å·¥ä½œæµç¨‹å›¾

```
å¼€å‘æ–°åŠŸèƒ½
    â†“
å®‰è£…æ–°ä¾èµ– (pip install)
    â†“
åˆ›å»ºè¿ç§»æ–‡ä»¶ (å¦‚æœéœ€è¦)
    â†“
æœ¬åœ°æµ‹è¯•
    â†“
æ›´æ–°ä¾èµ–æ–‡ä»¶ (./scripts/update-production-requirements.sh)
    â†“
æ›´æ–°éƒ¨ç½²è„šæœ¬ (å¦‚æœæœ‰æ–°è¿ç§»)
    â†“
è¿è¡Œéƒ¨ç½²å‰æ£€æŸ¥ (./scripts/pre-deploy-check.sh)
    â†“
æ£€æŸ¥é€šè¿‡ï¼Ÿ
    â”œâ”€ å¦ â†’ ä¿®å¤é—®é¢˜ â†’ é‡æ–°æ£€æŸ¥
    â””â”€ æ˜¯ â†’ æäº¤ä»£ç  â†’ ä¸€é”®éƒ¨ç½²
```

## ğŸ’¡ æœ€ä½³å®è·µ

1. **æ°¸è¿œä¸è¦æ‰‹åŠ¨ç¼–è¾‘ç‰ˆæœ¬å·** - ä½¿ç”¨ `update-production-requirements.sh`
2. **éƒ¨ç½²å‰å¿…é¡»è¿è¡Œæ£€æŸ¥** - ä½¿ç”¨ `pre-deploy-check.sh`
3. **å°æ­¥å¿«è·‘** - æ¯æ¬¡åªæ·»åŠ ä¸€ä¸ªåŠŸèƒ½ï¼Œç«‹å³éƒ¨ç½²æµ‹è¯•
4. **ä¿æŒåŒæ­¥** - æœ¬åœ°ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„ä¾èµ–åº”è¯¥ä¸€è‡´
5. **è®°å½•å˜æ›´** - åœ¨ Git commit ä¸­æ¸…æ¥šè¯´æ˜å˜æ›´å†…å®¹

