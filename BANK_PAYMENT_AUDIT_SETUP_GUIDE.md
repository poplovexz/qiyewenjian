# é“¶è¡Œæ±‡æ¬¾å®¡æ ¸æµç¨‹è®¾ç½®æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—å°†å¸®åŠ©ä½ è®¾ç½®é“¶è¡Œæ±‡æ¬¾å®¡æ ¸æµç¨‹ï¼Œä½¿è´¢åŠ¡äººå‘˜èƒ½å¤Ÿå®¡æ ¸ä¸šåŠ¡å‘˜ä¸Šä¼ çš„æ±‡æ¬¾å‡­è¯ã€‚

## ğŸ¯ æµç¨‹è¯´æ˜

### å®Œæ•´ä¸šåŠ¡æµç¨‹

1. **å®¢æˆ·ç¡®è®¤é“¶è¡Œè½¬è´¦** â†’ ç³»ç»Ÿåˆ›å»ºæ±‡æ¬¾å•æ®ï¼ˆçŠ¶æ€ï¼šå¾…ä¸Šä¼ å‡­è¯ï¼‰
2. **ä¸šåŠ¡å‘˜ä¸Šä¼ å‡­è¯** â†’ çŠ¶æ€æ›´æ–°ä¸º"å¾…å®¡æ ¸"ï¼Œè§¦å‘å®¡æ ¸æµç¨‹
3. **è´¢åŠ¡å®¡æ ¸å‡­è¯** â†’ å®¡æ ¸é€šè¿‡åï¼ŒåˆåŒæ”¯ä»˜çŠ¶æ€è‡ªåŠ¨æ›´æ–°ä¸º"å·²æ”¯ä»˜"

### å®¡æ ¸ç±»å‹

- **å®¡æ ¸ç±»å‹ä»£ç **: `yinhang_huikuan`ï¼ˆé“¶è¡Œæ±‡æ¬¾å®¡æ ¸ï¼‰
- **å…³è”å¯¹è±¡**: é“¶è¡Œæ±‡æ¬¾å•æ®ï¼ˆYinhangHuikuanDanjuï¼‰

## ğŸ› ï¸ æ–¹æ¡ˆä¸€ï¼šé€šè¿‡å‰ç«¯ç•Œé¢é…ç½®ï¼ˆæ¨èï¼‰

### æ­¥éª¤1ï¼šè®¿é—®å®¡æ ¸æµç¨‹é…ç½®é¡µé¢

1. ç™»å½•ç³»ç»Ÿï¼ˆä½¿ç”¨ç®¡ç†å‘˜è´¦å·ï¼‰
2. è®¿é—®ï¼š`http://localhost:5174/audit/workflow-config`
3. ç‚¹å‡»"æ–°å»ºå·¥ä½œæµ"æŒ‰é’®

### æ­¥éª¤2ï¼šå¡«å†™å·¥ä½œæµåŸºæœ¬ä¿¡æ¯

åœ¨å¼¹å‡ºçš„è¡¨å•ä¸­å¡«å†™ï¼š

| å­—æ®µ | å€¼ | è¯´æ˜ |
|------|-----|------|
| å·¥ä½œæµåç§° | é“¶è¡Œæ±‡æ¬¾å‡­è¯å®¡æ ¸ | æ˜¾ç¤ºåç§° |
| å®¡æ ¸ç±»å‹ | yinhang_huikuan | **é‡è¦**ï¼šå¿…é¡»æ˜¯è¿™ä¸ªå€¼ |
| å·¥ä½œæµæè¿° | ä¸šåŠ¡å‘˜ä¸Šä¼ é“¶è¡Œæ±‡æ¬¾å‡­è¯åï¼Œç”±è´¢åŠ¡äººå‘˜å®¡æ ¸ç¡®è®¤ | å¯é€‰ |
| çŠ¶æ€ | å¯ç”¨ | é€‰æ‹©"å¯ç”¨" |

### æ­¥éª¤3ï¼šé…ç½®å®¡æ ¸æ­¥éª¤

ç‚¹å‡»"æ·»åŠ æ­¥éª¤"ï¼Œé…ç½®ä»¥ä¸‹å®¡æ ¸æ­¥éª¤ï¼š

#### æ­¥éª¤1ï¼šè´¢åŠ¡ä¸“å‘˜å®¡æ ¸

| å­—æ®µ | å€¼ |
|------|-----|
| æ­¥éª¤åç§° | è´¢åŠ¡ä¸“å‘˜å®¡æ ¸ |
| æ­¥éª¤é¡ºåº | 1 |
| å®¡æ ¸äºº | é€‰æ‹©è´¢åŠ¡ä¸“å‘˜è§’è‰²æˆ–å…·ä½“è´¢åŠ¡äººå‘˜ |
| æ­¥éª¤æè¿° | å®¡æ ¸æ±‡æ¬¾å‡­è¯çš„çœŸå®æ€§å’Œé‡‘é¢æ˜¯å¦æ­£ç¡® |
| é¢„è®¡å¤„ç†æ—¶é—´ | 24ï¼ˆå°æ—¶ï¼‰ |
| æ˜¯å¦å¿…éœ€ | æ˜¯ |

#### æ­¥éª¤2ï¼šè´¢åŠ¡ç»ç†å®¡æ ¸ï¼ˆå¯é€‰ï¼Œå¤§é¢æ±‡æ¬¾ï¼‰

å¦‚æœéœ€è¦å¯¹å¤§é¢æ±‡æ¬¾è¿›è¡ŒäºŒæ¬¡å®¡æ ¸ï¼Œå¯ä»¥æ·»åŠ ç¬¬äºŒæ­¥ï¼š

| å­—æ®µ | å€¼ |
|------|-----|
| æ­¥éª¤åç§° | è´¢åŠ¡ç»ç†å®¡æ ¸ |
| æ­¥éª¤é¡ºåº | 2 |
| å®¡æ ¸äºº | é€‰æ‹©è´¢åŠ¡ç»ç†è§’è‰²æˆ–å…·ä½“è´¢åŠ¡ç»ç† |
| æ­¥éª¤æè¿° | å¯¹å¤§é¢æ±‡æ¬¾è¿›è¡ŒäºŒæ¬¡ç¡®è®¤ |
| é¢„è®¡å¤„ç†æ—¶é—´ | 48ï¼ˆå°æ—¶ï¼‰ |
| æ˜¯å¦å¿…éœ€ | æ˜¯ |

### æ­¥éª¤4ï¼šä¿å­˜é…ç½®

ç‚¹å‡»"ç¡®å®š"æŒ‰é’®ä¿å­˜é…ç½®ã€‚

## ğŸ› ï¸ æ–¹æ¡ˆäºŒï¼šé€šè¿‡æ•°æ®åº“ç›´æ¥é…ç½®

å¦‚æœå‰ç«¯ç•Œé¢è¿˜æ²¡æœ‰å®Œå…¨å®ç°ï¼Œå¯ä»¥é€šè¿‡æ•°æ®åº“ç›´æ¥æ’å…¥é…ç½®ã€‚

### SQLè„šæœ¬

```sql
-- æ’å…¥é“¶è¡Œæ±‡æ¬¾å®¡æ ¸æµç¨‹é…ç½®
INSERT INTO shenhe_guize (
    id,
    guize_mingcheng,
    guize_leixing,
    chufa_tiaojian,
    shenhe_liucheng_peizhi,
    shi_qiyong,
    paixu,
    guize_miaoshu,
    created_by,
    created_at,
    updated_at,
    is_deleted
) VALUES (
    gen_random_uuid(),
    'å·¥ä½œæµæ¨¡æ¿-é“¶è¡Œæ±‡æ¬¾å‡­è¯å®¡æ ¸',
    'workflow_template',
    '{"type": "workflow_template", "audit_type": "yinhang_huikuan"}',
    '{
        "steps": [
            {
                "step": 1,
                "name": "è´¢åŠ¡ä¸“å‘˜å®¡æ ¸",
                "approver_role": "finance_specialist",
                "description": "å®¡æ ¸æ±‡æ¬¾å‡­è¯çš„çœŸå®æ€§å’Œé‡‘é¢æ˜¯å¦æ­£ç¡®",
                "expected_time": 24,
                "is_required": true
            }
        ]
    }',
    'Y',
    1,
    'ä¸šåŠ¡å‘˜ä¸Šä¼ é“¶è¡Œæ±‡æ¬¾å‡­è¯åï¼Œç”±è´¢åŠ¡äººå‘˜å®¡æ ¸ç¡®è®¤',
    'system',
    NOW(),
    NOW(),
    'N'
);
```

### éªŒè¯é…ç½®

æ‰§è¡Œä»¥ä¸‹SQLéªŒè¯é…ç½®æ˜¯å¦æˆåŠŸï¼š

```sql
SELECT 
    id,
    guize_mingcheng,
    guize_leixing,
    chufa_tiaojian,
    shenhe_liucheng_peizhi,
    shi_qiyong
FROM shenhe_guize 
WHERE guize_leixing = 'workflow_template'
AND chufa_tiaojian::jsonb->>'audit_type' = 'yinhang_huikuan'
AND is_deleted = 'N';
```

## ğŸ› ï¸ æ–¹æ¡ˆä¸‰ï¼šé€šè¿‡APIé…ç½®

### ä½¿ç”¨curlå‘½ä»¤

```bash
# 1. ç™»å½•è·å–token
TOKEN=$(curl -s -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin@example.com","password":"admin123"}' \
  | jq -r '.access_token')

# 2. åˆ›å»ºå®¡æ ¸æµç¨‹é…ç½®
curl -X POST http://localhost:8000/api/v1/audit-workflows/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "workflow_name": "é“¶è¡Œæ±‡æ¬¾å‡­è¯å®¡æ ¸",
    "audit_type": "yinhang_huikuan",
    "description": "ä¸šåŠ¡å‘˜ä¸Šä¼ é“¶è¡Œæ±‡æ¬¾å‡­è¯åï¼Œç”±è´¢åŠ¡äººå‘˜å®¡æ ¸ç¡®è®¤",
    "status": "active",
    "steps": [
      {
        "step_name": "è´¢åŠ¡ä¸“å‘˜å®¡æ ¸",
        "step_order": 1,
        "approver_role": "finance_specialist",
        "description": "å®¡æ ¸æ±‡æ¬¾å‡­è¯çš„çœŸå®æ€§å’Œé‡‘é¢æ˜¯å¦æ­£ç¡®",
        "expected_time": 24,
        "is_required": true
      }
    ]
  }'
```

## ğŸ”§ åç«¯ä»£ç é›†æˆ

### ä¿®æ”¹ä¸šåŠ¡å‘˜ä¸Šä¼ å‡­è¯æœåŠ¡

éœ€è¦åœ¨ä¸šåŠ¡å‘˜ä¸Šä¼ å‡­è¯åè§¦å‘å®¡æ ¸æµç¨‹ã€‚

**æ–‡ä»¶**: `packages/backend/src/services/zhifu_guanli/yinhang_huikuan_danju_service.py`

åœ¨ `upload_voucher` æ–¹æ³•ä¸­æ·»åŠ è§¦å‘å®¡æ ¸çš„ä»£ç ï¼š

```python
def upload_voucher(self, danju_id: str, voucher_url: str, uploader_id: str, beizhu: str = None):
    """ä¸šåŠ¡å‘˜ä¸Šä¼ æ±‡æ¬¾å‡­è¯"""
    # ... ç°æœ‰ä»£ç  ...
    
    # æ›´æ–°çŠ¶æ€ä¸ºå¾…å®¡æ ¸
    danju.shenhe_zhuangtai = "pending_audit"
    
    # âœ… è§¦å‘å®¡æ ¸æµç¨‹
    from services.shenhe_guanli.shenhe_workflow_engine import ShenheWorkflowEngine
    
    workflow_engine = ShenheWorkflowEngine(self.db)
    workflow_id = workflow_engine.trigger_audit(
        audit_type="yinhang_huikuan",  # å®¡æ ¸ç±»å‹
        related_id=danju_id,  # æ±‡æ¬¾å•æ®ID
        trigger_data={
            "danju_bianhao": danju.danju_bianhao,
            "huikuan_jine": float(danju.huikuan_jine),
            "voucher_url": voucher_url
        },
        applicant_id=uploader_id  # ä¸Šä¼ äººID
    )
    
    # ä¿å­˜å®¡æ ¸æµç¨‹IDï¼ˆå¯é€‰ï¼‰
    if workflow_id:
        danju.shenhe_liucheng_id = workflow_id
    
    self.db.commit()
    
    return {
        "success": True,
        "message": "å‡­è¯ä¸Šä¼ æˆåŠŸï¼Œå·²æäº¤å®¡æ ¸",
        "workflow_id": workflow_id
    }
```

### ä¿®æ”¹è´¢åŠ¡å®¡æ ¸æœåŠ¡

è´¢åŠ¡å®¡æ ¸é€šè¿‡åï¼Œéœ€è¦æ›´æ–°æ±‡æ¬¾å•æ®çŠ¶æ€å’ŒåˆåŒæ”¯ä»˜çŠ¶æ€ã€‚

**æ–‡ä»¶**: `packages/backend/src/services/zhifu_guanli/yinhang_huikuan_danju_service.py`

```python
def audit_voucher(self, danju_id: str, approved: bool, auditor_id: str, audit_opinion: str = None):
    """è´¢åŠ¡å®¡æ ¸æ±‡æ¬¾å‡­è¯"""
    # ... ç°æœ‰ä»£ç  ...
    
    if approved:
        # å®¡æ ¸é€šè¿‡
        danju.shenhe_zhuangtai = "approved"
        
        # âœ… æ›´æ–°åˆåŒæ”¯ä»˜çŠ¶æ€ä¸ºå·²æ”¯ä»˜
        if danju.hetong_zhifu_id:
            from models.hetong_guanli.hetong_zhifu import HetongZhifu
            
            hetong_zhifu = self.db.query(HetongZhifu).filter(
                HetongZhifu.id == danju.hetong_zhifu_id,
                HetongZhifu.is_deleted == "N"
            ).first()
            
            if hetong_zhifu:
                hetong_zhifu.zhifu_zhuangtai = "paid"  # å·²æ”¯ä»˜
                hetong_zhifu.shiji_zhifu_shijian = datetime.now()
                
                # æ›´æ–°åˆåŒçŠ¶æ€ä¸ºå·²ç”Ÿæ•ˆ
                from models.hetong_guanli.hetong import Hetong
                hetong = self.db.query(Hetong).filter(
                    Hetong.id == hetong_zhifu.hetong_id,
                    Hetong.is_deleted == "N"
                ).first()
                
                if hetong and hetong.hetong_zhuangtai == "signed":
                    hetong.hetong_zhuangtai = "active"  # å·²ç”Ÿæ•ˆ
    else:
        # å®¡æ ¸æ‹’ç»
        danju.shenhe_zhuangtai = "rejected"
    
    danju.shenhe_ren_id = auditor_id
    danju.shenhe_shijian = datetime.now()
    danju.shenhe_yijian = audit_opinion
    
    self.db.commit()
    
    return {
        "success": True,
        "message": "å®¡æ ¸å®Œæˆ"
    }
```

## ğŸ“Š æµ‹è¯•æµç¨‹

### 1. åˆ›å»ºæµ‹è¯•æ•°æ®

1. è®¿é—®åˆåŒç­¾ç½²é¡µé¢ï¼š`http://localhost:5174/contract-sign/{token}`
2. å®Œæˆç­¾å
3. é€‰æ‹©"é“¶è¡Œè½¬è´¦"æ”¯ä»˜æ–¹å¼
4. ç‚¹å‡»"ç¡®è®¤ä½¿ç”¨é“¶è¡Œè½¬è´¦"

### 2. ä¸šåŠ¡å‘˜ä¸Šä¼ å‡­è¯

1. è®¿é—®ï¼š`http://localhost:5174/finance/bank-transfers`
2. æ‰¾åˆ°"å¾…ä¸Šä¼ å‡­è¯"çš„å•æ®
3. ç‚¹å‡»"ä¸Šä¼ å‡­è¯"
4. ä¸Šä¼ å›¾ç‰‡å¹¶æäº¤

### 3. è´¢åŠ¡å®¡æ ¸

1. è®¿é—®ï¼š`http://localhost:5174/audit/my-tasks`ï¼ˆå¾…å®ç°ï¼‰
2. æŸ¥çœ‹å¾…å®¡æ ¸çš„æ±‡æ¬¾å‡­è¯
3. ç‚¹å‡»"å®¡æ ¸"
4. é€‰æ‹©"é€šè¿‡"æˆ–"æ‹’ç»"
5. å¡«å†™å®¡æ ¸æ„è§
6. æäº¤å®¡æ ¸

### 4. éªŒè¯ç»“æœ

- å®¡æ ¸é€šè¿‡åï¼Œæ±‡æ¬¾å•æ®çŠ¶æ€åº”è¯¥å˜ä¸º"å·²é€šè¿‡"
- åˆåŒæ”¯ä»˜çŠ¶æ€åº”è¯¥å˜ä¸º"å·²æ”¯ä»˜"
- åˆåŒçŠ¶æ€åº”è¯¥å˜ä¸º"å·²ç”Ÿæ•ˆ"

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å®¡æ ¸ç±»å‹å¿…é¡»åŒ¹é…**ï¼šé…ç½®ä¸­çš„ `audit_type` å¿…é¡»æ˜¯ `yinhang_huikuan`
2. **å®¡æ ¸äººæƒé™**ï¼šç¡®ä¿å®¡æ ¸äººæœ‰ç›¸åº”çš„å®¡æ ¸æƒé™
3. **é€šçŸ¥æœºåˆ¶**ï¼šå»ºè®®é…ç½®å®¡æ ¸é€šçŸ¥ï¼ŒåŠæ—¶æé†’è´¢åŠ¡äººå‘˜å®¡æ ¸
4. **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿å®¡æ ¸æµç¨‹é…ç½®åŒ…å«å®Œæ•´çš„ `steps` æ•°ç»„

## ğŸš§ ä¸‹ä¸€æ­¥å·¥ä½œ

1. **é›†æˆåˆ°å®¡æ ¸ä»»åŠ¡åˆ—è¡¨** - è®©è´¢åŠ¡å¯ä»¥åœ¨"æˆ‘çš„å®¡æ ¸"ä¸­çœ‹åˆ°å¾…å®¡æ ¸çš„æ±‡æ¬¾å‡­è¯
2. **æ·»åŠ å®¡æ ¸è¯¦æƒ…é¡µé¢** - æ˜¾ç¤ºæ±‡æ¬¾å‡­è¯å›¾ç‰‡å’Œç›¸å…³ä¿¡æ¯
3. **æ·»åŠ é€šçŸ¥åŠŸèƒ½** - ä¸šåŠ¡å‘˜ä¸Šä¼ åé€šçŸ¥è´¢åŠ¡ï¼Œå®¡æ ¸å®Œæˆåé€šçŸ¥ä¸šåŠ¡å‘˜
4. **æ·»åŠ å®¡æ ¸å†å²** - è®°å½•æ‰€æœ‰å®¡æ ¸æ“ä½œçš„å†å²è®°å½•

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆçœ‹ä¸åˆ°å¾…å®¡æ ¸çš„æ±‡æ¬¾å‡­è¯ï¼Ÿ

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. å®¡æ ¸æµç¨‹é…ç½®æ˜¯å¦æ­£ç¡®åˆ›å»ºï¼ˆ`audit_type` å¿…é¡»æ˜¯ `yinhang_huikuan`ï¼‰
2. å®¡æ ¸æµç¨‹æ˜¯å¦å·²å¯ç”¨ï¼ˆ`shi_qiyong = 'Y'`ï¼‰
3. ä¸šåŠ¡å‘˜ä¸Šä¼ å‡­è¯åæ˜¯å¦æˆåŠŸè§¦å‘äº†å®¡æ ¸æµç¨‹
4. å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰å®¡æ ¸æƒé™

### Q2: å®¡æ ¸é€šè¿‡ååˆåŒçŠ¶æ€æ²¡æœ‰æ›´æ–°ï¼Ÿ

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š
1. `audit_voucher` æ–¹æ³•ä¸­æ˜¯å¦æ­£ç¡®æ›´æ–°äº†åˆåŒæ”¯ä»˜çŠ¶æ€
2. åˆåŒæ”¯ä»˜è®°å½•æ˜¯å¦å­˜åœ¨
3. æ•°æ®åº“äº‹åŠ¡æ˜¯å¦æ­£ç¡®æäº¤

### Q3: å¦‚ä½•ä¿®æ”¹å®¡æ ¸æµç¨‹ï¼Ÿ

**A**: 
1. è®¿é—®å®¡æ ¸æµç¨‹é…ç½®é¡µé¢
2. æ‰¾åˆ°"é“¶è¡Œæ±‡æ¬¾å‡­è¯å®¡æ ¸"æµç¨‹
3. ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®
4. ä¿®æ”¹æ­¥éª¤é…ç½®
5. ä¿å­˜

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-10-16  
**åˆ›å»ºäººå‘˜**: AI Assistant  
**çŠ¶æ€**: å¾…å®æ–½

