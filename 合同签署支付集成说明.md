# 合同签署支付功能集成说明

## 📋 概述

本次修改将合同签署页面的支付功能与支付管理模块进行了集成,实现了统一的支付配置管理。

## 🎯 修改目标

1. **移除硬编码**: 不再在合同签署页面中硬编码支付宝/微信的配置信息
2. **统一配置管理**: 使用支付管理模块中配置的支付方式
3. **动态支付选项**: 根据系统中已配置的支付方式动态显示可用选项
4. **配置复用**: 确保合同签署页面的支付流程与支付管理模块的配置保持一致

## 🔧 修改内容

### 后端修改

#### 1. 修改合同签署服务 (`packages/backend/src/services/hetong_guanli/hetong_sign_service.py`)

**修改点**: `initiate_payment` 方法

**主要变更**:
- 从支付配置表(`zhifu_peizhi`)中查找启用的支付配置
- 创建支付订单记录(`zhifu_dingdan`)
- 使用 `ZhifuApiService` 调用实际的支付接口
- 支持微信支付和支付宝的扫码支付(native)
- 银行转账保持原有逻辑

**关键代码**:
```python
# 根据支付方式查找对应的支付配置
payment_type_map = {
    "wechat": "weixin",
    "alipay": "zhifubao"
}

peizhi_leixing = payment_type_map.get(payment_request.payment_method)

# 查找启用的支付配置（优先使用生产环境配置）
zhifu_peizhi = self.db.query(ZhifuPeizhi).filter(
    ZhifuPeizhi.peizhi_leixing == peizhi_leixing,
    ZhifuPeizhi.zhuangtai == "qiyong",
    ZhifuPeizhi.is_deleted == "N"
).order_by(
    ZhifuPeizhi.huanjing.desc()
).first()

# 使用支付API服务创建支付
zhifu_api_service = ZhifuApiService(self.db)
payment_result = zhifu_api_service.create_payment(
    dingdan_id=zhifu_dingdan.id,
    zhifu_pingtai=peizhi_leixing,
    zhifu_fangshi="native"  # 扫码支付
)
```

#### 2. 新增API端点 (`packages/backend/src/api/api_v1/endpoints/hetong_guanli/hetong_sign.py`)

**新增接口**: `GET /contract-sign/sign/{sign_token}/available-payment-methods`

**功能**: 获取系统中已配置且启用的支付方式

**返回数据示例**:
```json
{
  "available_methods": [
    {
      "method": "wechat",
      "label": "微信支付",
      "icon": "wechat",
      "description": "使用微信扫码支付"
    },
    {
      "method": "alipay",
      "label": "支付宝",
      "icon": "alipay",
      "description": "使用支付宝扫码支付"
    },
    {
      "method": "bank",
      "label": "银行转账",
      "icon": "bank",
      "description": "通过银行转账支付"
    }
  ],
  "has_online_payment": true
}
```

### 前端修改

#### 1. 修改合同签署页面 (`packages/frontend/src/views/contract/CustomerSign.vue`)

**主要变更**:

1. **新增状态变量**:
   - `availablePaymentMethods`: 存储可用的支付方式列表
   - `loadingPaymentMethods`: 加载支付方式的loading状态

2. **新增方法**: `loadAvailablePaymentMethods()`
   - 调用新的API获取可用支付方式
   - 自动设置默认支付方式为第一个可用的在线支付方式
   - 如果加载失败,降级为仅显示银行转账

3. **修改支付方式选择UI**:
   - 从硬编码的3个选项改为动态渲染
   - 根据API返回的支付方式列表动态生成单选按钮
   - 显示支付方式的描述信息
   - 添加loading状态提示

## 📊 数据流程

```
合同签署页面加载
    ↓
调用 GET /contract-sign/sign/{token}/available-payment-methods
    ↓
查询 zhifu_peizhi 表(状态=启用)
    ↓
返回可用支付方式列表
    ↓
前端动态渲染支付选项
    ↓
用户选择支付方式并点击支付
    ↓
调用 POST /contract-sign/sign/{token}/pay
    ↓
查找对应的支付配置
    ↓
创建支付订单(zhifu_dingdan)
    ↓
调用 ZhifuApiService.create_payment()
    ↓
调用微信/支付宝支付接口
    ↓
返回支付二维码
```

## ✅ 优势

1. **配置统一**: 所有支付配置在支付管理模块中统一管理
2. **灵活性高**: 管理员可以随时启用/停用支付方式,无需修改代码
3. **安全性好**: 支付配置信息加密存储,不会暴露在前端代码中
4. **可维护性强**: 支付配置变更不需要修改合同签署页面代码
5. **用户体验好**: 只显示可用的支付方式,避免用户选择不可用的选项

## 🔍 测试要点

1. **支付配置管理**:
   - 在 `http://localhost:5174/payment/config` 创建微信支付配置
   - 在 `http://localhost:5174/payment/config` 创建支付宝配置
   - 测试启用/停用配置

2. **合同签署页面**:
   - 访问合同签署链接
   - 验证支付方式选项是否根据配置动态显示
   - 测试微信支付扫码
   - 测试支付宝扫码
   - 测试银行转账

3. **异常情况**:
   - 所有支付配置都停用时,应该只显示银行转账
   - 支付配置加载失败时,应该降级为银行转账
   - 选择的支付方式没有配置时,应该提示错误

## 📝 注意事项

1. **生产环境部署前**:
   - 确保在支付管理模块中配置了生产环境的支付宝和微信支付配置
   - 配置状态设置为"启用"
   - 环境设置为"生产"

2. **支付配置优先级**:
   - 系统优先使用"生产"环境的配置
   - 如果没有生产环境配置,会使用"沙箱"环境配置

3. **向后兼容**:
   - 银行转账始终可用,即使没有配置任何在线支付方式
   - 如果API调用失败,会降级为仅显示银行转账选项

## 🚀 部署步骤

1. 部署后端代码
2. 部署前端代码
3. 在支付管理页面配置微信支付和支付宝
4. 测试合同签署流程
5. 验证支付功能正常

## 📞 相关页面

- 支付配置管理: `http://localhost:5174/payment/config`
- 合同签署页面: `http://localhost:5174/contract-sign/{token}`
- 合同管理: `http://localhost:5174/contract/list`

