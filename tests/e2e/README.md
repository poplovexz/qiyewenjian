# 工单任务项分配功能 - Playwright 端到端测试

## 📋 测试说明

本测试使用 Playwright 自动化测试工具，完整验证工单任务项分配功能的前端UI交互流程。

### **测试目标**

验证用户能够通过前端界面将工单的每个任务项分配给不同的执行人。

### **测试账号**

- 用户名：`admin`
- 密码：`123456`

---

## 🚀 运行测试

### **前置条件**

1. **安装 Playwright**：

```bash
npm install -D @playwright/test
npx playwright install chromium
```

2. **启动后端服务**（端口：8000）：

```bash
cd packages/backend
source venv/bin/activate
python src/main.py
```

3. **启动前端服务**（端口：5174）：

```bash
cd packages/frontend
npm run dev
```

### **运行测试**

```bash
# 运行所有测试
npx playwright test

# 运行特定测试文件
npx playwright test tests/e2e/test_task_item_assignment.spec.ts

# 以调试模式运行
npx playwright test --debug

# 以UI模式运行（推荐）
npx playwright test --ui

# 显示浏览器窗口运行
npx playwright test --headed
```

### **查看测试报告**

```bash
# 查看HTML报告
npx playwright show-report

# 查看截图
ls -la screenshots/
```

---

## 📝 测试流程

### **第一步：登录系统**

- 访问登录页面：`http://localhost:5174/login`
- 输入用户名：`admin`
- 输入密码：`123456`
- 点击"登录"按钮
- **验证**：成功跳转到首页

### **第二步：导航到服务工单列表**

- 访问：`http://localhost:5174/service-orders`
- **验证**：工单列表页面加载成功

### **第三步：打开工单详情**

- 点击第一个工单的"查看"按钮
- **验证**：工单详情页面打开

### **第四步：查看任务项列表**

- 定位到"工单项目"卡片
- 读取所有任务项信息
- **验证**：任务项列表显示正确

### **第五步：打开分配对话框**

- 点击第一个任务项的"分配"按钮
- **验证**：分配对话框打开

### **第六步：选择执行人**

- 点击执行人下拉框
- 选择第一个执行人
- **验证**：执行人已选中

### **第七步：确认分配**

- 点击"确定"按钮
- **验证**：显示成功提示消息
- **验证**：对话框关闭

### **第八步：验证分配结果**

- 检查任务项列表
- **验证**：第一个任务项的执行人已更新

### **第九步：验证操作日志**

- 滚动到日志区域
- **验证**：存在任务分配日志

### **第十步：测试重新分配**

- 点击"重新分配"按钮
- 选择不同的执行人
- 确认分配
- **验证**：重新分配成功

---

## 📸 截图说明

测试过程中会自动保存以下截图：

1. `01-login-success.png` - 登录成功
2. `02-service-orders-list.png` - 服务工单列表
3. `03-service-order-detail.png` - 工单详情页面
4. `04-task-items-list.png` - 任务项列表
5. `05-assign-dialog-opened.png` - 分配对话框打开
6. `06-executor-selected.png` - 执行人已选择
7. `07-assignment-success.png` - 分配成功
8. `08-assignment-verified.png` - 分配结果验证
9. `09-operation-logs.png` - 操作日志
10. `10-reassignment-success.png` - 重新分配成功

---

## 🔍 测试验证点

### **UI验证**

- ✅ 任务项表格显示"执行人"列
- ✅ 任务项表格显示"分配"/"重新分配"按钮
- ✅ 分配对话框正确打开和关闭
- ✅ 执行人下拉框显示所有可选用户
- ✅ 分配成功后显示成功提示

### **数据验证**

- ✅ 分配后执行人信息正确显示
- ✅ 重新分配后执行人信息更新
- ✅ 操作日志记录分配操作

### **交互验证**

- ✅ 点击分配按钮打开对话框
- ✅ 选择执行人后可以确认
- ✅ 确认后对话框关闭
- ✅ 页面自动刷新显示最新数据

---

## 🐛 故障排查

### **测试失败常见原因**

1. **服务未启动**
   - 确保后端服务运行在 `http://localhost:8000`
   - 确保前端服务运行在 `http://localhost:5174`

2. **数据库未迁移**
   - 确保已执行数据库迁移，添加 `zhixing_ren_id` 字段

3. **没有工单数据**
   - 确保数据库中存在至少一个工单
   - 确保工单有任务项

4. **没有用户数据**
   - 确保数据库中存在多个用户
   - 确保用户状态为激活

5. **元素定位失败**
   - 检查前端UI是否有变化
   - 更新测试脚本中的选择器

### **调试技巧**

```bash
# 以调试模式运行，可以逐步执行
npx playwright test --debug

# 查看浏览器控制台日志
npx playwright test --headed

# 生成代码（录制操作）
npx playwright codegen http://localhost:5174
```

---

## 📊 预期结果

### **成功标准**

- ✅ 所有10个测试步骤执行成功
- ✅ 所有截图正常保存
- ✅ 控制台输出显示详细的测试过程
- ✅ 任务项成功分配给执行人
- ✅ 操作日志正确记录

### **测试输出示例**

```
================================================================================
开始测试：工单任务项分配功能
================================================================================

【步骤1】登录系统...
✅ 登录成功

【步骤2】导航到服务工单列表...
✅ 成功打开服务工单列表页面

【步骤3】查找并打开一个工单...
✅ 找到 5 个工单
✅ 成功打开工单详情页面

【步骤4】查看任务项列表...
✅ 找到 5 个任务项

任务项列表：
   1. 建账设置 - 执行人: 未分配
   2. 凭证录入 - 执行人: 未分配
   3. 账务处理 - 执行人: 未分配
   4. 报表编制 - 执行人: 未分配
   5. 纳税申报 - 执行人: 未分配

【步骤5】分配第一个任务项...
✅ 找到 5 个分配按钮
✅ 分配对话框已打开

【步骤6】选择执行人...
✅ 找到 5 个可选执行人
✅ 已选择执行人: 财务张三 (caiwu001)

【步骤7】确认分配...
✅ 分配成功提示已显示
✅ 分配对话框已关闭

【步骤8】验证分配结果...
✅ 第一个任务项已成功分配给: 财务张三

【步骤9】验证操作日志...
✅ 找到 1 条任务分配日志

【步骤10】测试重新分配功能...
✅ 找到"重新分配"按钮
✅ 重新分配对话框已打开
✅ 已选择新的执行人: 业务李四 (yewu001)
✅ 重新分配成功

================================================================================
✅ 测试完成！所有步骤执行成功
================================================================================
```

---

## 📚 相关文档

- [Playwright 官方文档](https://playwright.dev/)
- [功能实施文档](../../docs/task-item-assignment-feature.md)
- [API文档](../../packages/backend/docs/)

---

## 🎯 总结

本测试脚本提供了完整的端到端测试覆盖，验证了：

1. ✅ 用户登录流程
2. ✅ 工单列表和详情页面导航
3. ✅ 任务项分配对话框交互
4. ✅ 执行人选择和确认
5. ✅ 分配结果验证
6. ✅ 操作日志记录
7. ✅ 重新分配功能

通过运行此测试，可以确保工单任务项分配功能在前端UI层面完全正常工作。

