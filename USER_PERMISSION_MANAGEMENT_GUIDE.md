# 用户与权限管理完整指南

## 📋 目录

1. [问题1：用户列表无法显示 - 解决方案](#issue-1)
2. [问题2：权限管理详细操作手册](#issue-2)
3. [问题3：权限编码自动生成功能](#issue-3)

---

## <a name="issue-1"></a>问题1：用户列表无法显示 - 解决方案

### 🔍 问题诊断

**错误信息分析**：
```
Access to XMLHttpRequest at 'http://localhost:8000/api/v1/users/...' 
from origin 'http://localhost:5174' has been blocked by CORS policy
```

**实际原因**：
- ❌ 不是真正的CORS问题
- ✅ 是**认证问题** (403 Forbidden / Not authenticated)
- 用户未登录或登录已过期

### ✅ 解决步骤

#### 步骤1：登录系统

**访问登录页面**：
```
http://localhost:5174/login
```

**管理员账号**：
```
用户名：admin
密码：123456
```

**测试账号**：
```
业务员：salesperson1 / 123456
财务：finance1 / 123456
```

#### 步骤2：验证登录状态

登录成功后，浏览器会：
1. 存储 JWT Token 到 localStorage
2. 自动在后续请求中携带 Authorization 头
3. 可以正常访问需要认证的API

#### 步骤3：访问用户管理页面

**用户列表**：
```
http://localhost:5174/users
```

**用户角色管理**：
```
http://localhost:5174/user-roles
```

### 🔧 故障排除

#### 问题A：登录后仍然无法访问

**检查Token**：
1. 打开浏览器开发者工具 (F12)
2. 进入 Application → Local Storage
3. 查看是否有 `token` 或 `access_token`

**解决方案**：
- 如果没有token，重新登录
- 如果有token但仍然失败，清除缓存并重新登录

#### 问题B：Token过期

**症状**：
- 之前可以访问，现在突然无法访问
- 错误信息：401 Unauthorized

**解决方案**：
```javascript
// 清除过期token
localStorage.clear()
// 重新登录
window.location.href = '/login'
```

#### 问题C：CORS配置问题

**检查后端CORS配置**：
```bash
# 查看后端日志
tail -f /tmp/backend.log | grep CORS
```

**后端应该允许的源**：
- http://localhost:5174
- http://localhost:5173

---

## <a name="issue-2"></a>问题2：权限管理详细操作手册

### 📚 权限管理概述

权限管理是系统安全的核心，用于控制用户对系统资源的访问。

### 🎯 访问权限管理

**权限管理页面**：
```
http://localhost:5174/permissions
```

**前提条件**：
- 必须以管理员身份登录
- 需要有 `permission:read` 权限

### 📖 权限字段说明

#### 1. 权限名称 (quanxian_ming)
- **说明**：权限的中文名称，便于理解
- **示例**：
  - "查看用户列表"
  - "创建客户"
  - "删除合同"
- **规则**：
  - 必填
  - 2-50个字符
  - 应该清晰描述权限的作用

#### 2. 权限编码 (quanxian_bianma)
- **说明**：权限的唯一标识符，用于代码中的权限检查
- **格式**：`模块:操作`
- **示例**：
  - `user:read` - 查看用户
  - `user:create` - 创建用户
  - `customer:update` - 更新客户
  - `contract:delete` - 删除合同
- **规则**：
  - 必填
  - 2-100个字符
  - 只能包含字母、数字、冒号、下划线
  - 建议使用小写字母

#### 3. 资源类型 (ziyuan_leixing)
- **说明**：权限控制的资源类型
- **选项**：
  - **menu** (菜单)：控制菜单项的显示
  - **button** (按钮)：控制页面按钮的显示
  - **api** (接口)：控制API的访问
- **示例**：
  - 菜单权限：`menu:user_management` - 用户管理菜单
  - 按钮权限：`button:create_user` - 创建用户按钮
  - API权限：`api:get_users` - 获取用户列表API

#### 4. 资源路径 (ziyuan_lujing)
- **说明**：资源的具体路径
- **格式**：根据资源类型不同而不同
- **示例**：
  - 菜单：`/user-management` - 用户管理页面路径
  - 按钮：`#create-user-btn` - 按钮的DOM选择器
  - API：`/api/v1/users` - API端点路径
- **规则**：
  - 必填
  - 最多200个字符

#### 5. 权限描述 (miaoshu)
- **说明**：权限的详细说明
- **示例**：
  - "允许用户查看系统中所有用户的列表信息"
  - "允许用户创建新的客户记录"
- **规则**：
  - 可选
  - 最多200个字符

#### 6. 状态 (zhuangtai)
- **说明**：权限的启用状态
- **选项**：
  - **active** (启用)：权限生效
  - **inactive** (禁用)：权限不生效
- **默认值**：active

### 🔨 权限操作指南

#### 操作1：查看权限列表

1. **访问页面**：http://localhost:5174/permissions

2. **查看内容**：
   - 权限名称和编码
   - 资源类型（菜单/按钮/API）
   - 资源路径
   - 状态（启用/禁用）
   - 创建时间和更新时间

3. **筛选功能**：
   - 按权限名称或编码搜索
   - 按资源类型筛选
   - 按状态筛选

4. **排序功能**：
   - 点击列标题进行排序
   - 支持升序/降序

#### 操作2：创建新权限

1. **点击"新增权限"按钮**

2. **填写表单**：
   ```
   权限名称：查看用户列表
   权限编码：user:read (自动生成，可修改)
   资源类型：api
   资源路径：/api/v1/users
   权限描述：允许查看系统中所有用户的列表
   状态：启用
   ```

3. **点击"创建"按钮**

4. **验证结果**：
   - 成功提示："权限创建成功"
   - 列表中显示新创建的权限

#### 操作3：编辑权限

1. **在权限列表中找到要编辑的权限**

2. **点击"编辑"按钮**

3. **修改字段**：
   - 可以修改除权限编码外的所有字段
   - 权限编码一般不建议修改（会影响代码）

4. **点击"保存"按钮**

5. **验证结果**：
   - 成功提示："权限更新成功"
   - 列表中显示更新后的信息

#### 操作4：删除权限

1. **在权限列表中找到要删除的权限**

2. **点击"删除"按钮**

3. **确认删除**：
   - 弹出确认对话框
   - 提示："确定要删除权限"XXX"吗？此操作不可恢复。"

4. **点击"确定"**

5. **验证结果**：
   - 成功提示："权限删除成功"
   - 权限从列表中移除

**⚠️ 注意事项**：
- 删除权限前，确保没有角色正在使用该权限
- 删除系统核心权限可能导致功能异常
- 建议使用"禁用"而不是"删除"

#### 操作5：分配权限给角色

1. **访问角色管理页面**：http://localhost:5174/roles

2. **找到要分配权限的角色**

3. **点击"权限"按钮**

4. **在权限树中勾选权限**：
   - 支持树形结构展示
   - 支持批量选择
   - 支持搜索权限

5. **点击"保存"按钮**

6. **验证结果**：
   - 成功提示："角色权限更新成功"
   - 该角色的用户获得相应权限

### 📊 权限统计

**访问统计页面**：
```
http://localhost:5174/permissions/statistics
```

**统计内容**：
- 总权限数
- 菜单权限数
- 按钮权限数
- API权限数
- 启用权限数
- 禁用权限数
- 已分配给角色的权限数

### 🎨 权限最佳实践

#### 1. 命名规范

**权限编码格式**：
```
模块:操作[:子操作]
```

**示例**：
```
user:read           - 查看用户
user:create         - 创建用户
user:update         - 更新用户
user:delete         - 删除用户
user:status:manage  - 管理用户状态
```

#### 2. 权限粒度

**粗粒度**（推荐用于菜单）：
```
user_management     - 用户管理模块
customer_management - 客户管理模块
```

**细粒度**（推荐用于API和按钮）：
```
user:read           - 查看用户
user:create         - 创建用户
customer:export     - 导出客户
```

#### 3. 权限分组

**按模块分组**：
```
用户管理：
  - user:read
  - user:create
  - user:update
  - user:delete

客户管理：
  - customer:read
  - customer:create
  - customer:update
  - customer:delete
```

#### 4. 权限继承

**角色权限设计**：
```
管理员：所有权限
业务员：客户管理 + 线索管理 + 报价管理
财务：合同管理 + 支付管理
```

### 🔐 权限检查示例

#### 前端权限检查

**在模板中**：
```vue
<el-button 
  v-if="hasPermission('user:create')"
  @click="handleCreate"
>
  创建用户
</el-button>
```

**在脚本中**：
```typescript
import { hasPermission } from '@/utils/permissions'

if (hasPermission('user:delete')) {
  // 执行删除操作
}
```

#### 后端权限检查

```python
from src.core.security import require_permission

@router.get("/users")
@require_permission("user:read")
async def get_users():
    # 获取用户列表
    pass
```

---

## 常见问题 FAQ

### Q1: 如何查看我有哪些权限？
A: 登录后，访问"个人中心"页面，可以看到您的角色和权限列表。

### Q2: 为什么我看不到某个菜单？
A: 可能是您的角色没有该菜单的权限。请联系管理员分配相应权限。

### Q3: 权限编码可以修改吗？
A: 技术上可以，但不建议修改。权限编码在代码中被引用，修改后需要同步更新代码。

### Q4: 删除权限会影响已登录的用户吗？
A: 会。删除权限后，拥有该权限的用户将立即失去相应的访问能力。

### Q5: 如何批量创建权限？
A: 可以使用权限管理工具页面的"快速创建"功能，或通过API批量导入。

---

**文档版本**：v1.0  
**最后更新**：2025-10-13  
**下一步**：实现权限编码自动生成功能

