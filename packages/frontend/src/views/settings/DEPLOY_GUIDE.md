# Web界面一键部署指南

## 📌 重要提醒

**以后所有部署都应该使用Web界面的一键部署功能，不要使用命令行部署脚本！**

Web界面部署的优势：
- ✅ 可视化操作，更直观
- ✅ 实时查看部署日志
- ✅ 自动记录部署历史
- ✅ 支持部署状态监控
- ✅ 支持一键回滚
- ✅ **自动运行admin权限配置脚本**

---

## 🚀 如何使用Web界面部署

### 1. 访问部署页面

在浏览器中打开：
- **开发环境**: http://localhost:5174/settings/deploy
- **生产环境**: http://172.16.2.221/settings/deploy

### 2. 配置部署环境（首次使用）

如果是首次使用，需要先配置部署环境：

1. 点击「配置管理」标签
2. 点击「新建配置」按钮
3. 填写配置信息：
   - **环境名称**: production（生产环境）
   - **服务器IP**: 172.16.2.221
   - **SSH端口**: 22
   - **SSH用户名**: saas
   - **SSH密码**: Pop781216
   - **部署目录**: /home/saas/proxy-system
   - **后端端口**: 8000
   - **前端端口**: 5174
4. 点击「保存」

### 3. 触发部署

1. 在「部署管理」标签中
2. 选择部署环境（production）
3. 选择Git分支（通常是main或当前分支）
4. 填写部署说明（可选，建议填写本次部署的主要内容）
5. 点击「开始部署」按钮

### 4. 监控部署进度

部署开始后，页面会自动显示：
- ✅ 部署状态（pending → running → success/failed）
- ✅ 实时日志输出
- ✅ 部署进度（步骤1/8, 2/8, ...）
- ✅ 部署耗时

### 5. 查看部署历史

在「部署历史」标签中可以：
- 查看所有历史部署记录
- 查看每次部署的详细日志
- 查看部署状态和耗时
- 一键回滚到之前的成功版本

---

## 🔧 部署流程说明

Web界面部署会自动执行以下步骤：

### 步骤1: 构建前端
- 运行 `npm run build:prod`
- 生成优化后的生产环境代码

### 步骤2: 打包项目
- 打包后端代码、前端dist、部署脚本
- 排除不必要的文件（node_modules, venv, .git等）

### 步骤3: 上传到服务器
- 通过SSH上传打包文件到生产服务器

### 步骤4: 服务器部署
- 备份旧版本
- 解压新版本
- 恢复.env配置文件
- 安装Python依赖

### 步骤5: 检查配置
- 验证.env文件存在
- 检查必要的配置项

### 步骤6: 数据库迁移和权限配置 ⭐
- 检查并创建必要的数据库表
- **运行 `ensure_admin_permissions.py` 脚本**
- **确保admin用户拥有所有权限**
- 初始化必要的权限和数据

### 步骤7: 重启服务
- 停止旧的后端服务
- 启动新的后端服务（4个worker进程）

### 步骤8: 验证部署
- 检查服务健康状态
- 验证API是否正常响应

---

## ⚠️ 重要注意事项

### 1. admin权限自动配置

**每次部署都会自动运行 `ensure_admin_permissions.py` 脚本**，确保：
- ✅ admin用户存在
- ✅ 系统管理员角色存在
- ✅ admin用户被分配了系统管理员角色
- ✅ 系统管理员角色拥有所有权限
- ✅ 新增的权限会自动分配给admin

**部署后需要重新登录**：
- 权限信息缓存在JWT token中
- 部署后admin用户的权限可能已更新
- 必须退出登录并重新登录才能获取新权限

### 2. 配置文件保护

部署过程会自动保护以下文件：
- `.env` - 环境配置文件
- `uploads/` - 上传的文件
- `logs/` - 日志文件

这些文件不会被覆盖，确保数据安全。

### 3. 自动备份

每次部署前会自动备份旧版本到：
```
/home/saas/proxy-system/backup-YYYYMMDD-HHMMSS/
```

如果部署失败，可以手动恢复备份。

### 4. 回滚功能

如果部署后发现问题，可以：
1. 在「部署历史」中找到上一个成功的部署
2. 点击「回滚」按钮
3. 系统会自动部署到该版本

---

## 🐛 故障排查

### 问题1: 部署失败，提示"前端构建失败"

**原因**: 前端代码有TypeScript错误或依赖问题

**解决方案**:
1. 在本地运行 `npm run build:prod` 检查错误
2. 修复错误后重新部署
3. 或者勾选「跳过构建步骤」（不推荐）

### 问题2: 部署成功但功能无法使用

**原因**: 可能是权限问题或需要重新登录

**解决方案**:
1. **退出登录并重新登录**（最常见）
2. 检查浏览器控制台是否有错误
3. 检查后端日志：`ssh saas@172.16.2.221 'tail -50 /home/saas/proxy-system/logs/backend.log'`

### 问题3: admin用户没有权限

**原因**: 虽然部署脚本会自动配置，但可能失败

**解决方案**:
1. SSH登录到服务器
2. 手动运行权限配置脚本：
```bash
cd /home/saas/proxy-system/packages/backend
source venv/bin/activate
export PYTHONPATH=/home/saas/proxy-system/packages/backend/src
cd src
python3 scripts/ensure_admin_permissions.py
```
3. 退出登录并重新登录

### 问题4: 部署卡住不动

**原因**: 可能是网络问题或服务器资源不足

**解决方案**:
1. 等待5-10分钟
2. 如果仍然卡住，点击「取消部署」
3. 检查服务器状态
4. 重新触发部署

---

## 📊 部署最佳实践

### 1. 部署前检查

- ✅ 确保本地代码已提交到Git
- ✅ 确保本地测试通过
- ✅ 确保数据库迁移脚本已准备好
- ✅ 通知团队即将部署

### 2. 部署时机

- ✅ 选择业务低峰期部署
- ✅ 避免在工作时间部署重大更新
- ✅ 准备好回滚方案

### 3. 部署后验证

- ✅ 检查部署日志，确认所有步骤成功
- ✅ 访问生产环境，测试关键功能
- ✅ 检查后端日志，确认没有错误
- ✅ 通知团队部署完成

### 4. 部署说明规范

建议在部署说明中包含：
- 本次部署的主要功能或修复
- 是否有数据库变更
- 是否需要用户重新登录
- 是否有配置文件变更

示例：
```
修复报销申请功能，添加admin权限自动配置
- 修复新建报销申请按钮无效的问题
- 添加ensure_admin_permissions.py脚本
- 更新所有部署脚本
- 需要重新登录以获取新权限
```

---

## 🔐 安全提醒

1. **SSH密码**: 部署配置中的SSH密码会加密存储（TODO），但仍需谨慎保管
2. **部署权限**: 只有管理员可以触发部署
3. **日志安全**: 部署日志可能包含敏感信息，注意保护
4. **配置备份**: 定期备份.env配置文件

---

## 📝 相关文件

- **前端页面**: `packages/frontend/src/views/settings/Deploy.vue`
- **后端API**: `packages/backend/src/api/api_v1/endpoints/deploy/deploy.py`
- **部署服务**: `packages/backend/src/services/deploy/deploy_service.py`
- **部署脚本**: `quick-deploy.sh`, `deploy-to-production.sh`, `auto-deploy.sh`
- **权限脚本**: `packages/backend/src/scripts/ensure_admin_permissions.py`

---

## 🎯 总结

使用Web界面部署的关键优势：
1. ✅ **自动化**: 一键完成所有部署步骤
2. ✅ **可视化**: 实时查看部署进度和日志
3. ✅ **可追溯**: 完整的部署历史记录
4. ✅ **可回滚**: 快速回滚到之前的版本
5. ✅ **权限保障**: 自动配置admin权限，避免权限问题

**请记住：以后所有部署都使用Web界面，不要使用命令行脚本！**

