# 准备测试数据 - Playwright 测试前置条件

## ⚠️ 重要提示

在运行 Playwright 测试之前，**必须确保系统中有至少一个服务工单**。

---

## 🎯 快速准备测试数据

### **方法1：从合同创建工单（推荐）**

这是最完整的测试流程，可以验证从产品步骤加载任务项的功能。

#### **步骤1：创建线索**

1. 访问：http://localhost:5174/leads
2. 点击"新增线索"按钮
3. 填写信息：
   - 选择客户：任意现有客户
   - 线索来源：任意
   - 其他必填字段
4. 点击"确定"保存

#### **步骤2：创建报价**

1. 在线索列表中，找到刚创建的线索
2. 点击"报价"按钮
3. 填写报价信息：
   - 报价名称：测试报价
   - 有效期：任意日期
4. 添加产品：
   - 点击"添加产品"
   - 选择产品：**公司改制（内转外/外转内）** （产品代码：zengzhi_1_2）
   - 数量：1
   - 单价：任意
5. 点击"确定"保存

#### **步骤3：创建合同**

1. 访问：http://localhost:5174/contracts
2. 点击"新增合同"按钮
3. 填写合同信息：
   - 选择客户：与线索相同的客户
   - 合同名称：测试合同
   - 合同金额：任意
   - **关联报价**：选择刚创建的报价
   - 签订日期：今天
   - 生效日期：今天
   - 到期日期：未来某个日期
4. 点击"确定"保存

#### **步骤4：从合同创建工单**

1. 在合同列表中，找到刚创建的合同
2. 点击"操作" -> "创建工单"
3. 选择服务类型：**增值服务**
4. 填写工单信息：
   - 工单标题：测试工单 - 公司改制
   - 计划完成时间：未来某个日期
   - 优先级：中
5. 点击"确定"创建

**验证**：
- 工单应该包含6个任务项（从产品步骤加载）：
  1. 工商核名
  2. 网报签字
  3. 领取执照
  4. 客户交接
  5. 开立基本户
  6. 税务登记

---

### **方法2：直接创建工单（快速）**

如果只是想快速测试任务项分配功能，可以直接创建工单。

#### **步骤：**

1. 访问：http://localhost:5174/service-orders
2. 点击"创建工单"按钮
3. 填写工单信息：
   - 选择客户：任意现有客户
   - 工单标题：测试工单
   - 服务类型：代理记账 或 增值服务
   - 计划完成时间：未来某个日期
   - 优先级：中
4. 点击"确定"创建

**注意**：
- 直接创建的工单会使用默认的任务模板（4个任务项）
- 无法测试从产品步骤加载任务项的功能

---

### **方法3：使用数据库脚本（最快）**

如果您有数据库访问权限，可以直接插入测试数据。

```sql
-- 检查是否有工单
SELECT COUNT(*) FROM fuwu_gongdan WHERE is_deleted = 'N';

-- 如果没有工单，可以从现有合同创建
-- 查找一个合同
SELECT id, hetong_bianhao, kehu_id FROM hetong WHERE is_deleted = 'N' LIMIT 1;

-- 使用后端API创建工单（推荐使用前端界面）
```

---

## ✅ 验证测试数据

### **检查工单是否存在**

1. 访问：http://localhost:5174/service-orders
2. 确认列表中至少有一个工单
3. 点击"查看"按钮，打开工单详情
4. 确认工单有任务项列表

### **检查任务项**

在工单详情页面，应该看到：
- 任务项列表（至少有1个任务项）
- 每个任务项有"分配"或"重新分配"按钮
- 执行人列显示"未分配"或已分配的执行人

---

## 🚀 运行测试

数据准备完成后，运行测试：

**Linux**:
```bash
./run-task-assignment-test.sh
```

**Windows**:
```cmd
run-task-assignment-test.bat --ui
```

---

## 📊 测试数据要求

### **最小要求**

- ✅ 至少1个客户
- ✅ 至少1个服务工单
- ✅ 工单至少有1个任务项
- ✅ 至少2个用户（用于测试分配和重新分配）

### **推荐配置**

- ✅ 1个客户
- ✅ 1个线索
- ✅ 1个报价（包含"公司改制"产品）
- ✅ 1个合同（关联报价）
- ✅ 1个增值服务工单（从合同创建，包含6个任务项）
- ✅ 3-5个用户（不同角色）

---

## 🐛 常见问题

### **Q1: 没有客户怎么办？**

**A**: 先创建客户

1. 访问：http://localhost:5174/customers
2. 点击"新增客户"
3. 填写客户信息
4. 保存

### **Q2: 没有用户怎么办？**

**A**: 先创建用户

1. 访问：http://localhost:5174/users
2. 点击"新增用户"
3. 填写用户信息
4. 保存

### **Q3: 找不到"公司改制"产品？**

**A**: 检查产品是否存在

1. 访问：http://localhost:5174/products
2. 搜索产品代码：zengzhi_1_2
3. 如果不存在，创建该产品或选择其他有步骤的产品

### **Q4: 工单没有任务项？**

**A**: 可能的原因：

1. 工单创建失败
2. 产品没有步骤
3. 合同没有关联报价

**解决方法**：
- 删除工单，重新从合同创建
- 确保合同关联了包含产品步骤的报价

---

## 📝 测试数据清单

在运行测试前，请确认以下数据已准备：

- [ ] 至少1个客户
- [ ] 至少1个服务工单
- [ ] 工单至少有1个任务项
- [ ] 至少2个用户
- [ ] 后端服务运行在 http://localhost:8000
- [ ] 前端服务运行在 http://localhost:5174

---

## 🎯 总结

**最快的准备方法**：

1. 确保有客户和用户
2. 访问 http://localhost:5174/service-orders
3. 点击"创建工单"
4. 填写信息并保存
5. 运行测试

**最完整的准备方法**：

1. 创建线索
2. 创建报价（包含"公司改制"产品）
3. 创建合同（关联报价）
4. 从合同创建工单
5. 运行测试

---

**文档创建时间**: 2025年11月5日  
**适用测试**: Playwright 端到端测试  
**测试脚本**: `tests/e2e/test_task_item_assignment.spec.ts`

