# 支付配置说明文档

## 📋 支付宝配置字段说明

### 1. 支付宝网关 (zhifubao_wangguan)

**作用**: 指定支付宝API的网关地址,用于发送支付请求。

**配置值**:
- **沙箱环境**: `https://openapi-sandbox.dl.alipaydev.com/gateway.do`
- **生产环境**: `https://openapi.alipay.com/gateway.do`

**说明**: 
- 沙箱环境用于开发测试,不会产生真实交易
- 生产环境用于正式上线,会产生真实交易
- 这个字段现在已经添加到配置表单中

---

## 🔔 回调通知URL (tongzhi_url)

### 作用

回调通知URL是支付宝/微信支付在**支付成功后**主动通知我们系统的地址。

### 工作流程

```
用户扫码支付
    ↓
支付成功
    ↓
支付宝/微信服务器 → 向我们的回调URL发送POST请求
    ↓
我们的系统接收通知 → 验证签名 → 更新订单状态
    ↓
返回success给支付平台
```

### 回调URL格式

系统已经自动为你生成了默认的回调URL:

**支付宝回调**: `http://localhost:8000/api/v1/public/payment-callback/zhifubao/notify`

**微信回调**: `http://localhost:8000/api/v1/public/payment-callback/weixin/notify`

### 本地开发环境配置

#### 问题
本地开发环境使用 `localhost` 或 `127.0.0.1`,支付宝/微信服务器无法访问到你的本地机器。

#### 解决方案

有以下几种方式:

#### 方案1: 使用内网穿透工具 (推荐用于本地测试)

使用 **ngrok** 或 **frp** 等工具将本地服务暴露到公网:

1. **安装 ngrok**:
   ```bash
   # 访问 https://ngrok.com/ 下载并安装
   ```

2. **启动内网穿透**:
   ```bash
   ngrok http 8000
   ```

3. **获取公网URL**:
   ```
   Forwarding: https://abc123.ngrok.io -> http://localhost:8000
   ```

4. **配置回调URL**:
   ```
   https://abc123.ngrok.io/api/v1/public/payment-callback/zhifubao/notify
   ```

#### 方案2: 使用测试服务器

将代码部署到有公网IP的测试服务器(如你的生产服务器 172.16.2.221):

**回调URL**:
```
http://172.16.2.221:8000/api/v1/public/payment-callback/zhifubao/notify
```

或者如果配置了域名:
```
http://your-domain.com/api/v1/public/payment-callback/zhifubao/notify
```

#### 方案3: 本地测试时暂时留空

在本地开发环境测试时:
- 回调URL可以暂时留空或填写默认值
- 支付二维码可以正常生成
- 用户可以扫码支付
- **但是**: 支付成功后,系统不会收到回调通知,订单状态不会自动更新
- 你需要手动在数据库中更新订单状态,或者通过管理后台手动确认

### 生产环境配置

生产环境必须配置正确的回调URL:

**示例** (假设你的域名是 example.com):
```
https://example.com/api/v1/public/payment-callback/zhifubao/notify
```

**注意事项**:
1. ✅ 必须使用 **HTTPS** (生产环境)
2. ✅ 域名必须是**公网可访问**的
3. ✅ 确保防火墙允许支付宝/微信服务器访问
4. ✅ 回调接口必须在**5秒内**返回响应

---

## 🧪 沙箱测试配置示例

### 完整配置

```
配置名称: 支付宝沙箱环境
配置类型: 支付宝
环境: 沙箱
状态: 启用

支付宝APPID: 9021000157698401
支付宝网关: https://openapi-sandbox.dl.alipaydev.com/gateway.do
应用私钥: [你的RSA2私钥]
支付宝公钥: [支付宝提供的公钥]

回调通知URL: 
- 本地测试: 留空或使用 ngrok 生成的公网URL
- 测试服务器: http://172.16.2.221:8000/api/v1/public/payment-callback/zhifubao/notify

备注: 支付宝沙箱测试环境
```

---

## 📝 常见问题

### Q1: 回调URL必须填写吗?

**A**: 
- **本地开发测试**: 可以暂时留空,但支付成功后不会自动更新订单状态
- **生产环境**: **必须填写**,否则无法接收支付成功通知

### Q2: 本地测试时如何验证支付流程?

**A**: 有两种方式:
1. 使用 ngrok 等工具暴露本地服务到公网
2. 手动在数据库中更新订单状态来模拟支付成功

### Q3: 回调URL填错了会怎样?

**A**: 
- 支付二维码可以正常生成
- 用户可以扫码支付
- 但系统收不到支付成功通知
- 订单状态不会自动更新为"已支付"

### Q4: 如何测试回调是否正常?

**A**: 
1. 配置正确的回调URL
2. 完成一笔测试支付
3. 查看后端日志,确认收到回调请求
4. 检查订单状态是否更新为"已支付"

---

## 🚀 快速开始

### 本地开发环境 (使用ngrok)

1. **启动后端服务**:
   ```bash
   cd /var/www/packages/backend
   ./start.sh
   ```

2. **启动ngrok**:
   ```bash
   ngrok http 8000
   ```

3. **配置支付宝沙箱**:
   - 访问: `http://localhost:5174/finance/payment-configs`
   - 填写配置信息
   - 回调URL使用ngrok生成的公网地址

4. **测试支付**:
   - 创建合同并生成签署链接
   - 完成签署并选择支付宝支付
   - 使用沙箱钱包扫码支付
   - 查看订单状态是否自动更新

### 测试服务器环境

1. **配置支付宝沙箱**:
   - 访问: `http://172.16.2.221/finance/payment-configs`
   - 填写配置信息
   - 回调URL: `http://172.16.2.221:8000/api/v1/public/payment-callback/zhifubao/notify`

2. **测试支付**:
   - 创建合同并生成签署链接
   - 完成签署并选择支付宝支付
   - 使用沙箱钱包扫码支付
   - 查看订单状态是否自动更新

---

## ✅ 总结

1. **支付宝网关字段已添加** - 现在可以在配置表单中看到并填写
2. **回调URL的作用** - 接收支付成功通知,自动更新订单状态
3. **本地测试建议** - 使用ngrok或在测试服务器上测试
4. **生产环境要求** - 必须配置正确的HTTPS回调URL

现在你可以刷新页面,重新填写支付宝沙箱配置了! 🎉

