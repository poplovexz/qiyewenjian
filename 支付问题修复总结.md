# 支付问题修复总结

## 修复内容

### 1. 修复合同签署支付主体关联

**问题描述**：
- 合同签署时创建支付订单，但没有关联合同的乙方主体(yifang_zhuti_id)和支付方式(zhifu_fangshi_id)
- 支付的乙方需要是合同的乙方，但之前没有这个关联

**修复方案**：
- 修改 `packages/backend/src/services/hetong_guanli/hetong_sign_service.py`
  - 在 `initiate_payment` 方法中添加乙方主体检查
  - 如果合同没有设置乙方主体，返回错误提示："合同未设置乙方主体，无法支付，请联系业务员"
  - 优先查找该乙方主体关联的支付配置（通过 `hetong_zhifu_fangshi` 表）
  - 如果没有找到乙方主体关联的支付配置，则使用全局启用的支付配置
  - 在创建支付订单时关联乙方主体ID和支付方式ID

**代码变更**：
```python
# 检查合同是否有乙方主体
if not hetong.yifang_zhuti_id:
    raise HTTPException(status_code=400, detail="合同未设置乙方主体，无法支付，请联系业务员")

# 优先查找该乙方主体关联的支付配置
zhifu_fangshi = self.db.query(HetongZhifuFangshi).join(
    ZhifuPeizhi, HetongZhifuFangshi.zhifu_peizhi_id == ZhifuPeizhi.id
).filter(
    HetongZhifuFangshi.yifang_zhuti_id == hetong.yifang_zhuti_id,
    HetongZhifuFangshi.zhifu_zhuangtai == "active",
    ZhifuPeizhi.peizhi_leixing == peizhi_leixing,
    ZhifuPeizhi.zhuangtai == "qiyong"
).first()

# 创建支付订单，关联乙方主体和支付方式
zhifu_dingdan = ZhifuDingdan(
    hetong_id=hetong.id,
    kehu_id=hetong.kehu_id,
    yifang_zhuti_id=hetong.yifang_zhuti_id,  # 关联乙方主体
    zhifu_fangshi_id=zhifu_fangshi_id,  # 关联支付方式（如果有）
    ...
)
```

### 2. 修复获取可用支付方式API

**问题描述**：
- 之前只返回系统中所有启用的支付方式，没有考虑合同乙方主体的支付配置

**修复方案**：
- 修改 `packages/backend/src/api/api_v1/endpoints/hetong_guanli/hetong_sign.py`
- 在 `get_available_payment_methods` 方法中：
  - 如果合同有乙方主体，优先查找该主体关联的支付方式
  - 如果没有找到，则返回系统中所有启用的支付方式

### 3. 修复财务仪表板数据源

**问题描述**：
- 财务仪表板使用模拟数据，与支付订单页面数据不匹配

**修复方案**：
- 修改 `packages/frontend/src/views/finance/FinanceDashboard.vue`
- 使用真实的支付订单统计API：`/payment-orders/statistics`
- 使用真实的支付订单列表API：`/payment-orders/`

### 4. 修复支付记录页面数据源

**问题描述**：
- 支付记录页面使用模拟数据，与支付订单页面数据不匹配

**修复方案**：
- 修改 `packages/frontend/src/views/finance/PaymentRecordList.vue`
- 使用真实的支付流水列表API：`/payment-records/`
- 使用真实的财务确认API：`/payment-records/{id}/confirm`

### 5. 删除无关代码

**修复内容**：
- 删除财务仪表板和支付记录页面中的模拟数据代码
- 保留功能提示的TODO注释（如"跳转到编辑页面"等）

## 使用说明

### 1. 设置合同乙方主体

在创建或编辑合同时，必须设置乙方主体：
- 访问合同管理页面
- 创建或编辑合同
- 在"乙方主体"字段中选择一个已创建的乙方主体

### 2. 配置乙方主体的支付方式

为乙方主体配置支付方式（可选，如果不配置则使用全局支付配置）：
- 访问乙方主体管理页面
- 选择一个乙方主体
- 添加支付方式，关联到支付配置

### 3. 测试支付功能

1. 生成合同签署链接
2. 访问签署链接
3. 签署合同
4. 选择支付方式（只会显示该乙方主体关联的支付方式）
5. 完成支付

## 数据库表关系

```
hetong (合同表)
  └─ yifang_zhuti_id → hetong_yifang_zhuti (乙方主体表)
                          └─ hetong_zhifu_fangshi (支付方式表)
                               └─ zhifu_peizhi_id → zhifu_peizhi (支付配置表)

zhifu_dingdan (支付订单表)
  ├─ hetong_id → hetong
  ├─ yifang_zhuti_id → hetong_yifang_zhuti
  ├─ zhifu_fangshi_id → hetong_zhifu_fangshi
  └─ zhifu_peizhi_id → zhifu_peizhi
```

## 注意事项

1. **合同必须设置乙方主体**：如果合同没有设置乙方主体，支付时会返回错误提示
2. **支付配置优先级**：优先使用乙方主体关联的支付配置，如果没有则使用全局启用的支付配置
3. **数据一致性**：财务仪表板、支付记录、支付订单三个页面现在使用相同的数据源，数据保持一致

## 测试建议

1. 创建一个乙方主体
2. 为该乙方主体配置支付方式（关联到支付配置）
3. 创建一个合同，设置该乙方主体
4. 生成签署链接并测试支付流程
5. 检查财务仪表板、支付记录、支付订单页面的数据是否一致

