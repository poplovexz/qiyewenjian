# å®¡æ ¸è§„åˆ™è®¾ç½®å®Œæ•´æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [å®¡æ ¸è§„åˆ™æ•°æ®ç»“æ„](#å®¡æ ¸è§„åˆ™æ•°æ®ç»“æ„)
2. [é€šè¿‡å‰ç«¯é¡µé¢è®¾ç½®](#é€šè¿‡å‰ç«¯é¡µé¢è®¾ç½®)
3. [é€šè¿‡æ•°æ®åº“ç›´æ¥è®¾ç½®](#é€šè¿‡æ•°æ®åº“ç›´æ¥è®¾ç½®)
4. [å¸¸è§å®¡æ ¸è§„åˆ™ç¤ºä¾‹](#å¸¸è§å®¡æ ¸è§„åˆ™ç¤ºä¾‹)
5. [å®¡æ ¸è§„åˆ™å­—æ®µè¯´æ˜](#å®¡æ ¸è§„åˆ™å­—æ®µè¯´æ˜)

---

## å®¡æ ¸è§„åˆ™æ•°æ®ç»“æ„

### æ•°æ®åº“è¡¨ï¼š`shenhe_guize`

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| `id` | String(36) | è§„åˆ™ID | UUID |
| `guize_mingcheng` | String(200) | è§„åˆ™åç§° | "é“¶è¡Œæ±‡æ¬¾å‡­è¯å®¡æ ¸" |
| `guize_leixing` | String(50) | è§„åˆ™ç±»å‹ | "workflow_template" |
| `chufa_tiaojian` | Text (JSON) | è§¦å‘æ¡ä»¶é…ç½® | è§ä¸‹æ–‡ |
| `shenhe_liucheng_peizhi` | Text (JSON) | å®¡æ ¸æµç¨‹é…ç½® | è§ä¸‹æ–‡ |
| `shi_qiyong` | String(1) | æ˜¯å¦å¯ç”¨ | "Y" æˆ– "N" |
| `paixu` | Integer | æ’åºå·ï¼ˆè¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰ | 0, 1, 2... |
| `guize_miaoshu` | Text | è§„åˆ™æè¿° | "è´¢åŠ¡äººå‘˜å®¡æ ¸é“¶è¡Œæ±‡æ¬¾å‡­è¯" |

---

## é€šè¿‡å‰ç«¯é¡µé¢è®¾ç½®

### æ­¥éª¤1ï¼šè®¿é—®å®¡æ ¸è§„åˆ™é…ç½®é¡µé¢

**é¡µé¢åœ°å€**ï¼š`http://localhost:5174/audit/rule-config`

**å¯¼èˆªè·¯å¾„**ï¼š
```
ä¸»èœå• â†’ å®¡æ ¸ç®¡ç† â†’ å®¡æ ¸è§„åˆ™é…ç½®
```

---

### æ­¥éª¤2ï¼šåˆ›å»ºæ–°è§„åˆ™

1. **ç‚¹å‡»"æ–°å»ºè§„åˆ™"æŒ‰é’®**

2. **å¡«å†™åŸºæœ¬ä¿¡æ¯**ï¼š

   | å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
   |------|------|------|
   | è§„åˆ™åç§° | è§„åˆ™çš„åç§° | "é“¶è¡Œæ±‡æ¬¾å‡­è¯å®¡æ ¸" |
   | è§„åˆ™ç±»å‹ | é€‰æ‹©è§„åˆ™ç±»å‹ | "workflow_template" |
   | è§„åˆ™æè¿° | ç®€è¦è¯´æ˜ | "è´¢åŠ¡äººå‘˜å®¡æ ¸é“¶è¡Œæ±‡æ¬¾å‡­è¯" |
   | è§„åˆ™çŠ¶æ€ | å¯ç”¨/ç¦ç”¨ | "å¯ç”¨" |

3. **é…ç½®è§¦å‘æ¡ä»¶**ï¼š

   æ ¹æ®è§„åˆ™ç±»å‹é€‰æ‹©ä¸åŒçš„è§¦å‘æ¡ä»¶ï¼š

   **å·¥ä½œæµæ¨¡æ¿ç±»å‹**ï¼ˆ`workflow_template`ï¼‰ï¼š
   ```json
   {
     "type": "workflow_template",
     "audit_type": "yinhang_huikuan"
   }
   ```

   **åˆåŒé‡‘é¢ä¿®æ­£ç±»å‹**ï¼ˆ`hetong_jine_xiuzheng`ï¼‰ï¼š
   ```json
   {
     "type": "amount_decrease",
     "min_percentage": 5,
     "max_percentage": 100
   }
   ```

4. **é…ç½®å®¡æ ¸æµç¨‹**ï¼š

   ```json
   {
     "steps": [
       {
         "step": 1,
         "name": "è´¢åŠ¡å®¡æ ¸",
         "approver_user_id": "0b2b6bfb-9092-446b-9cc3-6ae4c045bf03",
         "approver_role": "caiwu",
         "expected_time": 24,
         "is_required": true,
         "description": "è´¢åŠ¡äººå‘˜å®¡æ ¸æ±‡æ¬¾å‡­è¯"
       }
     ]
   }
   ```

5. **ä¿å­˜è§„åˆ™**

---

## é€šè¿‡æ•°æ®åº“ç›´æ¥è®¾ç½®

### æ–¹æ³•1ï¼šä½¿ç”¨Pythonè„šæœ¬

åˆ›å»ºä¸€ä¸ªPythonè„šæœ¬æ¥è®¾ç½®å®¡æ ¸è§„åˆ™ï¼š

```python
import sys
import os
sys.path.insert(0, 'packages/backend/src')

from core.database import SessionLocal
from models.shenhe_guanli.shenhe_guize import ShenheGuize
import uuid
import json
from datetime import datetime

session = SessionLocal()

# åˆ›å»ºå®¡æ ¸è§„åˆ™
guize = ShenheGuize(
    id=str(uuid.uuid4()),
    guize_mingcheng="é“¶è¡Œæ±‡æ¬¾å‡­è¯å®¡æ ¸",
    guize_leixing="workflow_template",
    chufa_tiaojian=json.dumps({
        "type": "workflow_template",
        "audit_type": "yinhang_huikuan"
    }),
    shenhe_liucheng_peizhi=json.dumps({
        "steps": [{
            "step": 1,
            "name": "è´¢åŠ¡å®¡æ ¸",
            "approver_user_id": "0b2b6bfb-9092-446b-9cc3-6ae4c045bf03",
            "approver_role": "caiwu",
            "expected_time": 24,
            "is_required": True
        }]
    }),
    shi_qiyong="Y",
    paixu=0,
    guize_miaoshu="è´¢åŠ¡äººå‘˜å®¡æ ¸é“¶è¡Œæ±‡æ¬¾å‡­è¯",
    created_by="system",
    updated_by="system",
    created_at=datetime.now(),
    updated_at=datetime.now(),
    is_deleted="N"
)

session.add(guize)
session.commit()
print(f"âœ… å®¡æ ¸è§„åˆ™åˆ›å»ºæˆåŠŸï¼ŒID: {guize.id}")
session.close()
```

---

### æ–¹æ³•2ï¼šç›´æ¥æ‰§è¡ŒSQL

```sql
INSERT INTO shenhe_guize (
    id,
    guize_mingcheng,
    guize_leixing,
    chufa_tiaojian,
    shenhe_liucheng_peizhi,
    shi_qiyong,
    paixu,
    guize_miaoshu,
    created_by,
    updated_by,
    created_at,
    updated_at,
    is_deleted
) VALUES (
    gen_random_uuid(),
    'é“¶è¡Œæ±‡æ¬¾å‡­è¯å®¡æ ¸',
    'workflow_template',
    '{"type": "workflow_template", "audit_type": "yinhang_huikuan"}',
    '{"steps": [{"step": 1, "name": "è´¢åŠ¡å®¡æ ¸", "approver_user_id": "0b2b6bfb-9092-446b-9cc3-6ae4c045bf03", "approver_role": "caiwu", "expected_time": 24, "is_required": true}]}',
    'Y',
    0,
    'è´¢åŠ¡äººå‘˜å®¡æ ¸é“¶è¡Œæ±‡æ¬¾å‡­è¯',
    'system',
    'system',
    NOW(),
    NOW(),
    'N'
);
```

---

## å¸¸è§å®¡æ ¸è§„åˆ™ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šé“¶è¡Œæ±‡æ¬¾å‡­è¯å®¡æ ¸

```json
{
  "guize_mingcheng": "é“¶è¡Œæ±‡æ¬¾å‡­è¯å®¡æ ¸",
  "guize_leixing": "workflow_template",
  "chufa_tiaojian": {
    "type": "workflow_template",
    "audit_type": "yinhang_huikuan"
  },
  "shenhe_liucheng_peizhi": {
    "steps": [
      {
        "step": 1,
        "name": "è´¢åŠ¡å®¡æ ¸",
        "approver_user_id": "0b2b6bfb-9092-446b-9cc3-6ae4c045bf03",
        "approver_role": "caiwu",
        "expected_time": 24,
        "is_required": true
      }
    ]
  },
  "shi_qiyong": "Y",
  "paixu": 0
}
```

---

### ç¤ºä¾‹2ï¼šåˆåŒé‡‘é¢ä¿®æ­£å®¡æ ¸ï¼ˆé™ä»·5%ä»¥ä¸Šï¼‰

```json
{
  "guize_mingcheng": "åˆåŒé‡‘é¢é™ä»·5%å®¡æ ¸",
  "guize_leixing": "hetong_jine_xiuzheng",
  "chufa_tiaojian": {
    "type": "amount_decrease",
    "min_percentage": 5,
    "max_percentage": 100
  },
  "shenhe_liucheng_peizhi": {
    "steps": [
      {
        "step": 1,
        "name": "ä¸»ç®¡å®¡æ ¸",
        "approver_role": "supervisor",
        "expected_time": 24,
        "is_required": true
      }
    ]
  },
  "shi_qiyong": "Y",
  "paixu": 1
}
```

---

### ç¤ºä¾‹3ï¼šå¤šçº§å®¡æ ¸æµç¨‹

```json
{
  "guize_mingcheng": "å¤§é¢åˆåŒå®¡æ ¸",
  "guize_leixing": "workflow_template",
  "chufa_tiaojian": {
    "type": "workflow_template",
    "audit_type": "dae_hetong"
  },
  "shenhe_liucheng_peizhi": {
    "steps": [
      {
        "step": 1,
        "name": "éƒ¨é—¨ä¸»ç®¡å®¡æ ¸",
        "approver_role": "supervisor",
        "expected_time": 24,
        "is_required": true
      },
      {
        "step": 2,
        "name": "è´¢åŠ¡å®¡æ ¸",
        "approver_role": "caiwu",
        "expected_time": 24,
        "is_required": true
      },
      {
        "step": 3,
        "name": "æ€»ç»ç†å®¡æ ¸",
        "approver_role": "manager",
        "expected_time": 48,
        "is_required": true
      }
    ]
  },
  "shi_qiyong": "Y",
  "paixu": 0
}
```

---

## å®¡æ ¸è§„åˆ™å­—æ®µè¯´æ˜

### 1. è§„åˆ™ç±»å‹ï¼ˆ`guize_leixing`ï¼‰

| ç±»å‹å€¼ | è¯´æ˜ | ç”¨é€” |
|--------|------|------|
| `workflow_template` | å·¥ä½œæµæ¨¡æ¿ | é€šç”¨å®¡æ ¸æµç¨‹ï¼Œé€šè¿‡ `audit_type` åŒ¹é… |
| `hetong_jine_xiuzheng` | åˆåŒé‡‘é¢ä¿®æ­£ | åˆåŒé‡‘é¢å˜æ›´å®¡æ ¸ |
| `baojia_shenhe` | æŠ¥ä»·å®¡æ ¸ | æŠ¥ä»·å•å®¡æ ¸ |
| `amount_change` | é‡‘é¢å˜æ›´ | é€šç”¨é‡‘é¢å˜æ›´å®¡æ ¸ |
| `discount_rate` | æŠ˜æ‰£ç‡ | æŠ˜æ‰£å®¡æ ¸ |

---

### 2. è§¦å‘æ¡ä»¶ï¼ˆ`chufa_tiaojian`ï¼‰

#### å·¥ä½œæµæ¨¡æ¿ç±»å‹

```json
{
  "type": "workflow_template",
  "audit_type": "yinhang_huikuan"  // å®¡æ ¸ç±»å‹æ ‡è¯†
}
```

**å¸¸è§ `audit_type` å€¼**ï¼š
- `yinhang_huikuan`ï¼šé“¶è¡Œæ±‡æ¬¾
- `hetong_jine_xiuzheng`ï¼šåˆåŒé‡‘é¢ä¿®æ­£
- `baojia_shenhe`ï¼šæŠ¥ä»·å®¡æ ¸
- `dae_hetong`ï¼šå¤§é¢åˆåŒ

---

#### é‡‘é¢å˜æ›´ç±»å‹

```json
{
  "type": "amount_decrease",  // æˆ– "amount_increase"
  "min_percentage": 5,        // æœ€å°ç™¾åˆ†æ¯”
  "max_percentage": 100,      // æœ€å¤§ç™¾åˆ†æ¯”
  "min_amount": 1000,         // æœ€å°é‡‘é¢ï¼ˆå¯é€‰ï¼‰
  "max_amount": 999999        // æœ€å¤§é‡‘é¢ï¼ˆå¯é€‰ï¼‰
}
```

---

### 3. å®¡æ ¸æµç¨‹é…ç½®ï¼ˆ`shenhe_liucheng_peizhi`ï¼‰

```json
{
  "steps": [
    {
      "step": 1,                    // æ­¥éª¤ç¼–å·
      "name": "è´¢åŠ¡å®¡æ ¸",            // æ­¥éª¤åç§°
      "approver_user_id": "UUID",   // å®¡æ ¸äººç”¨æˆ·IDï¼ˆä¼˜å…ˆï¼‰
      "approver_role": "caiwu",     // å®¡æ ¸äººè§’è‰²ï¼ˆå¤‡é€‰ï¼‰
      "expected_time": 24,          // é¢„æœŸå¤„ç†æ—¶é—´ï¼ˆå°æ—¶ï¼‰
      "is_required": true,          // æ˜¯å¦å¿…é¡»
      "description": "å®¡æ ¸è¯´æ˜",     // æ­¥éª¤è¯´æ˜ï¼ˆå¯é€‰ï¼‰
      "condition": "amount > 1000"  // æ¡ä»¶è¡¨è¾¾å¼ï¼ˆå¯é€‰ï¼‰
    }
  ]
}
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `step` | Integer | æ˜¯ | æ­¥éª¤ç¼–å·ï¼Œä»1å¼€å§‹ |
| `name` | String | æ˜¯ | æ­¥éª¤åç§° |
| `approver_user_id` | String | å¦ | å®¡æ ¸äººç”¨æˆ·IDï¼ˆä¼˜å…ˆä½¿ç”¨ï¼‰ |
| `approver_role` | String | å¦ | å®¡æ ¸äººè§’è‰²ï¼ˆå½“user_idä¸ºç©ºæ—¶ä½¿ç”¨ï¼‰ |
| `expected_time` | Integer | å¦ | é¢„æœŸå¤„ç†æ—¶é—´ï¼ˆå°æ—¶ï¼‰ï¼Œé»˜è®¤24 |
| `is_required` | Boolean | å¦ | æ˜¯å¦å¿…é¡»ï¼Œé»˜è®¤true |
| `description` | String | å¦ | æ­¥éª¤è¯´æ˜ |
| `condition` | String | å¦ | æ¡ä»¶è¡¨è¾¾å¼ï¼Œæ»¡è¶³æ¡ä»¶æ‰æ‰§è¡Œæ­¤æ­¥éª¤ |

---

### 4. å®¡æ ¸äººé…ç½®ä¼˜å…ˆçº§

ç³»ç»ŸæŸ¥æ‰¾å®¡æ ¸äººçš„ä¼˜å…ˆçº§ï¼š

1. **`approver_user_id`**ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
   - ç›´æ¥æŒ‡å®šç”¨æˆ·ID
   - ä¾‹å¦‚ï¼š`"0b2b6bfb-9092-446b-9cc3-6ae4c045bf03"`

2. **`approver_role`**ï¼ˆæ¬¡ä¼˜å…ˆçº§ï¼‰
   - æ ¹æ®è§’è‰²æŸ¥æ‰¾ç”¨æˆ·
   - ç³»ç»Ÿä¼šæŸ¥æ‰¾è¯¥è§’è‰²çš„ç¬¬ä¸€ä¸ªç”¨æˆ·
   - ä¾‹å¦‚ï¼š`"caiwu"` â†’ æŸ¥æ‰¾è´¢åŠ¡è§’è‰²çš„ç”¨æˆ·

3. **å¦‚æœéƒ½ä¸ºç©º**
   - å®¡æ ¸æµç¨‹åˆ›å»ºå¤±è´¥
   - éœ€è¦é…ç½®è‡³å°‘ä¸€ä¸ª

---

## ä¿®æ”¹ç°æœ‰å®¡æ ¸è§„åˆ™

### æ–¹æ³•1ï¼šé€šè¿‡å‰ç«¯é¡µé¢

1. è®¿é—®å®¡æ ¸è§„åˆ™é…ç½®é¡µé¢
2. æ‰¾åˆ°è¦ä¿®æ”¹çš„è§„åˆ™
3. ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®
4. ä¿®æ”¹é…ç½®
5. ä¿å­˜

---

### æ–¹æ³•2ï¼šé€šè¿‡SQLæ›´æ–°

```sql
UPDATE shenhe_guize 
SET shenhe_liucheng_peizhi = '{
  "steps": [{
    "step": 1,
    "name": "è´¢åŠ¡å®¡æ ¸",
    "approver_user_id": "æ–°çš„ç”¨æˆ·ID",
    "approver_role": "caiwu",
    "expected_time": 24,
    "is_required": true
  }]
}'::jsonb,
updated_at = NOW(),
updated_by = 'admin'
WHERE id = 'è§„åˆ™ID';
```

---

## æŸ¥è¯¢å®¡æ ¸è§„åˆ™

### æŸ¥è¯¢æ‰€æœ‰å¯ç”¨çš„è§„åˆ™

```sql
SELECT 
    id,
    guize_mingcheng,
    guize_leixing,
    chufa_tiaojian,
    shenhe_liucheng_peizhi,
    shi_qiyong,
    paixu
FROM shenhe_guize
WHERE shi_qiyong = 'Y'
AND is_deleted = 'N'
ORDER BY paixu;
```

---

### æŸ¥è¯¢ç‰¹å®šç±»å‹çš„è§„åˆ™

```sql
SELECT *
FROM shenhe_guize
WHERE guize_leixing = 'workflow_template'
AND chufa_tiaojian::jsonb->>'audit_type' = 'yinhang_huikuan'
AND shi_qiyong = 'Y'
AND is_deleted = 'N';
```

---

## å¸¸è§é—®é¢˜

### Q1ï¼šå¦‚ä½•çŸ¥é“å®¡æ ¸äººçš„ç”¨æˆ·IDï¼Ÿ

**æ–¹æ³•1ï¼šæŸ¥è¯¢æ•°æ®åº“**
```sql
SELECT id, yonghu_ming, xingming
FROM yonghu
WHERE is_deleted = 'N'
ORDER BY created_at;
```

**æ–¹æ³•2ï¼šé€šè¿‡è§’è‰²æŸ¥è¯¢**
```sql
SELECT y.id, y.yonghu_ming, y.xingming, j.jiaose_ming
FROM yonghu y
JOIN yonghu_jiaose yj ON y.id = yj.yonghu_id
JOIN jiaose j ON yj.jiaose_id = j.id
WHERE j.jiaose_bianma = 'caiwu'
AND y.is_deleted = 'N'
AND yj.is_deleted = 'N';
```

---

### Q2ï¼šå¦‚ä½•æµ‹è¯•å®¡æ ¸è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆï¼Ÿ

1. è§¦å‘ç›¸åº”çš„ä¸šåŠ¡æ“ä½œï¼ˆå¦‚ä¸Šä¼ é“¶è¡Œæ±‡æ¬¾å‡­è¯ï¼‰
2. æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†å®¡æ ¸æµç¨‹ï¼š
   ```sql
   SELECT * FROM shenhe_liucheng 
   WHERE shenhe_leixing = 'yinhang_huikuan'
   ORDER BY created_at DESC LIMIT 1;
   ```
3. æ£€æŸ¥æ˜¯å¦å‘é€äº†é€šçŸ¥ï¼š
   ```sql
   SELECT * FROM zhifu_tongzhi 
   WHERE tongzhi_leixing = 'audit_pending'
   ORDER BY fasong_shijian DESC LIMIT 1;
   ```

---

### Q3ï¼šå¤šä¸ªè§„åˆ™åŒ¹é…æ—¶å¦‚ä½•é€‰æ‹©ï¼Ÿ

ç³»ç»ŸæŒ‰ç…§ `paixu` å­—æ®µæ’åºï¼Œé€‰æ‹©**æ’åºå·æœ€å°**çš„è§„åˆ™ã€‚

å»ºè®®ï¼š
- æ›´å…·ä½“çš„è§„åˆ™è®¾ç½®æ›´å°çš„æ’åºå·
- é€šç”¨è§„åˆ™è®¾ç½®æ›´å¤§çš„æ’åºå·

---

## æ€»ç»“

å®¡æ ¸è§„åˆ™è®¾ç½®çš„å…³é”®ç‚¹ï¼š

1. âœ… **è§„åˆ™ç±»å‹**ï¼šé€‰æ‹©åˆé€‚çš„ `guize_leixing`
2. âœ… **è§¦å‘æ¡ä»¶**ï¼šé…ç½®æ­£ç¡®çš„ `chufa_tiaojian`
3. âœ… **å®¡æ ¸æµç¨‹**ï¼šé…ç½®å®Œæ•´çš„ `shenhe_liucheng_peizhi`
4. âœ… **å®¡æ ¸äºº**ï¼šå¿…é¡»é…ç½® `approver_user_id` æˆ– `approver_role`
5. âœ… **å¯ç”¨çŠ¶æ€**ï¼šè®¾ç½® `shi_qiyong = 'Y'`
6. âœ… **æ’åºä¼˜å…ˆçº§**ï¼šè®¾ç½®åˆé€‚çš„ `paixu` å€¼

---

**æœ€åæ›´æ–°**ï¼š2025-10-31  
**ç‰ˆæœ¬**ï¼šv1.0

