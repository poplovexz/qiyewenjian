# 一键启动脚本完成说明

## ✅ 已创建的脚本

### 1. 全栈服务管理脚本

#### `start_all.sh` - 一键启动所有服务
**功能：**
- 自动检查并启动 PostgreSQL 数据库
- 自动检查并启动 Redis 缓存服务
- 清理旧的进程（避免端口冲突）
- 启动后端 API 服务（端口 8000）
- 启动前端开发服务器（端口 5174）
- 执行健康检查确保服务正常运行
- 显示服务状态总览

**使用方法：**
```bash
cd /var/www
./start_all.sh
```

#### `stop_all.sh` - 一键停止所有服务
**功能：**
- 优雅地停止后端服务
- 优雅地停止前端服务
- 清理所有相关进程
- 释放端口 8000 和 5174
- 显示端口释放状态

**使用方法：**
```bash
./stop_all.sh
```

### 2. 后端服务管理脚本

#### `start_backend_all.sh` - 一键启动后端服务
**功能：**
- 检查并启动 PostgreSQL（必需）
- 检查并启动 Redis（可选，失败时降级为无缓存模式）
- 检查 Python 虚拟环境
- 检查环境变量配置文件
- 清理旧的后端进程
- 启动后端 API 服务（端口 8000）
- 执行健康检查（最多重试 10 次）
- 显示服务状态和访问地址

**使用方法：**
```bash
./start_backend_all.sh
```

#### `stop_backend_all.sh` - 一键停止后端服务
**功能：**
- 优雅地停止后端服务（先 SIGTERM，再 SIGKILL）
- 清理 uvicorn 进程
- 释放端口 8000
- 显示停止状态

**使用方法：**
```bash
./stop_backend_all.sh
```

#### `status_backend.sh` - 查看服务状态
**功能：**
- 显示系统服务状态（PostgreSQL、Redis）
- 显示应用服务状态（后端 API）
- 检查数据库连接和大小
- 检查 Redis 连接和键数量
- 显示最近的日志（最后 10 行）
- 显示访问地址
- 显示常用命令

**使用方法：**
```bash
./status_backend.sh
```

## 📁 文件列表

```
/var/www/
├── start_all.sh                    # 启动所有服务（前端+后端）
├── stop_all.sh                     # 停止所有服务
├── start_backend_all.sh            # 启动后端服务
├── stop_backend_all.sh             # 停止后端服务
├── status_backend.sh               # 查看服务状态
├── BACKEND_SCRIPTS_README.md       # 详细使用文档
└── 快速启动指南.md                  # 快速入门指南
```

## 🎯 使用场景

### 场景 1: 每天开始工作（推荐）
```bash
cd /var/www
./start_all.sh
```
访问 http://localhost:5174 开始开发

### 场景 2: 只需要后端服务
```bash
./start_backend_all.sh
```
访问 http://localhost:8000/docs 查看 API 文档

### 场景 3: 检查服务状态
```bash
./status_backend.sh
```

### 场景 4: 重启服务
```bash
./stop_all.sh && ./start_all.sh
```

### 场景 5: 查看日志
```bash
# 后端日志
tail -f /tmp/backend_8000.log

# 前端日志
tail -f /tmp/frontend_5174.log
```

## 🔧 技术特性

### 1. 智能服务检查
- 自动检测服务是否已运行
- 避免重复启动
- 自动清理旧进程

### 2. 健康检查
- 后端服务启动后自动执行健康检查
- 最多重试 10 次，每次间隔 2 秒
- 确保服务真正可用才返回成功

### 3. 优雅停止
- 先发送 SIGTERM 信号（优雅停止）
- 等待 2 秒
- 如果进程仍在运行，发送 SIGKILL（强制停止）

### 4. 容错机制
- PostgreSQL 启动失败会终止脚本（必需服务）
- Redis 启动失败只会警告（可选服务）
- 后端会自动降级为无缓存模式

### 5. 彩色输出
- 🔵 蓝色：信息提示
- 🟢 绿色：成功消息
- 🟡 黄色：警告信息
- 🔴 红色：错误消息

## 📊 服务端口

| 服务 | 端口 | 说明 |
|------|------|------|
| 前端应用 | 5174 | Vue 3 开发服务器 |
| 后端 API | 8000 | FastAPI 服务 |
| PostgreSQL | 5432 | 数据库服务 |
| Redis | 6379 | 缓存服务 |

## 📝 日志文件

| 服务 | 日志文件 | 查看命令 |
|------|---------|---------|
| 后端 API | `/tmp/backend_8000.log` | `tail -f /tmp/backend_8000.log` |
| 前端应用 | `/tmp/frontend_5174.log` | `tail -f /tmp/frontend_5174.log` |
| PostgreSQL | 系统日志 | `sudo journalctl -u postgresql@16-main.service -f` |
| Redis | 系统日志 | `sudo journalctl -u redis-server.service -f` |

## 🌐 访问地址

### 前端
- **应用首页**: http://localhost:5174
- **登录页面**: http://localhost:5174/login

### 后端
- **API 服务**: http://localhost:8000
- **API 文档**: http://localhost:8000/docs
- **健康检查**: http://localhost:8000/health
- **OpenAPI 规范**: http://localhost:8000/api/v1/openapi.json

## ⚠️ 注意事项

### 1. 首次使用
确保已配置环境变量文件：
```bash
cd /var/www/packages/backend
cp .env.example .env
vim .env  # 编辑配置
```

### 2. 虚拟环境
确保后端虚拟环境已创建：
```bash
cd /var/www/packages/backend
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 3. 前端依赖
确保前端依赖已安装：
```bash
cd /var/www/packages/frontend
pnpm install
```

### 4. 权限问题
如果遇到权限问题，可能需要使用 sudo：
```bash
sudo ./start_all.sh
```

### 5. 端口冲突
如果端口被占用，先停止旧服务：
```bash
./stop_all.sh
```

## 🚀 快速命令参考

```bash
# 启动所有服务
./start_all.sh

# 停止所有服务
./stop_all.sh

# 查看服务状态
./status_backend.sh

# 重启所有服务
./stop_all.sh && ./start_all.sh

# 只启动后端
./start_backend_all.sh

# 只停止后端
./stop_backend_all.sh

# 查看后端日志
tail -f /tmp/backend_8000.log

# 查看前端日志
tail -f /tmp/frontend_5174.log
```

## 📖 更多文档

- **详细使用文档**: [BACKEND_SCRIPTS_README.md](BACKEND_SCRIPTS_README.md)
- **快速入门**: [快速启动指南.md](快速启动指南.md)
- **项目 README**: [README.md](README.md)

## ✨ 特点总结

1. **一键操作** - 无需记忆复杂命令
2. **智能检查** - 自动检测服务状态
3. **健康验证** - 确保服务真正可用
4. **友好输出** - 彩色提示，清晰易读
5. **容错处理** - 优雅处理各种异常情况
6. **完整日志** - 所有输出都记录到日志文件
7. **状态监控** - 随时查看服务运行状态
8. **快速重启** - 一行命令完成重启

## 🎉 总结

现在你可以使用以下命令快速启动整个项目：

```bash
cd /var/www
./start_all.sh
```

然后在浏览器中打开 http://localhost:5174 就可以开始使用了！

如果遇到任何问题，请查看：
1. 日志文件：`tail -f /tmp/backend_8000.log`
2. 服务状态：`./status_backend.sh`
3. 详细文档：`BACKEND_SCRIPTS_README.md`

