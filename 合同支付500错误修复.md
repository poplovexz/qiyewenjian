# åˆåŒæ”¯ä»˜500é”™è¯¯ä¿®å¤æŠ¥å‘Š

## ğŸ› é”™è¯¯ä¿¡æ¯

```
TypeError: 'shiji_zhifu_jine' is an invalid keyword argument for ZhifuDingdan
```

**é”™è¯¯ä½ç½®**: `packages/backend/src/services/hetong_guanli/hetong_sign_service.py:302`

**è§¦å‘åœºæ™¯**: å®¢æˆ·åœ¨åˆåŒç­¾ç½²é¡µé¢ç‚¹å‡»"æ”¯ä»˜å®æ”¯ä»˜"æŒ‰é’®æ—¶

---

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

åœ¨åˆ›å»ºæ”¯ä»˜è®¢å• (`ZhifuDingdan`) æ—¶,ä½¿ç”¨äº†**é”™è¯¯çš„å­—æ®µå**å’Œ**ç¼ºå°‘å¿…å¡«å­—æ®µ**:

#### é”™è¯¯1: å­—æ®µåæ‹¼å†™é”™è¯¯
```python
# âŒ é”™è¯¯çš„å­—æ®µå
shiji_zhifu_jine=Decimal("0")

# âœ… æ­£ç¡®çš„å­—æ®µå
shifu_jine=Decimal("0")
```

#### é”™è¯¯2: ç¼ºå°‘å¿…å¡«å­—æ®µ
æ ¹æ® `ZhifuDingdan` æ¨¡å‹å®šä¹‰,ä»¥ä¸‹å­—æ®µæ˜¯å¿…å¡«çš„ä½†åœ¨åˆ›å»ºæ—¶ç¼ºå¤±:
- `hetong_id` - åˆåŒID
- `kehu_id` - å®¢æˆ·ID
- `dingdan_jine` - è®¢å•é‡‘é¢
- `zhifu_leixing` - æ”¯ä»˜ç±»å‹
- `chuangjian_shijian` - åˆ›å»ºæ—¶é—´

#### é”™è¯¯3: çŠ¶æ€å€¼ä¸è§„èŒƒ
```python
# âŒ ä½¿ç”¨äº†éæ ‡å‡†çŠ¶æ€å€¼
zhifu_zhuangtai="daifukuan"

# âœ… åº”è¯¥ä½¿ç”¨æ ‡å‡†çŠ¶æ€å€¼
zhifu_zhuangtai="pending"
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ä»£ç 

**æ–‡ä»¶**: `packages/backend/src/services/hetong_guanli/hetong_sign_service.py`

**ä¿®å¤å‰** (ç¬¬296-306è¡Œ):
```python
# åˆ›å»ºæ”¯ä»˜è®¢å•
zhifu_dingdan = ZhifuDingdan(
    dingdan_bianhao=f"HT{hetong.hetong_bianhao}_{datetime.now().strftime('%Y%m%d%H%M%S')}",
    dingdan_mingcheng=f"åˆåŒæ”¯ä»˜-{hetong.hetong_mingcheng}",
    dingdan_miaoshu=f"åˆåŒç¼–å·ï¼š{hetong.hetong_bianhao}",
    yingfu_jine=Decimal(str(payment_request.payment_amount)),
    shiji_zhifu_jine=Decimal("0"),  # âŒ é”™è¯¯çš„å­—æ®µå
    zhifu_zhuangtai="daifukuan",    # âŒ éæ ‡å‡†çŠ¶æ€å€¼
    zhifu_peizhi_id=zhifu_peizhi.id,
    created_by=hetong.created_by or "system"
    # âŒ ç¼ºå°‘å¿…å¡«å­—æ®µ: hetong_id, kehu_id, dingdan_jine, zhifu_leixing, chuangjian_shijian
)
```

**ä¿®å¤å**:
```python
# åˆ›å»ºæ”¯ä»˜è®¢å•
zhifu_dingdan = ZhifuDingdan(
    hetong_id=hetong.id,                                    # âœ… æ·»åŠ åˆåŒID
    kehu_id=hetong.kehu_id,                                 # âœ… æ·»åŠ å®¢æˆ·ID
    dingdan_bianhao=f"HT{hetong.hetong_bianhao}_{datetime.now().strftime('%Y%m%d%H%M%S')}",
    dingdan_mingcheng=f"åˆåŒæ”¯ä»˜-{hetong.hetong_mingcheng}",
    dingdan_miaoshu=f"åˆåŒç¼–å·ï¼š{hetong.hetong_bianhao}",
    dingdan_jine=Decimal(str(payment_request.payment_amount)),  # âœ… æ·»åŠ è®¢å•é‡‘é¢
    yingfu_jine=Decimal(str(payment_request.payment_amount)),
    shifu_jine=Decimal("0"),                                # âœ… ä¿®æ­£å­—æ®µå
    zhifu_leixing=peizhi_leixing,                          # âœ… æ·»åŠ æ”¯ä»˜ç±»å‹
    zhifu_zhuangtai="pending",                             # âœ… ä½¿ç”¨æ ‡å‡†çŠ¶æ€å€¼
    zhifu_peizhi_id=zhifu_peizhi.id,
    chuangjian_shijian=datetime.now(),                     # âœ… æ·»åŠ åˆ›å»ºæ—¶é—´
    created_by=hetong.created_by or "system"
)
```

---

## ğŸ“‹ å­—æ®µè¯´æ˜

### ZhifuDingdan æ¨¡å‹å¿…å¡«å­—æ®µ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | æ˜¯å¦å¿…å¡« |
|--------|------|------|----------|
| `hetong_id` | String(36) | åˆåŒID | âœ… æ˜¯ |
| `kehu_id` | String(36) | å®¢æˆ·ID | âœ… æ˜¯ |
| `dingdan_bianhao` | String(50) | è®¢å•ç¼–å· | âœ… æ˜¯ |
| `dingdan_mingcheng` | String(200) | è®¢å•åç§° | âœ… æ˜¯ |
| `dingdan_jine` | Numeric(10,2) | è®¢å•é‡‘é¢ | âœ… æ˜¯ |
| `yingfu_jine` | Numeric(10,2) | åº”ä»˜é‡‘é¢ | âœ… æ˜¯ |
| `shifu_jine` | Numeric(10,2) | å®ä»˜é‡‘é¢ | âŒ å¦ (é»˜è®¤0.00) |
| `zhifu_leixing` | String(50) | æ”¯ä»˜ç±»å‹ | âœ… æ˜¯ |
| `zhifu_zhuangtai` | String(20) | æ”¯ä»˜çŠ¶æ€ | âŒ å¦ (é»˜è®¤pending) |
| `chuangjian_shijian` | DateTime | åˆ›å»ºæ—¶é—´ | âœ… æ˜¯ |

### æ”¯ä»˜çŠ¶æ€æ ‡å‡†å€¼

| çŠ¶æ€å€¼ | è¯´æ˜ |
|--------|------|
| `pending` | å¾…æ”¯ä»˜ |
| `paying` | æ”¯ä»˜ä¸­ |
| `paid` | å·²æ”¯ä»˜ |
| `failed` | æ”¯ä»˜å¤±è´¥ |
| `cancelled` | å·²å–æ¶ˆ |
| `refunded` | å·²é€€æ¬¾ |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **è®¿é—®åˆåŒç­¾ç½²é¡µé¢**:
   ```
   http://localhost:5174/contract-sign/eebc3a3b-e806-4f63-92c3-6daee932850b
   ```

2. **å®ŒæˆåˆåŒç­¾ç½²**:
   - å¡«å†™ç­¾ç½²ä¿¡æ¯
   - ç‚¹å‡»"ç¡®è®¤ç­¾ç½²"

3. **å‘èµ·æ”¯ä»˜**:
   - é€‰æ‹©"æ”¯ä»˜å®æ”¯ä»˜"
   - ç‚¹å‡»"ç«‹å³æ”¯ä»˜"

4. **é¢„æœŸç»“æœ**:
   - âœ… ä¸å†å‡ºç°500é”™è¯¯
   - âœ… æˆåŠŸç”Ÿæˆæ”¯ä»˜äºŒç»´ç 
   - âœ… è¿”å›æ”¯ä»˜è®¢å•ä¿¡æ¯

---

## ğŸ“Š å½±å“èŒƒå›´

### å—å½±å“åŠŸèƒ½
- âœ… åˆåŒç­¾ç½²åçš„æ”¯ä»˜å®æ”¯ä»˜
- âœ… åˆåŒç­¾ç½²åçš„å¾®ä¿¡æ”¯ä»˜
- âœ… æ‰€æœ‰é€šè¿‡ç­¾ç½²é¡µé¢å‘èµ·çš„æ”¯ä»˜

### ä¸å—å½±å“
- åå°ç®¡ç†ç³»ç»Ÿçš„æ”¯ä»˜è®¢å•åˆ›å»º
- å…¶ä»–æ”¯ä»˜è®¢å•åˆ›å»ºæµç¨‹

---

## ğŸ” ç›¸å…³ä»£ç ä½ç½®

### ä¸»è¦ä¿®å¤æ–‡ä»¶
- `packages/backend/src/services/hetong_guanli/hetong_sign_service.py` (ç¬¬296-311è¡Œ)

### ç›¸å…³æ¨¡å‹å®šä¹‰
- `packages/backend/src/models/zhifu_guanli/zhifu_dingdan.py` (ZhifuDingdanæ¨¡å‹)

### ç›¸å…³APIç«¯ç‚¹
- `packages/backend/src/api/api_v1/endpoints/hetong_guanli/hetong_sign.py` (ç¬¬91-105è¡Œ)

---

## âœ… æ€»ç»“

### é—®é¢˜
åˆåŒç­¾ç½²åå‘èµ·æ”¯ä»˜æ—¶å‡ºç°500é”™è¯¯,é”™è¯¯ä¿¡æ¯ä¸º `'shiji_zhifu_jine' is an invalid keyword argument`

### åŸå› 
1. å­—æ®µåæ‹¼å†™é”™è¯¯: `shiji_zhifu_jine` â†’ `shifu_jine`
2. ç¼ºå°‘å¿…å¡«å­—æ®µ: `hetong_id`, `kehu_id`, `dingdan_jine`, `zhifu_leixing`, `chuangjian_shijian`
3. çŠ¶æ€å€¼ä¸è§„èŒƒ: `daifukuan` â†’ `pending`

### è§£å†³æ–¹æ¡ˆ
1. ä¿®æ­£å­—æ®µåä¸º `shifu_jine`
2. æ·»åŠ æ‰€æœ‰å¿…å¡«å­—æ®µ
3. ä½¿ç”¨æ ‡å‡†çŠ¶æ€å€¼ `pending`
4. é‡å¯åç«¯æœåŠ¡åº”ç”¨æ›´æ”¹

### éªŒè¯
- âœ… åç«¯æœåŠ¡å·²é‡å¯
- â³ ç­‰å¾…å‰ç«¯æµ‹è¯•éªŒè¯

---

## ğŸš€ ä¸‹ä¸€æ­¥

**è¯·é‡æ–°æµ‹è¯•æ”¯ä»˜æµç¨‹**:
1. åˆ·æ–°åˆåŒç­¾ç½²é¡µé¢
2. é‡æ–°ç­¾ç½²åˆåŒ
3. é€‰æ‹©æ”¯ä»˜å®æ”¯ä»˜
4. éªŒè¯æ˜¯å¦æˆåŠŸç”Ÿæˆæ”¯ä»˜äºŒç»´ç 

**å¦‚æœä»æœ‰é—®é¢˜,è¯·æŸ¥çœ‹åç«¯æ—¥å¿—**:
```bash
tail -f /tmp/backend_8000.log
```

