# 系统架构设计文档 (ARCHITECTURE.md)

> ⚠️ **本文件由 MCP (Model Context Protocol) v2.0 管理**
>
> **设计状态**: 🔒 已冻结 (FROZEN)
> **冻结时间**: 2025-12-19T16:00:00Z
> **允许操作**: ✅ READ ONLY
> **禁止操作**: ❌ WRITE, APPEND, DELETE, RENAME

---

## 📋 目录

1. [系统概述](#系统概述)
2. [技术栈](#技术栈)
3. [分层架构](#分层架构)
4. [目录结构](#目录结构)
5. [业务模块](#业务模块)
6. [依赖规则](#依赖规则)

---

## 🎯 系统概述

**系统名称**: 企业文件管理系统 (企业管理中台)

**系统定位**: 面向中小企业的一站式业务管理平台，涵盖客户管理、销售管理、合同管理、财务管理、办公审批等核心业务。

**核心价值**:
- 📊 客户全生命周期管理（线索 → 客户 → 合同 → 服务）
- 💰 财务流程自动化（报价 → 合同 → 支付 → 开票）
- ✅ 审批流程标准化（请假、报销、采购、付款）
- 🔐 权限管理精细化（用户 → 角色 → 权限）

---

## 🛠️ 技术栈

### 后端 (Backend)

| 组件 | 技术 | 版本 |
|------|------|------|
| 框架 | FastAPI | 0.100+ |
| ORM | SQLAlchemy | 2.0+ |
| 数据库 | PostgreSQL | 14+ |
| 缓存 | Redis | 6+ |
| 认证 | JWT | - |
| 日志 | Python Logging | - |
| 监控 | Sentry | - |

### 前端 (Frontend)

| 组件 | 技术 | 版本 |
|------|------|------|
| 框架 | Vue 3 | 3.3+ |
| 构建 | Vite | 4+ |
| 状态管理 | Pinia | 2+ |
| 路由 | Vue Router | 4+ |
| UI 组件 | Element Plus | 2+ |
| HTTP | Axios | 1+ |
| 语言 | TypeScript | 5+ |

### 移动端 (Mobile)

| 组件 | 技术 | 版本 |
|------|------|------|
| 框架 | uni-app | 3+ |
| UI 组件 | uView | 2+ |

---

## 🏗️ 分层架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端应用层                                │
│  (Vue 3 SPA / uni-app 移动端)                                   │
├─────────────────────────────────────────────────────────────────┤
│                        API 网关层                                │
│  (Nginx 反向代理 / 负载均衡)                                     │
├─────────────────────────────────────────────────────────────────┤
│                     ┌─────────────────┐                         │
│                     │   API Layer     │  ← HTTP 请求处理        │
│                     │   /api/api_v1/  │  ← 路由、验证、权限      │
│                     ├─────────────────┤                         │
│   后端应用          │  Service Layer  │  ← 业务逻辑编排         │
│   (FastAPI)         │  /services/     │  ← 事务管理、流程控制    │
│                     ├─────────────────┤                         │
│                     │  Domain Layer   │  ← 领域模型             │
│                     │  /models/       │  ← 实体、值对象、规则    │
│                     └─────────────────┘                         │
├─────────────────────────────────────────────────────────────────┤
│                        数据层                                    │
│  (PostgreSQL + Redis)                                           │
└─────────────────────────────────────────────────────────────────┘
```

### 层级职责

| 层 | 路径 | 职责 | 可调用 |
|---|------|------|--------|
| **API** | `src/api/api_v1/endpoints/` | HTTP 处理、参数验证、权限检查 | Service |
| **Service** | `src/services/` | 业务逻辑、事务管理、流程编排 | Domain |
| **Domain** | `src/models/` | 实体定义、数据模型、业务规则 | 无 |
| **Schema** | `src/schemas/` | DTO、请求/响应模型 | 无 |
| **Core** | `src/core/` | 基础设施、配置、中间件 | 无 |

---

## 📁 目录结构

### 后端目录

```
packages/backend/src/
├── api/                    # API 层
│   └── api_v1/
│       ├── api.py          # 路由聚合
│       └── endpoints/      # 端点目录（按模块分组）
├── services/               # Service 层（按模块分组）
├── models/                 # Domain 层（按模块分组）
├── schemas/                # Schema 层（按模块分组）
├── core/                   # 核心基础设施
│   ├── config.py           # 配置管理
│   ├── database.py         # 数据库连接
│   ├── security/           # 安全相关
│   ├── middleware.py       # 中间件
│   └── exceptions.py       # 异常定义
├── scripts/                # 初始化脚本
├── utils/                  # 工具函数
└── main.py                 # 应用入口
```

### 前端目录

```
packages/frontend/src/
├── api/                    # API 调用模块
│   └── modules/            # 按模块分组的 API
├── views/                  # 页面视图
├── components/             # 公共组件
├── composables/            # 组合式函数
├── stores/                 # Pinia 状态管理
├── router/                 # 路由配置
├── types/                  # TypeScript 类型
├── utils/                  # 工具函数
└── main.ts                 # 应用入口
```

---

## 📦 业务模块

### 模块列表

| 模块标识 | 中文名称 | API 前缀 | 职责 |
|----------|----------|----------|------|
| `yonghu_guanli` | 用户管理 | `/user-management/` | 用户、角色、权限 |
| `kehu_guanli` | 客户管理 | `/customer-management/` | 客户信息、服务记录 |
| `xiansuo_guanli` | 线索管理 | `/leads/` | 线索、跟进、报价 |
| `hetong_guanli` | 合同管理 | `/contract/` | 合同、模板、签署 |
| `zhifu_guanli` | 支付管理 | `/payment/` | 支付、回款、退款 |
| `caiwu_guanli` | 财务管理 | `/finance/` | 成本、发票、设置 |
| `shenhe_guanli` | 审核管理 | `/audit/` | 审核规则、流程、记录 |
| `bangong_guanli` | 办公管理 | `/office/` | 请假、报销、采购 |
| `chanpin_guanli` | 产品管理 | `/product/` | 产品、分类、步骤 |
| `fuwu_guanli` | 服务管理 | `/service-order/` | 工单管理 |
| `heguishixiang_guanli` | 合规事项 | `/compliance/` | 合规模板、提醒 |
| `xitong_guanli` | 系统管理 | `/system/` | 系统配置 |

### 模块依赖关系

```
┌─────────────────────────────────────────────────────────────────┐
│                      xitong_guanli (系统管理)                    │
└─────────────────────────────────────────────────────────────────┘
                                ↑
┌─────────────────────────────────────────────────────────────────┐
│                      yonghu_guanli (用户管理)                    │
│                    (用户、角色、权限、认证)                       │
└─────────────────────────────────────────────────────────────────┘
                                ↑
        ┌───────────────────────┼───────────────────────┐
        ↓                       ↓                       ↓
┌───────────────┐       ┌───────────────┐       ┌───────────────┐
│  kehu_guanli  │       │ xiansuo_guanli│       │ bangong_guanli│
│  (客户管理)   │       │  (线索管理)   │       │  (办公管理)   │
└───────────────┘       └───────────────┘       └───────────────┘
        ↓                       ↓                       ↓
        └───────────────┬───────┘                       │
                        ↓                               ↓
                ┌───────────────┐               ┌───────────────┐
                │ hetong_guanli │               │ shenhe_guanli │
                │  (合同管理)   │←──────────────│  (审核管理)   │
                └───────────────┘               └───────────────┘
                        ↓
                ┌───────────────┐
                │ zhifu_guanli  │
                │  (支付管理)   │
                └───────────────┘
                        ↓
                ┌───────────────┐
                │ caiwu_guanli  │
                │  (财务管理)   │
                └───────────────┘
```

---

## 🔒 依赖规则

### 1. 分层依赖 (严格遵守)

```
API Layer
    ↓ 只能调用
Service Layer
    ↓ 只能调用
Domain Layer (不能调用任何层)
```

**禁止的调用**:
- ❌ API → Domain (跳过 Service)
- ❌ Domain → Service (反向依赖)
- ❌ Domain → API (反向依赖)
- ❌ Service → API (反向依赖)

### 2. 模块间依赖

**允许的模块依赖**:
- ✅ 业务模块 → yonghu_guanli (权限检查)
- ✅ 业务模块 → xitong_guanli (系统配置)
- ✅ hetong_guanli → kehu_guanli (客户信息)
- ✅ zhifu_guanli → hetong_guanli (合同信息)
- ✅ shenhe_guanli → 任意业务模块 (审核流程)

**禁止的模块依赖**:
- ❌ 循环依赖
- ❌ 跨越两层以上的依赖

### 3. 数据库访问

- ✅ 只有 Domain 层（models）直接操作数据库
- ✅ Service 层通过 Domain 层操作数据
- ❌ API 层不能直接操作数据库

---

## 🔐 DESIGN_FREEZE

```yaml
design_locked: true
allowed_changes: "code_only"
forbidden: "structural_change"
frozen_at: "2025-12-19T16:00:00Z"
```

**冻结后禁止的操作**:
- ❌ 添加新的业务模块
- ❌ 修改分层结构
- ❌ 修改模块依赖关系
- ❌ 修改技术栈选型
- ❌ 修改目录结构约定

**冻结后允许的操作**:
- ✅ 在现有模块内添加功能
- ✅ 修复 bug
- ✅ 性能优化（不改变架构）

