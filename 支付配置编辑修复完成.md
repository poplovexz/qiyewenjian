# æ”¯ä»˜é…ç½®ç¼–è¾‘æ•°æ®ä¸¢å¤±é—®é¢˜ - æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

## ğŸ› é—®é¢˜æ ¹æœ¬åŸå› 

### é—®é¢˜1: `zhifubao_wangguan` å­—æ®µç¼ºå¤±
- æ•°æ®åº“ä¸­æœ‰è¯¥å­—æ®µ
- åç«¯å“åº”æ¨¡å‹ä¸­ç¼ºå°‘è¯¥å­—æ®µ
- å¯¼è‡´ç¼–è¾‘æ—¶æ— æ³•å›æ˜¾

### é—®é¢˜2: æ•æ„Ÿå­—æ®µè„±æ•å¯¼è‡´ç¼–è¾‘æ—¶æ•°æ®ä¸¢å¤±
**æ ¸å¿ƒé—®é¢˜**:
1. **åˆ—è¡¨/æŸ¥çœ‹API** è¿”å›è„±æ•å­—æ®µ:
   - `zhifubao_shanghu_siyao_masked` (è„±æ•æ˜¾ç¤º: `GqUN****0A==`)
   - `zhifubao_zhifubao_gongyao_masked` (è„±æ•æ˜¾ç¤º: `O2dT****JfI=`)

2. **å‰ç«¯è¡¨å•** ç»‘å®šçš„æ˜¯åŸå§‹å­—æ®µ:
   - `zhifubao_shanghu_siyao`
   - `zhifubao_zhifubao_gongyao`

3. **ç¼–è¾‘æ—¶** ä½¿ç”¨ `Object.assign(formData, row)`:
   - `row` ä¸­åªæœ‰ `_masked` å­—æ®µ
   - è¡¨å•éœ€è¦çš„åŸå§‹å­—æ®µä¸ºç©º
   - å¯¼è‡´è¾“å…¥æ¡†æ˜¾ç¤ºä¸ºç©º

---

## âœ… æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ: åˆ›å»ºç¼–è¾‘ä¸“ç”¨APIç«¯ç‚¹

**æ ¸å¿ƒæ€è·¯**: 
- åˆ—è¡¨/æŸ¥çœ‹APIç»§ç»­è¿”å›è„±æ•æ•°æ®(å®‰å…¨)
- æ–°å¢ç¼–è¾‘ä¸“ç”¨APIè¿”å›è§£å¯†åçš„å®Œæ•´æ•°æ®(ä»…é™æœ‰æƒé™çš„ç”¨æˆ·)

### å®æ–½æ­¥éª¤

#### 1. åç«¯APIç«¯ç‚¹ âœ…

**æ–‡ä»¶**: `packages/backend/src/api/api_v1/endpoints/zhifu_guanli/zhifu_peizhi.py`

æ–°å¢ç«¯ç‚¹:
```python
@router.get("/{peizhi_id}/edit", response_model=ZhifuPeizhiDetail, summary="è·å–æ”¯ä»˜é…ç½®ç¼–è¾‘æ•°æ®")
async def get_zhifu_peizhi_for_edit(
    peizhi_id: str,
    db: Session = Depends(get_db),
    current_user: Yonghu = Depends(require_permission("payment_config:update"))
):
    """
    æ ¹æ®IDè·å–æ”¯ä»˜é…ç½®ç¼–è¾‘æ•°æ®ï¼ˆåŒ…å«è§£å¯†åçš„æ•æ„Ÿä¿¡æ¯ï¼Œç”¨äºç¼–è¾‘è¡¨å•ï¼‰
    """
    service = ZhifuPeizhiService(db)
    return service.get_zhifu_peizhi_detail(peizhi_id)
```

**ç‰¹ç‚¹**:
- URL: `/api/v1/payment-configs/{id}/edit`
- æƒé™è¦æ±‚: `payment_config:update`
- è¿”å›ç±»å‹: `ZhifuPeizhiDetail` (åŒ…å«è§£å¯†åçš„æ•æ„Ÿä¿¡æ¯)

#### 2. åç«¯æœåŠ¡å±‚ä¿®å¤ âœ…

**æ–‡ä»¶**: `packages/backend/src/services/zhifu_guanli/zhifu_peizhi_service.py`

ä¿®å¤ `_to_response()` å’Œ `_to_detail()` æ–¹æ³•,æ·»åŠ :
```python
# æ”¯ä»˜å®ç½‘å…³ä¸éœ€è¦åŠ å¯†ï¼Œç›´æ¥è¿”å›
if peizhi.zhifubao_wangguan:
    peizhi_dict['zhifubao_wangguan'] = peizhi.zhifubao_wangguan

# é“¶è¡Œæ±‡æ¬¾é…ç½®
if peizhi.yinhang_mingcheng:
    peizhi_dict['yinhang_mingcheng'] = peizhi.yinhang_mingcheng
# ... å…¶ä»–é“¶è¡Œå­—æ®µ
```

#### 3. åç«¯Schemaæ›´æ–° âœ…

**æ–‡ä»¶**: `packages/backend/src/schemas/zhifu_guanli/zhifu_peizhi_schemas.py`

åœ¨ `ZhifuPeizhiResponse` å’Œ `ZhifuPeizhiDetail` ä¸­æ·»åŠ :
```python
zhifubao_wangguan: Optional[str] = None
```

#### 4. å‰ç«¯APIè°ƒç”¨ âœ…

**æ–‡ä»¶**: `packages/frontend/src/api/modules/payment-config.ts`

æ–°å¢æ¥å£å®šä¹‰:
```typescript
export interface ZhifuPeizhiDetail {
  // ... åŒ…å«è§£å¯†åçš„æ•æ„Ÿä¿¡æ¯
  zhifubao_appid?: string
  zhifubao_wangguan?: string
  zhifubao_shanghu_siyao?: string  // è§£å¯†åçš„æ˜æ–‡
  zhifubao_zhifubao_gongyao?: string  // è§£å¯†åçš„æ˜æ–‡
  // ...
}
```

æ–°å¢APIå‡½æ•°:
```typescript
export function getZhifuPeizhiForEdit(id: string) {
  return request<ZhifuPeizhiDetail>({
    url: `/payment-configs/${id}/edit`,
    method: 'get'
  })
}
```

#### 5. å‰ç«¯ç»„ä»¶ä¿®å¤ âœ…

**æ–‡ä»¶**: `packages/frontend/src/views/payment/PaymentConfigManage.vue`

ä¿®æ”¹ç¼–è¾‘å‡½æ•°:
```typescript
const handleEdit = async (row: ZhifuPeizhiResponse) => {
  try {
    isEdit.value = true
    dialogTitle.value = 'ç¼–è¾‘æ”¯ä»˜é…ç½®'
    
    // è°ƒç”¨ç¼–è¾‘ä¸“ç”¨APIè·å–å®Œæ•´æ•°æ®ï¼ˆåŒ…æ‹¬è§£å¯†åçš„æ•æ„Ÿä¿¡æ¯ï¼‰
    const { data } = await getZhifuPeizhiForEdit(row.id)
    Object.assign(formData, data)
    
    dialogVisible.value = true
  } catch (error: any) {
    ElMessage.error(error.message || 'è·å–é…ç½®è¯¦æƒ…å¤±è´¥')
  }
}
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### åç«¯APIæµ‹è¯• âœ…

```bash
æµ‹è¯•é…ç½®ID: 3eb0de14-9233-4377-9a11-d52e1a82b482
é…ç½®åç§°: æ”¯ä»˜å®-æµ‹è¯•ç¯å¢ƒ
æ”¯ä»˜å®APPID: 9021000157698401
æ”¯ä»˜å®ç½‘å…³: https://openapi-sandbox.dl.alipaydev.com/gateway.do
å•†æˆ·ç§é’¥é•¿åº¦: 1624
æ”¯ä»˜å®å…¬é’¥é•¿åº¦: 392
å›è°ƒURL: http://localhost:8000/api/v1/public/payment-callback/zhifubao/notify

âœ… ç¼–è¾‘APIæµ‹è¯•æˆåŠŸ!æ‰€æœ‰å­—æ®µéƒ½å·²è§£å¯†å¹¶è¿”å›!
```

### å‰ç«¯æµ‹è¯•æ­¥éª¤

1. **åˆ·æ–°é¡µé¢**: `http://localhost:5174/finance/payment-configs`
2. **ç‚¹å‡»ç¼–è¾‘**: ç‚¹å‡»ç°æœ‰é…ç½®çš„"ç¼–è¾‘"æŒ‰é’®
3. **éªŒè¯æ•°æ®å›æ˜¾**:
   - âœ… é…ç½®åç§°
   - âœ… æ”¯ä»˜å®APPID
   - âœ… æ”¯ä»˜å®ç½‘å…³ (ä¹‹å‰ä¼šä¸¢å¤±)
   - âœ… å•†æˆ·ç§é’¥ (ä¹‹å‰æ˜¾ç¤ºä¸ºç©º,ç°åœ¨åº”è¯¥æ˜¾ç¤ºå®Œæ•´å†…å®¹)
   - âœ… æ”¯ä»˜å®å…¬é’¥ (ä¹‹å‰æ˜¾ç¤ºä¸ºç©º,ç°åœ¨åº”è¯¥æ˜¾ç¤ºå®Œæ•´å†…å®¹)
   - âœ… å›è°ƒé€šçŸ¥URL
   - âœ… å¤‡æ³¨

---

## ğŸ”’ å®‰å…¨æ€§è€ƒè™‘

### æƒé™æ§åˆ¶
- ç¼–è¾‘APIéœ€è¦ `payment_config:update` æƒé™
- åªæœ‰æˆæƒç”¨æˆ·æ‰èƒ½è·å–è§£å¯†åçš„æ•æ„Ÿä¿¡æ¯

### æ•°æ®è„±æ•
- åˆ—è¡¨/æŸ¥çœ‹APIç»§ç»­è¿”å›è„±æ•æ•°æ®
- æ™®é€šæŸ¥çœ‹ä¸ä¼šæš´éœ²æ•æ„Ÿä¿¡æ¯
- åªæœ‰ç¼–è¾‘æ—¶æ‰è·å–å®Œæ•´æ•°æ®

---

## ğŸ“Š ä¿®å¤å½±å“èŒƒå›´

### å—ç›ŠåŠŸèƒ½
1. âœ… æ”¯ä»˜å®é…ç½®ç¼–è¾‘ - æ‰€æœ‰å­—æ®µæ­£ç¡®å›æ˜¾
2. âœ… å¾®ä¿¡æ”¯ä»˜é…ç½®ç¼–è¾‘ - æ‰€æœ‰å­—æ®µæ­£ç¡®å›æ˜¾
3. âœ… é“¶è¡Œæ±‡æ¬¾é…ç½®ç¼–è¾‘ - æ‰€æœ‰å­—æ®µæ­£ç¡®å›æ˜¾

### ä¸å—å½±å“
- é…ç½®åˆ—è¡¨æŸ¥çœ‹ (ç»§ç»­è„±æ•æ˜¾ç¤º)
- é…ç½®è¯¦æƒ…æŸ¥çœ‹ (ç»§ç»­è„±æ•æ˜¾ç¤º)
- é…ç½®åˆ›å»ºåŠŸèƒ½
- é…ç½®åˆ é™¤åŠŸèƒ½

---

## âœ… æ€»ç»“

### é—®é¢˜
ç¼–è¾‘æ”¯ä»˜é…ç½®æ—¶,æ•æ„Ÿå­—æ®µ(å•†æˆ·ç§é’¥ã€æ”¯ä»˜å®å…¬é’¥)æ˜¾ç¤ºä¸ºç©º

### åŸå› 
1. åˆ—è¡¨APIè¿”å›è„±æ•å­—æ®µ (`_masked`)
2. å‰ç«¯è¡¨å•ç»‘å®šåŸå§‹å­—æ®µ
3. å­—æ®µåä¸åŒ¹é…å¯¼è‡´æ•°æ®ä¸¢å¤±

### è§£å†³æ–¹æ¡ˆ
1. æ–°å¢ç¼–è¾‘ä¸“ç”¨APIç«¯ç‚¹ `/payment-configs/{id}/edit`
2. è¿”å›è§£å¯†åçš„å®Œæ•´æ•°æ®
3. å‰ç«¯ç¼–è¾‘æ—¶è°ƒç”¨æ–°APIè·å–æ•°æ®
4. æ·»åŠ æƒé™æ§åˆ¶ç¡®ä¿å®‰å…¨

### éªŒè¯
- âœ… åç«¯APIæµ‹è¯•é€šè¿‡
- â³ ç­‰å¾…å‰ç«¯æµ‹è¯•éªŒè¯

---

## ğŸš€ ä¸‹ä¸€æ­¥

**è¯·åˆ·æ–°é¡µé¢å¹¶æµ‹è¯•**:
1. è®¿é—® `http://localhost:5174/finance/payment-configs`
2. ç‚¹å‡»ç°æœ‰é…ç½®çš„"ç¼–è¾‘"æŒ‰é’®
3. æ£€æŸ¥æ‰€æœ‰å­—æ®µæ˜¯å¦æ­£ç¡®æ˜¾ç¤º,ç‰¹åˆ«æ˜¯:
   - æ”¯ä»˜å®ç½‘å…³
   - å•†æˆ·ç§é’¥
   - æ”¯ä»˜å®å…¬é’¥

**å¦‚æœæ‰€æœ‰å­—æ®µéƒ½æ­£ç¡®æ˜¾ç¤º,é—®é¢˜å°±å½»åº•è§£å†³äº†!** ğŸ‰

